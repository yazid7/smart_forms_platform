<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PDF Toolkit — One Page App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{--accent1:#0d6efd;--card-radius:12px}
    body{background:#f5f7fb;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    .navbar-grad{background:linear-gradient(90deg,var(--accent1),#6f42c1)}
    .navbar-brand{color:#fff;font-weight:700}
    .nav-tabs .nav-link{border:0}
    .tool-card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
    .dropzone{border:2px dashed #e7edf6;border-radius:12px;padding:28px;text-align:center;background:#fff;cursor:pointer}
    .dropzone.dragover{background:#eef3ff}
    .pdf-viewer{height:520px;overflow:auto;background:#fff;border-radius:10px;padding:10px;border:1px solid #e9eef8}
    .thumb-canvas{border-radius:6px;box-shadow:0 2px 6px rgba(16,24,40,0.06)}
    .page-thumb{display:inline-block;margin:8px;position:relative}
    .page-controls{position:absolute;top:6px;right:6px;display:flex;gap:6px}
    .sig-canvas{border:1px solid #ddd;border-radius:8px;background:#fff}
    .small-muted{font-size:.86rem;color:#6c757d}
    footer.small{opacity:.7;margin-top:20px}
    .theme-dark{background:#0b1220;color:#e6eef8}
    .theme-dark .tool-card{background:#0f1724}
    .theme-dark .dropzone{background:#0f1724;border-color:#1f2a44;color:#cfe3ff}
    .theme-dark .pdf-viewer{background:#0b1220;border-color:#1f2a44}
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-grad py-3 mb-4">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-3" href="#">
        <i class="bi bi-file-earmark-pdf-fill fs-2" style="color:#fff"></i>
        <div>
          PDF Toolkit
          <div style="font-size:.78rem;opacity:.9">Convert · Merge · Split · Edit · Sign</div>
        </div>
      </a>

      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="themeToggle" class="btn btn-light btn-sm"><i class="bi bi-moon"></i></button>
      </div>
    </div>
  </nav>

  <main class="container">
    <!-- Hero Upload -->
    <div class="row mb-4">
      <div class="col-12">
        <div id="globalDrop" class="dropzone">
          <div class="d-flex align-items-center justify-content-center flex-column">
            <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
            <div class="mt-2 fw-semibold">Drag & drop files here or <span class="text-primary" id="clickToOpen">click to upload</span></div>
            <div class="small-muted mt-1">Supports PDF, images (jpg/png), and text. Office files need server-side conversion.</div>
            <input id="globalFileInput" type="file" multiple accept=".pdf,image/*,text/plain" style="display:none" />
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="row">
      <div class="col-lg-8">
        <div class="tool-card">
          <ul class="nav nav-tabs" id="toolsTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-convert">Convert</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-merge">Merge</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-split">Split</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-organize">Organize</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-watermark">Watermark</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sign">Sign</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-compress">Compress</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-protect">Protect</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rotate">Rotate</button></li>
          </ul>

          <div class="tab-content mt-3">
            <!-- Convert -->
            <div class="tab-pane fade show active" id="tab-convert">
              <div class="row g-3">
                <div class="col-md-8">
                  <h5>Convert files → PDF</h5>
                  <div class="small-muted">Images (.jpg/.png), text (.txt) and PDFs can be combined into a single PDF.</div>
                  <div class="mt-3">
                    <input id="convertFiles" type="file" multiple accept="image/*,text/plain,application/pdf" />
                  </div>
                  <div class="mt-3 d-flex gap-2">
                    <button id="btnConvert" class="btn btn-primary"><i class="bi bi-file-earmark-pdf-fill me-1"></i> Convert to PDF</button>
                    <input id="outConvertName" class="form-control w-50" placeholder="result.pdf" />
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label small-muted">Image quality</label>
                  <input type="range" id="convertQuality" min="0.3" max="1" step="0.05" value="0.9" />
                  <div class="mt-3 small-muted">Page size</div>
                  <select id="convertPageSize" class="form-select">
                    <option value="auto">Auto (image size)</option>
                    <option value="A4">A4</option>
                    <option value="Letter">Letter</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Merge -->
            <div class="tab-pane fade" id="tab-merge">
              <h5>Merge PDFs</h5>
              <div class="small-muted">Add multiple PDFs, reorder them, then merge.</div>
              <div class="mt-3 d-flex gap-2">
                <input id="mergeFilesInput" type="file" multiple accept="application/pdf" />
                <button id="btnMerge" class="btn btn-success"><i class="bi bi-files me-1"></i> Merge</button>
                <button id="btnClearMerge" class="btn btn-outline-secondary">Clear</button>
              </div>
              <div id="mergeList" class="list-group mt-3"></div>
              <div class="small-muted mt-2">Drag list items to reorder before merging.</div>
            </div>

            <!-- Split -->
            <div class="tab-pane fade" id="tab-split">
              <h5>Split / Extract pages</h5>
              <div class="small-muted">Load a PDF, choose pages or ranges to extract.</div>
              <div class="mt-3 d-flex gap-2">
                <input id="splitInput" type="file" accept="application/pdf" />
                <input id="splitRanges" class="form-control w-50" placeholder="e.g. 1,3-5,7" />
                <button id="btnSplit" class="btn btn-warning"><i class="bi bi-scissors"></i> Extract</button>
                <button id="btnSplitAll" class="btn btn-outline-secondary">Split All</button>
              </div>
              <div id="splitPreview" class="mt-3"></div>
            </div>

            <!-- Organize -->
            <div class="tab-pane fade" id="tab-organize">
              <h5>Organize pages</h5>
              <div class="small-muted">Load a PDF to view thumbnails. Drag to reorder, delete pages, then export.</div>
              <div class="mt-3 d-flex gap-2">
                <input id="organizeInput" type="file" accept="application/pdf" />
                <button id="btnExportOrganized" class="btn btn-primary">Export organized PDF</button>
                <button id="btnClearOrganize" class="btn btn-outline-secondary">Clear</button>
              </div>
              <div id="pagesContainer" class="mt-3"></div>
            </div>

            <!-- Watermark -->
            <div class="tab-pane fade" id="tab-watermark">
              <h5>Watermark & Page numbers</h5>
              <div class="small-muted">Add text watermark and page numbers.</div>
              <div class="row mt-3 g-3">
                <div class="col-md-7">
                  <input id="watermarkFile" type="file" accept="application/pdf" />
                </div>
                <div class="col-md-5">
                  <input id="wmText" class="form-control" placeholder="Confidential" />
                  <div class="d-flex gap-2 mt-2">
                    <input id="wmOpacity" type="range" min="0.05" max="0.9" step="0.05" value="0.12" />
                    <input id="wmSize" type="number" class="form-control w-25" value="48" />
                  </div>
                  <select id="wmPosition" class="form-select mt-2 w-50">
                    <option value="diagonal">Diagonal</option>
                    <option value="center">Center</option>
                    <option value="top-left">Top-left</option>
                  </select>
                </div>
              </div>
              <div class="mt-3 d-flex gap-2">
                <button id="btnApplyWatermark" class="btn btn-info">Apply watermark</button>
                <button id="btnAddPageNumbers" class="btn btn-outline-secondary">Add page numbers</button>
              </div>
            </div>

            <!-- Sign -->
            <div class="tab-pane fade" id="tab-sign">
              <h5>Sign PDF</h5>
              <div class="small-muted">Draw signature and place it on a selected page in Organize.</div>
              <div class="row mt-3">
                <div class="col-md-7">
                  <canvas id="sigPad" class="sig-canvas" width="640" height="120"></canvas>
                  <div class="mt-2 d-flex gap-2">
                    <button id="sigClear" class="btn btn-outline-secondary">Clear</button>
                    <button id="sigSave" class="btn btn-primary">Save signature</button>
                  </div>
                </div>
                <div class="col-md-5">
                  <div id="savedSignatures" class="d-flex flex-wrap gap-2"></div>
                  <div class="small-muted mt-2">Select a page thumbnail in Organize and click "Place signature" there, or use 'Place on selected'.</div>
                  <button id="btnPlaceSaved" class="btn btn-success mt-2">Place on selected page</button>
                </div>
              </div>
            </div>

            <!-- Compress -->
            <div class="tab-pane fade" id="tab-compress">
              <h5>Compress PDF</h5>
              <div class="small-muted">Lossy compression: converts pages to images at lower quality (searchability may be lost).</div>
              <div class="mt-3 d-flex gap-2">
                <input id="compressInput" type="file" accept="application/pdf" />
                <select id="compressQuality" class="form-select w-25">
                  <option value="0.9">High</option>
                  <option value="0.7" selected>Medium</option>
                  <option value="0.45">Low</option>
                </select>
                <button id="btnCompress" class="btn btn-primary">Compress</button>
              </div>
            </div>

            <!-- Protect -->
            <div class="tab-pane fade" id="tab-protect">
              <h5>Protect (AES file encryption)</h5>
              <div class="small-muted">This encrypts the whole file into an .enc blob (strong for storage/sharing). It is not PDF-standard open-password protection.</div>
              <div class="mt-3 d-flex gap-2">
                <input id="protectInput" type="file" />
                <input id="protectPass" class="form-control w-50" type="password" placeholder="password" />
                <button id="btnEncrypt" class="btn btn-dark">Encrypt</button>
                <button id="btnDecrypt" class="btn btn-outline-secondary">Decrypt</button>
              </div>
            </div>

            <!-- Rotate -->
            <div class="tab-pane fade" id="tab-rotate">
              <h5>Rotate PDF</h5>
              <div class="small-muted">Rotate entire document by an angle.</div>
              <div class="mt-3 d-flex gap-2">
                <input id="rotateInput" type="file" accept="application/pdf" />
                <select id="rotateAngle" class="form-select w-25">
                  <option value="90">90°</option>
                  <option value="180">180°</option>
                  <option value="270">270°</option>
                </select>
                <button id="btnRotate" class="btn btn-success">Rotate</button>
              </div>
            </div>

          </div> <!-- tab-content -->
        </div> <!-- tool-card -->
      </div> <!-- col -->

      <!-- Right column: viewer / info -->
      <div class="col-lg-4">
        <div class="tool-card mb-3">
          <h6>PDF Viewer</h6>
          <div id="pdfViewer" class="pdf-viewer mt-2"></div>
          <div class="mt-3 d-flex gap-2">
            <button id="btnDownloadCurrent" class="btn btn-primary btn-sm">Download current</button>
            <button id="btnClearViewer" class="btn btn-outline-secondary btn-sm">Clear</button>
          </div>
        </div>

        <div class="tool-card mb-3">
          <h6>Status & Logs</h6>
          <div id="statusInfo" class="small-muted">Ready</div>
          <div id="logBox" style="height:180px;overflow:auto;margin-top:10px;font-size:.9rem"></div>
        </div>
      </div>
    </div>

    <footer class="small text-center mt-4">Client-side: pdf.js | pdf-lib | SortableJS | FileSaver | CryptoJS. For PDF open-password protection or Office→PDF, ask for a small server helper script.</footer>
  </main>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Setup & state ---
    const { PDFDocument, StandardFonts, rgb, degrees } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    let currentPdfBytes = null;
    let lastSavedBytes = null;
    let organizeSourceBytes = null;
    let organizePdfDoc = null;
    let savedSignatures = []; // dataURLs
    const logBox = document.getElementById('logBox');
    function log(msg){ const d=document.createElement('div'); d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; logBox.prepend(d); }
    function setStatus(t){ document.getElementById('statusInfo').textContent = t; log(t); }

    // --- Helpers ---
    function fileToArrayBuffer(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(file); }); }
    function blobToArrayBuffer(blob){ return new Response(blob).arrayBuffer(); }
    function saveBytes(bytes, name){ const blob = new Blob([bytes], {type:'application/pdf'}); saveAs(blob, name); }
    function saveBlob(blob, name){ saveAs(blob, name); }

    // --- Global drop ---
    const globalDrop = document.getElementById('globalDrop');
    const globalFileInput = document.getElementById('globalFileInput');
    document.getElementById('clickToOpen').addEventListener('click', ()=> globalFileInput.click());
    globalDrop.addEventListener('click', ()=> globalFileInput.click());
    globalDrop.addEventListener('dragover', (e)=>{ e.preventDefault(); globalDrop.classList.add('dragover'); });
    globalDrop.addEventListener('dragleave', ()=> globalDrop.classList.remove('dragover'));
    globalDrop.addEventListener('drop', async (e)=>{ e.preventDefault(); globalDrop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    globalFileInput.addEventListener('change', ()=> handleFiles(globalFileInput.files));

    async function handleFiles(fileList){
      const files = Array.from(fileList);
      if(!files.length) return;
      // If PDF(s) present, load first into viewer and Organize
      const pdfFile = files.find(f=>f.type==='application/pdf');
      if(pdfFile){
        const bytes = await fileToArrayBuffer(pdfFile);
        currentPdfBytes = bytes; lastSavedBytes = bytes;
        renderPdfInViewer(bytes);
        updateViewerDownload(bytes, pdfFile.name);
        // also populate organize area
        organizeSourceBytes = bytes;
        organizePdfDoc = await PDFDocument.load(bytes);
        await buildPageThumbnails(bytes);
        setStatus(`Loaded ${pdfFile.name}`);
        return;
      }
      // else if images/text convert automatically
      const imgOrTxt = files;
      document.getElementById('convertFiles').files = new DataTransfer().files; // reset
      // Fill convert input: cannot set FileList easily; instead process directly
      // We'll call convert routine directly
      await convertFilesToPdf(files);
    }

    // --- PDF.js Viewer ---
    const pdfViewer = document.getElementById('pdfViewer');
    async function renderPdfInViewer(bytes){
      pdfViewer.innerHTML = '';
      if(!bytes) return;
      const uint8 = new Uint8Array(bytes);
      const pdf = await pdfjsLib.getDocument({data:uint8}).promise;
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({scale:1.2});
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        canvas.className = 'thumb-canvas mb-3';
        const ctx = canvas.getContext('2d');
        await page.render({canvasContext:ctx,viewport}).promise;
        const caption = document.createElement('div');
        caption.className = 'small-muted mb-2';
        caption.textContent = `Page ${p} — ${Math.round(viewport.width)}×${Math.round(viewport.height)}`;
        pdfViewer.appendChild(caption);
        pdfViewer.appendChild(canvas);
      }
      setStatus(`Rendered ${pdf.numPages} page(s) in viewer`);
    }

    function updateViewerDownload(bytes, name='document.pdf'){
      document.getElementById('btnDownloadCurrent').onclick = ()=>{ saveBytes(bytes, name); };
    }

    document.getElementById('btnClearViewer').addEventListener('click', ()=>{ pdfViewer.innerHTML=''; currentPdfBytes=null; lastSavedBytes=null; setStatus('Viewer cleared'); });

    // --- Convert ---
    document.getElementById('btnConvert').addEventListener('click', async ()=>{
      const files = document.getElementById('convertFiles').files;
      if(!files.length) return alert('Choose files to convert');
      await convertFilesToPdf(Array.from(files));
    });

    async function convertFilesToPdf(files){
      setStatus('Converting files to PDF...');
      const outDoc = await PDFDocument.create();
      for(let i=0;i<files.length;i++){
        const f = files[i];
        if(f.type.startsWith('image/')){
          const arr = await fileToArrayBuffer(f);
          let img;
          if(f.type==='image/png') img = await outDoc.embedPng(arr); else img = await outDoc.embedJpg(arr);
          const page = outDoc.addPage([img.width, img.height]);
          page.drawImage(img,{x:0,y:0,width:img.width,height:img.height});
          log(`Embedded image ${f.name}`);
        } else if(f.type === 'text/plain'){
          const txt = await f.text();
          const page = outDoc.addPage();
          const helv = await outDoc.embedFont(StandardFonts.Helvetica);
          const lines = txt.split('\n');
          let y = page.getHeight() - 40;
          for(const line of lines){
            page.drawText(line,{x:40,y,size:12,font:helv});
            y -= 14;
            if(y < 40){ y = page.getHeight() - 40; }
          }
        } else if(f.type === 'application/pdf'){
          const bytes = await fileToArrayBuffer(f);
          const src = await PDFDocument.load(bytes);
          const copied = await outDoc.copyPages(src, src.getPageIndices());
          copied.forEach(p=> outDoc.addPage(p));
          log(`Merged PDF ${f.name}`);
        } else {
          log(`Skipped unsupported: ${f.name}`);
        }
      }
      const bytes = await outDoc.save();
      lastSavedBytes = bytes; currentPdfBytes = bytes;
      const outName = document.getElementById('outConvertName').value || 'converted.pdf';
      saveBytes(bytes, outName);
      await renderPdfInViewer(bytes);
      setStatus('Conversion complete');
    }

    // --- Merge ---
    const mergeListEl = document.getElementById('mergeList');
    let mergeFiles = [];
    document.getElementById('mergeFilesInput').addEventListener('change', (e)=>{
      const list = Array.from(e.target.files).filter(f=>f.type==='application/pdf');
      for(const f of list){
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `<div>${f.name}</div><div class="btn-group btn-group-sm"><button class="btn btn-outline-secondary btn-move-up"><i class="bi bi-arrow-up"></i></button><button class="btn btn-outline-secondary btn-move-down"><i class="bi bi-arrow-down"></i></button><button class="btn btn-outline-danger btn-remove"><i class="bi bi-x-lg"></i></button></div>`;
        mergeListEl.appendChild(item);
        mergeFiles.push({file:f,el:item});
        item.querySelector('.btn-remove').addEventListener('click', ()=>{ mergeListEl.removeChild(item); mergeFiles = mergeFiles.filter(x=>x.el!==item); });
        item.querySelector('.btn-move-up').addEventListener('click', ()=>{ const idx = Array.from(mergeListEl.children).indexOf(item); if(idx>0) mergeListEl.insertBefore(item, mergeListEl.children[idx-1];) });
        item.querySelector('.btn-move-down').addEventListener('click', ()=>{ const idx = Array.from(mergeListEl.children).indexOf(item); if(idx<mergeListEl.children.length-1) mergeListEl.insertBefore(item, mergeListEl.children[idx+2];) });
      }
      // Make mergeList sortable
      Sortable.create(mergeListEl, {animation:150});
    });

    document.getElementById('btnClearMerge').addEventListener('click', ()=>{ mergeListEl.innerHTML=''; mergeFiles=[]; });

    document.getElementById('btnMerge').addEventListener('click', async ()=>{
      if(mergeListEl.children.length===0) return alert('Add PDF files to merge');
      const merged = await PDFDocument.create();
      const els = Array.from(mergeListEl.children);
      for(let i=0;i<els.length;i++){
        const name = els[i].firstChild.textContent;
        const mf = mergeFiles.find(m=>m.file.name===name);
        if(!mf){ log('Missing file: '+name); continue; }
        const bytes = await fileToArrayBuffer(mf.file);
        const src = await PDFDocument.load(bytes);
        const copied = await merged.copyPages(src, src.getPageIndices());
        copied.forEach(p=>merged.addPage(p));
        setStatus(`Merging: ${mf.file.name}`);
      }
      const out = await merged.save();
      lastSavedBytes = out; currentPdfBytes = out;
      saveBytes(out, 'merged.pdf');
      await renderPdfInViewer(out);
      setStatus('Merge complete');
    });

    // --- Split ---
    let splitSource = null;
    document.getElementById('splitInput').addEventListener('change', async (e)=>{ if(!e.target.files.length) return; splitSource = e.target.files[0]; document.getElementById('splitPreview').textContent = 'Loaded: ' + splitSource.name; setStatus('Loaded for split: '+splitSource.name); });

    function parseRanges(spec, total){
      const parts = spec.split(',').map(s=>s.trim()).filter(Boolean);
      const out = [];
      for(const p of parts){
        if(p.includes('-')){ const [a,b]=p.split('-').map(x=>parseInt(x)); out.push({start:Math.max(1,a), end:Math.min(total,b)}); }
        else { const n=parseInt(p); if(!isNaN(n)) out.push({start:n,end:n}); }
      }
      return out;
    }

    document.getElementById('btnSplit').addEventListener('click', async ()=>{
      if(!splitSource) return alert('Load a PDF first');
      const arr = await fileToArrayBuffer(splitSource);
      const src = await PDFDocument.load(arr);
      const total = src.getPageCount();
      const spec = document.getElementById('splitRanges').value;
      if(!spec) return alert('Enter pages or ranges');
      const ranges = parseRanges(spec, total);
      const outDoc = await PDFDocument.create();
      for(const r of ranges){
        for(let p=r.start-1;p<=r.end-1;p++){
          if(p<0||p>=total) continue;
          const [copied] = await outDoc.copyPages(src,[p]);
          outDoc.addPage(copied);
        }
      }
      const bytes = await outDoc.save();
      saveBytes(bytes, 'extracted.pdf');
      await renderPdfInViewer(bytes);
      setStatus('Extracted pages');
    });

    document.getElementById('btnSplitAll').addEventListener('click', async ()=>{
      if(!splitSource) return alert('Load a PDF first');
      const arr = await fileToArrayBuffer(splitSource);
      const src = await PDFDocument.load(arr);
      const total = src.getPageCount();
      for(let p=0;p<total;p++){
        const out = await PDFDocument.create();
        const [copied] = await out.copyPages(src,[p]);
        out.addPage(copied);
        const bytes = await out.save();
        saveBytes(bytes, `page-${p+1}.pdf`);
      }
      setStatus('Split all pages exported');
    });

    // --- Organize: thumbnails, drag/drop reorder, delete, export ---
    const pagesContainer = document.getElementById('pagesContainer');

    document.getElementById('organizeInput').addEventListener('change', async (e)=>{
      if(!e.target.files.length) return;
      const f = e.target.files[0];
      const bytes = await fileToArrayBuffer(f);
      organizeSourceBytes = bytes;
      organizePdfDoc = await PDFDocument.load(bytes);
      await buildPageThumbnails(bytes);
      await renderPdfInViewer(bytes);
      setStatus('Loaded for organize: ' + f.name);
    });

    async function buildPageThumbnails(bytes){
      pagesContainer.innerHTML = '';
      const uint8 = new Uint8Array(bytes);
      const doc = await pdfjsLib.getDocument({data:uint8}).promise;
      for(let p=1;p<=doc.numPages;p++){
        const page = await doc.getPage(p);
        const viewport = page.getViewport({scale:0.6});
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({canvasContext:ctx,viewport}).promise;
        const wrapper = document.createElement('div');
        wrapper.className = 'page-thumb';
        wrapper.dataset.page = p-1;
        wrapper.appendChild(canvas);
        const controls = document.createElement('div'); controls.className='page-controls';
        controls.innerHTML = `<button class="btn btn-sm btn-light select-page" title="Select"><i class="bi bi-check2"></i></button>
                              <button class="btn btn-sm btn-light del-page" title="Delete"><i class="bi bi-trash"></i></button>`;
        wrapper.appendChild(controls);
        pagesContainer.appendChild(wrapper);
        wrapper.querySelector('.del-page').addEventListener('click', ()=>{ wrapper.remove(); });
        wrapper.querySelector('.select-page').addEventListener('click', ()=>{ wrapper.classList.toggle('border-primary'); wrapper.classList.toggle('border-3'); });
      }
      Sortable.create(pagesContainer, {animation:200});
      setStatus('Thumbnails ready: ' + doc.numPages + ' pages');
    }

    document.getElementById('btnExportOrganized').addEventListener('click', async ()=>{
      if(!organizeSourceBytes) return alert('Load a PDF first');
      const src = await PDFDocument.load(organizeSourceBytes);
      const out = await PDFDocument.create();
      const orderEls = Array.from(pagesContainer.children);
      if(orderEls.length===0) return alert('No pages visible');
      for(let i=0;i<orderEls.length;i++){
        const idx = parseInt(orderEls[i].dataset.page,10);
        const [copied] = await out.copyPages(src,[idx]);
        out.addPage(copied);
      }
      const bytes = await out.save();
      saveBytes(bytes, 'organized.pdf');
      await renderPdfInViewer(bytes);
      setStatus('Organized PDF exported');
      lastSavedBytes = bytes; currentPdfBytes = bytes;
    });

    document.getElementById('btnClearOrganize').addEventListener('click', ()=>{ pagesContainer.innerHTML=''; organizeSourceBytes=null; setStatus('Organize cleared'); });

    // --- Watermark & page numbers ---
    document.getElementById('btnApplyWatermark').addEventListener('click', async ()=>{
      const fi = document.getElementById('watermarkFile').files[0];
      if(!fi) return alert('Select a PDF file');
      const arr = await fileToArrayBuffer(fi);
      const src = await PDFDocument.load(arr);
      const out = await PDFDocument.create();
      const helv = await out.embedFont(StandardFonts.HelveticaBold);
      const text = document.getElementById('wmText').value || 'Confidential';
      const opacity = parseFloat(document.getElementById('wmOpacity').value || 0.12);
      const size = parseInt(document.getElementById('wmSize').value || 48);
      const pos = document.getElementById('wmPosition').value;
      for(let i=0;i<src.getPageCount();i++){
        const [copied] = await out.copyPages(src,[i]);
        const {width,height} = copied.getSize();
        if(pos==='diagonal'){
          copied.drawText(text,{x:width/4,y:height/2,size,font:helv,rotate:degrees(-30),opacity});
        } else if(pos==='center'){
          copied.drawText(text,{x:width/2 - text.length*5,y:height/2,size,font:helv,opacity});
        } else {
          copied.drawText(text,{x:40,y:height-60,size,font:helv,opacity});
        }
        out.addPage(copied);
      }
      const bytes = await out.save();
      saveBytes(bytes,'watermarked.pdf');
      await renderPdfInViewer(bytes);
      setStatus('Watermark applied');
      lastSavedBytes = bytes; currentPdfBytes = bytes;
    });

    document.getElementById('btnAddPageNumbers').addEventListener('click', async ()=>{
      const fi = document.getElementById('watermarkFile').files[0];
      if(!fi) return alert('Select a PDF file');
      const arr = await fileToArrayBuffer(fi);
      const src = await PDFDocument.load(arr);
      const out = await PDFDocument.create();
      const helv = await out.embedFont(StandardFonts.Helvetica);
      const total = src.getPageCount();
      for(let i=0;i<total;i++){
        const [copied] = await out.copyPages(src,[i]);
        const {width} = copied.getSize();
        copied.drawText(`${i+1} / ${total}`, {x: width/2 - 20, y: 20, size: 12, font:helv});
        out.addPage(copied);
      }
      const bytes = await out.save();
      saveBytes(bytes,'pagenums.pdf');
      await renderPdfInViewer(bytes);
      setStatus('Page numbers added');
      lastSavedBytes = bytes; currentPdfBytes = bytes;
    });

    // --- Signature: draw, save, place on selected page ---
    const sigCanvas = document.getElementById('sigPad');
    const sctx = sigCanvas.getContext('2d'); sctx.lineWidth=2; sctx.strokeStyle='#111';
    let drawing=false;
    sigCanvas.addEventListener('pointerdown', (e)=>{ drawing=true; sctx.beginPath(); sctx.moveTo(e.offsetX,e.offsetY); });
    sigCanvas.addEventListener('pointerup', ()=>{ drawing=false; });
    sigCanvas.addEventListener('pointermove', (e)=>{ if(!drawing) return; sctx.lineTo(e.offsetX,e.offsetY); sctx.stroke(); });

    document.getElementById('sigClear').addEventListener('click', ()=> sctx.clearRect(0,0,sigCanvas.width,sigCanvas.height));
    document.getElementById('sigSave').addEventListener('click', ()=>{
      const data = sigCanvas.toDataURL('image/png');
      savedSignatures.push(data);
      const img = document.createElement('img'); img.src=data; img.style.height='48px'; img.style.border='1px solid #ddd'; img.style.borderRadius='6px';
      img.className='me-2';
      document.getElementById('savedSignatures').appendChild(img);
      setStatus('Signature saved');
    });

    document.getElementById('btnPlaceSaved').addEventListener('click', async ()=>{
      if(savedSignatures.length===0) return alert('Save a signature first');
      if(!organizeSourceBytes) return alert('Load a PDF in Organize tab and select a page thumbnail');
      // find selected thumbnail
      const selected = pagesContainer.querySelector('.border-3');
      if(!selected) return alert('Select a page thumbnail in Organize first');
      const pageIndex = parseInt(selected.dataset.page,10);
      const src = await PDFDocument.load(organizeSourceBytes);
      const out = await PDFDocument.create();
      const sigBytes = await (await fetch(savedSignatures[savedSignatures.length-1])).arrayBuffer();
      const sigImg = await out.embedPng(sigBytes);
      for(let i=0;i<src.getPageCount();i++){
        const [copied] = await out.copyPages(src,[i]);
        if(i===pageIndex){
          const {width} = copied.getSize();
          const w = Math.min(200, width*0.25);
          const h = (sigImg.height / sigImg.width) * w;
          copied.drawImage(sigImg,{x: width - w - 40, y: 40, width:w, height:h});
        }
        out.addPage(copied);
      }
      const bytes = await out.save();
      saveBytes(bytes,'signed.pdf');
      await renderPdfInViewer(bytes);
      setStatus('Signature placed on page '+(pageIndex+1));
      lastSavedBytes = bytes; currentPdfBytes = bytes;
    });

    // --- Compression (rasterize pages to images at chosen quality) ---
    document.getElementById('btnCompress').addEventListener('click', async ()=>{
      const f = document.getElementById('compressInput').files[0];
      if(!f) return alert('Choose a PDF to compress');
      const q = parseFloat(document.getElementById('compressQuality').value);
      setStatus('Compressing (this may be slow)...');
      const arr = await fileToArrayBuffer(f);
      const src = await pdfjsLib.getDocument({data:new Uint8Array(arr)}).promise;
      const out = await PDFDocument.create();
      for(let p=1;p<=src.numPages;p++){
        const page = await src.getPage(p);
        const viewport = page.getViewport({scale:1.5});
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({canvasContext:ctx,viewport}).promise;
        // convert canvas to jpeg at quality q
        const dataUrl = canvas.toDataURL('image/jpeg', q);
        const imgBytes = dataURLToUint8Array(dataUrl);
        const img = await out.embedJpg(imgBytes);
        const newPage = out.addPage([img.width,img.height]);
        newPage.drawImage(img,{x:0,y:0,width:img.width,height:img.height});
      }
      const bytes = await out.save();
      saveBytes(bytes,'compressed.pdf');
      await renderPdfInViewer(bytes);
      setStatus('Compression finished (lossy)');
      lastSavedBytes = bytes; currentPdfBytes = bytes;
    });

    // --- Protect (AES) ---
    document.getElementById('btnEncrypt').addEventListener('click', async ()=>{
      const f = document.getElementById('protectInput').files[0];
      const pass = document.getElementById('protectPass').value;
      if(!f) return alert('Choose file to encrypt');
      if(!pass) return alert('Enter a password');
      const arr = await fileToArrayBuffer(f);
      // convert arr to word array
      const wordArray = CryptoJS.lib.WordArray.create(arr);
      const ciphertext = CryptoJS.AES.encrypt(wordArray, pass).toString();
      const blob = new Blob([ciphertext], {type:'application/octet-stream'});
      saveBlob(blob, f.name + '.enc');
      setStatus('File encrypted (AES): ' + f.name + '.enc');
    });

    document.getElementById('btnDecrypt').addEventListener('click', async ()=>{
      const f = document.getElementById('protectInput').files[0];
      const pass = document.getElementById('protectPass').value;
      if(!f) return alert('Choose .enc file to decrypt');
      if(!pass) return alert('Enter password');
      const text = await f.text();
      try{
        const decrypted = CryptoJS.AES.decrypt(text, pass);
        // decrypted is a WordArray; convert to Uint8Array
        const u8 = wordArrayToUint8Array(decrypted);
        const blob = new Blob([u8], {type:'application/octet-stream'});
        saveBlob(blob, f.name.replace(/\.enc$/,''));
        setStatus('File decrypted: ' + f.name);
      } catch(e){
        alert('Decryption failed');
        log('Decrypt error: ' + e.message);
      }
    });

    function wordArrayToUint8Array(wordArray){
      const len = wordArray.sigBytes;
      const words = wordArray.words;
      const u8 = new Uint8Array(len);
      let idx=0;
      for(let i=0;i<words.length;i++){
        let w = words[i];
        u8[idx++] = (w>>24)&0xFF; if(idx>=len) break;
        u8[idx++] = (w>>16)&0xFF; if(idx>=len) break;
        u8[idx++] = (w>>8)&0xFF; if(idx>=len) break;
        u8[idx++] = (w)&0xFF; if(idx>=len) break;
      }
      return u8;
    }

    function dataURLToUint8Array(dataURL){
      const base64 = dataURL.split(',')[1];
      const raw = atob(base64);
      const arr = new Uint8Array(raw.length);
      for(let i=0;i<raw.length;i++) arr[i]=raw.charCodeAt(i);
      return arr;
    }

    // --- Rotate entire PDF ---
    document.getElementById('btnRotate').addEventListener('click', async ()=>{
      const f = document.getElementById('rotateInput').files[0];
      const angle = parseInt(document.getElementById('rotateAngle').value);
      if(!f) return alert('Choose a PDF to rotate');
      const bytes = await fileToArrayBuffer(f);
      const src = await PDFDocument.load(bytes);
      const out = await PDFDocument.create();
      for(let i=0;i<src.getPageCount();i++){
        const [copied] = await out.copyPages(src,[i]);
        copied.setRotation(degrees(angle));
        out.addPage(copied);
      }
      const outBytes = await out.save();
      saveBytes(outBytes,'rotated.pdf');
      await renderPdfInViewer(outBytes);
      setStatus('Rotated by '+angle+'°');
      lastSavedBytes = outBytes; currentPdfBytes = outBytes;
    });

    // --- Utilities ---
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      document.body.classList.toggle('theme-dark');
    });

    document.getElementById('btnDownloadCurrent').addEventListener('click', ()=>{
      if(!lastSavedBytes) return alert('No current PDF to download');
      saveBytes(lastSavedBytes, 'document.pdf');
    });

    // Expose some global log on load
    setStatus('Ready — client-side PDF toolkit loaded');

    // Prevent syntax errors in older browsers for move up/down quick functions:
    // (These simple movement functions were left intentionally minimal)
    // End script
  </script>
</body>
</html>