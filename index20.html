<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Crypto Toolbox — Updated (Password UI + File hash compare)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome for eye icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- CryptoJS (symmetric + hashes) -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/md5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha256.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha3.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/ripemd160.js"></script>

  <!-- jsrsasign for RSA PEM handling -->
  <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.8.6/jsrsasign-all-min.js"></script>

  <style>
    :root { --bg:#f7fafc; --card:#fff; --text:#0b1a2b; --muted:#6b7280; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    [data-theme="dark"]{ --bg:#071127; --card:#071a2a; --text:#dbeafe; --muted:#9fb3d7; color-scheme: dark; }
    body { margin:0; padding:18px; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { background:var(--card); border:none; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.06); margin-bottom:18px; }
    .eye-input { position:relative; display:flex; align-items:stretch; gap:6px; }
    .eye-input .eye-btn { position:absolute; right:8px; top:50%; transform:translateY(-50%); background:transparent; border:0; color:var(--muted); cursor:pointer; z-index:3; }
    .monos { font-family:var(--mono); font-size:0.9rem; }
    .cipher-output { white-space:pre-wrap; word-break:break-word; }
    pre.morse { max-height:300px; overflow:auto; background:#f1f5f9; padding:12px; border-radius:8px; }
  </style>
</head>
<body data-theme="light">
  <div class="container-fluid">
    <header class="d-flex align-items-center mb-3">
      <h1 class="h4 me-3">Crypto Toolbox — Updated</h1>
      <div class="ms-auto d-flex gap-3 align-items-center">
        <div class="form-check form-switch">
          <input id="themeToggle" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="themeToggle">Dark</label>
        </div>
        <small class="text-muted">Client-only demo • CryptoJS & jsrsasign</small>
      </div>
    </header>

    <nav class="nav nav-pills mb-3 flex-column flex-sm-row gap-2">
      <a class="nav-link active" href="#gen">Generators</a>
      <a class="nav-link" href="#hash">Hashes</a>
      <a class="nav-link" href="#rsa">RSA Keys</a>
      <a class="nav-link" href="#text">Text & Symmetric</a>
      <a class="nav-link" href="#stego">Stego</a>
      <a class="nav-link" href="#morse">Morse</a>
    </nav>

    <!-- Password + Email generator -->
    <section id="gen" class="card p-3">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div><h5 class="mb-0">Password & Identity Generator</h5><small class="text-muted">Words-only, classic, email merge</small></div>
      </div>

      <div class="row g-3">
        <div class="col-lg-6">
          <div class="d-flex gap-2 align-items-center mb-2">
            <label class="mb-0">Mode</label>
            <select id="pwMode" class="form-select form-select-sm" style="width:200px">
              <option value="classic">Classic</option>
              <option value="words">Words-only</option>
            </select>

            <label class="mb-0">Length</label>
            <input id="pwLength" type="number" class="form-control form-control-sm" style="width:100px" value="16" min="6" max="128">

            <button id="genPwBtn" class="btn btn-primary btn-sm">Generate</button>
          </div>

          <div id="classicSettings" class="mb-2">
            <div class="d-flex gap-2 mb-2">
              <label class="mb-0">Letters</label><input id="pwLetters" type="number" class="form-control form-control-sm" value="10" style="width:100px">
              <label class="mb-0">Digits</label><input id="pwDigits" type="number" class="form-control form-control-sm" value="4" style="width:100px">
              <label class="mb-0">Symbols</label><input id="pwSymbols" type="number" class="form-control form-control-sm" value="2" style="width:100px">
            </div>
            <div class="d-flex gap-2 mb-1">
              <label class="mb-0">lower</label><input id="incLower" class="form-check-input" type="checkbox" checked>
              <label class="mb-0">UPPER</label><input id="incUpper" class="form-check-input" type="checkbox" checked>
              <label class="mb-0">digits</label><input id="incNum" class="form-check-input" type="checkbox" checked>
              <label class="mb-0">symbols</label><input id="incSym" class="form-check-input" type="checkbox" checked>
            </div>
            <div class="d-flex gap-2">
              <label>Group size</label><input id="groupSize" type="number" class="form-control form-control-sm" value="4" style="width:90px">
              <label>Separator</label><input id="groupSep" class="form-control form-control-sm" value="-" style="width:90px">
            </div>
          </div>

          <div id="wordsSettings" style="display:none" class="mb-2">
            <div class="d-flex gap-2">
              <label>Words</label><input id="wordsCount" type="number" class="form-control form-control-sm" value="5" min="2" max="12" style="width:90px">
              <label>Capitalize</label><input id="wordsCap" type="checkbox" class="form-check-input" checked>
            </div>
          </div>

          <label class="form-label mt-2">Generated</label>
          <div class="input-group mb-2 eye-input">
            <div id="pwOutput" class="form-control monos" style="min-height:48px; overflow:auto"></div>
            <button class="eye-btn" data-target="pwOutput"><i class="fa-regular fa-eye"></i></button>
            <button id="copyPw" class="btn btn-outline-secondary btn-sm" title="Copy"><i class="fa fa-copy"></i></button>
            <button id="clearPw" class="btn btn-outline-danger btn-sm" title="Clear"><i class="fa fa-trash"></i></button>
          </div>

          <div class="mt-2">
            <div class="progress" style="height:10px"><div id="pwBar" class="progress-bar" style="width:0%"></div></div>
            <small id="pwInfo" class="text-muted">Entropy & crack time</small>
          </div>
        </div>

        <div class="col-lg-6">
          <label>Email merge</label>
          <div class="input-group mb-2 eye-input">
            <input id="baseEmail" class="form-control" placeholder="alpha@gmail.com">
            <button class="eye-btn" data-target="baseEmail"><i class="fa-regular fa-eye"></i></button>
            <button id="mergeEmailBtn" class="btn btn-secondary btn-sm">Generate 5</button>
          </div>
          <ul id="emailList" class="list-group mb-2"></ul>
          <div class="d-flex gap-2">
            <button id="copyEmailAll" class="btn btn-outline-secondary btn-sm">Copy all</button>
            <button id="genNamesBtn" class="btn btn-outline-secondary btn-sm">Names</button>
            <button id="genPassphrasesBtn" class="btn btn-outline-secondary btn-sm">Passphrases</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Hashes section (file upload + compare) -->
    <section id="hash" class="card p-3">
      <h5>Hashes & File Compare</h5>
      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <label>Choose file</label>
          <input id="hashFilePicker" type="file" class="form-control">
        </div>

        <div class="col-md-4">
          <label>Select algorithm</label>
          <select id="hashAlgoSelect" class="form-select">
            <option value="ALL">All (compute all built-in)</option>
            <option value="MD5">MD5</option>
            <option value="SHA-1">SHA-1</option>
            <option value="SHA-256">SHA-256</option>
            <option value="SHA3">SHA3-512</option>
            <option value="RIPEMD160">RIPEMD160</option>
            <option value="HAVAL-256">HAVAL-256 (external)</option>
          </select>
        </div>

        <div class="col-md-4 d-flex gap-2 align-items-end">
          <button id="computeHashesBtn" class="btn btn-primary">Compute</button>
          <button id="copyAllHashesBtn" class="btn btn-outline-secondary">Copy all</button>
        </div>

        <div class="col-12 mt-3">
          <label>Computed hashes</label>
          <div id="computedHashes" class="p-2 border monos cipher-output" style="min-height:80px"></div>
        </div>

        <div class="col-md-8 mt-3">
          <label>Compare a hash (paste hash string here)</label>
          <input id="hashCompareInput" class="form-control" placeholder="Paste hash to compare">
        </div>
        <div class="col-md-4 mt-3 d-flex gap-2 align-items-end">
          <button id="hashCompareBtn" class="btn btn-success">Compare</button>
          <button id="clearHashCompareBtn" class="btn btn-outline-danger">Clear</button>
        </div>

        <div class="col-12 mt-2">
          <div id="hashCompareResult" class="mt-2"></div>
        </div>
      </div>
    </section>

    <!-- RSA (kept as before) -->
    <section id="rsa" class="card p-3">
      <h5>RSA Keys — generate / import / export / encrypt / decrypt</h5>
      <div class="row g-2 mb-2">
        <div class="col-md-2"><select id="rsaBits" class="form-select"><option>2048</option><option>3072</option><option>4096</option></select></div>
        <div class="col-md-10 d-flex gap-2">
          <button id="rsaGen" class="btn btn-primary btn-sm">Generate</button>
          <button id="rsaExportPub" class="btn btn-outline-secondary btn-sm">Export pub</button>
          <button id="rsaExportPriv" class="btn btn-outline-secondary btn-sm">Export priv</button>
          <button id="rsaClear" class="btn btn-danger btn-sm">Clear</button>
        </div>
      </div>

      <div>
        <label>Public PEM</label>
        <textarea id="rsaPub" class="form-control monos" rows="4"></textarea>
      </div>
      <div class="mt-2">
        <label>Private PEM</label>
        <textarea id="rsaPriv" class="form-control monos" rows="5"></textarea>
      </div>

      <hr>
      <label>Plaintext / Ciphertext</label>
      <div class="input-group mb-2 eye-input">
        <textarea id="rsaMsg" class="form-control monos" rows="4"></textarea>
        <button class="eye-btn" data-target="rsaMsg"><i class="fa-regular fa-eye"></i></button>
      </div>
      <div class="d-flex gap-2 mb-2">
        <button id="rsaEncBtn" class="btn btn-outline-primary btn-sm">Encrypt (pub)</button>
        <button id="rsaDecBtn" class="btn btn-outline-success btn-sm">Decrypt (priv)</button>
        <button id="rsaCopyOut" class="btn btn-outline-secondary btn-sm">Copy output</button>
      </div>

      <div class="mt-2">
        <label>Output</label>
        <div id="rsaOutput" class="p-2 border monos cipher-output" style="min-height:120px"></div>
      </div>
    </section>

    <!-- Text & Symmetric -->
    <section id="text" class="card p-3">
      <h5>Text Encryption (symmetric) & Hashes</h5>
      <div class="row g-3">
        <div class="col-lg-6">
          <label>Input</label>
          <div class="input-group mb-2 eye-input">
            <textarea id="plainText" class="form-control" rows="6"></textarea>
            <button class="eye-btn" data-target="plainText"><i class="fa-regular fa-eye"></i></button>
          </div>

          <div class="d-flex gap-2 mb-2">
            <select id="symAlgo" class="form-select form-select-sm" style="width:160px">
              <option value="AES">AES</option><option value="DES">DES</option><option value="TripleDES">3DES</option><option value="RC4">RC4</option><option value="Rabbit">Rabbit</option>
            </select>
            <input id="symPass" type="password" class="form-control form-control-sm" placeholder="passphrase" style="max-width:260px">
            <button class="eye-btn" data-target="symPass"><i class="fa-regular fa-eye"></i></button>
            <button id="symEncBtn" class="btn btn-outline-primary btn-sm">Encrypt</button>
            <button id="symDecBtn" class="btn btn-outline-success btn-sm">Decrypt</button>
          </div>

          <label>Output</label>
          <div id="symOutput" class="p-2 border monos cipher-output" style="min-height:140px"></div>
        </div>

        <div class="col-lg-6">
          <!-- reserved for other features -->
        </div>
      </div>
    </section>

    <!-- Stego -->
    <section id="stego" class="card p-3">
      <h5>Image Steganography (LSB) — AES protected</h5>
      <div class="row g-2">
        <div class="col-md-6">
          <input id="coverImage" type="file" accept="image/*" class="form-control mb-2">
          <label>Message</label>
          <textarea id="stegMessage" class="form-control mb-2" rows="3"></textarea>
          <div class="input-group eye-input mb-2">
            <input id="stegPass" type="password" class="form-control" placeholder="password">
            <button class="eye-btn" data-target="stegPass"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="d-flex gap-2 mb-2">
            <button id="stegHide" class="btn btn-primary btn-sm">Hide & Preview</button>
            <button id="stegReveal" class="btn btn-success btn-sm">Reveal (upload)</button>
            <input id="stegUpload" type="file" accept="image/*" class="form-control form-control-sm">
            <button id="stegDownloadBtn" class="btn btn-outline-secondary btn-sm" disabled>Download</button>
          </div>
          <div>Stego status: <span id="stegStatus">Idle</span> — Attempts: <span id="stegAttempts">0</span></div>
        </div>
        <div class="col-md-6">
          <label>Preview</label>
          <canvas id="stegCanvas" class="border" style="max-width:100%"></canvas>
          <small class="text-muted d-block mt-2">AES-CBC (PBKDF2) → Base64 → LSB</small>
        </div>
      </div>
    </section>

    <!-- Morse -->
    <section id="morse" class="card p-3">
      <h5>Morse (full table)</h5>
      <div class="row">
        <div class="col-md-6"><textarea id="morseIn" class="form-control" rows="3"></textarea>
          <div class="mt-2 d-flex gap-2">
            <button id="morseEnc" class="btn btn-outline-primary btn-sm">Encode</button>
            <button id="morseDec" class="btn btn-outline-secondary btn-sm">Decode</button>
          </div>
        </div>
        <div class="col-md-6"><div id="morseOut" class="p-2 border monos cipher-output" style="min-height:120px"></div></div>
      </div>

      <hr>
      <pre class="morse">
A  .-      B  -...    C  -.-.    D  -..     E  .      F  ..-.
G  --.     H  ....    I  ..      J  .---    K  -.-    L  .-..
M  --      N  -.      O  ---     P  .--.    Q  --.-   R  .-.
S  ...     T  -       U  ..-     V  ...-    W  .--    X  -..-
Y  -.--    Z  --..
0  -----   1  .----   2  ..---   3  ...--   4  ....-   5  .....
6  -....   7  --...   8  ---..   9  ----.
.  .-.-.-  ,  --..--  ?  ..--..  '  .----.  !  -.-.--
/  -..-.   (  -.--.   )  -.--.-  &  .-...
:  ---...  ;  -.-.-.  =  -...-   +  .-.-.   -  -....-
_  ..--.-  "  .-..-.  $  ...-..-  @  .--.-.  #  ......  *  -..-.-
      </pre>
    </section>

    <footer class="text-center my-4">
      <small>Educational demo. Use HTTPS / localhost for WebCrypto features. HAVAL requires an external library; see notes below.</small>
    </footer>
  </div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /******************************************************************
   * Utilities
   ******************************************************************/
  function rngInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function copyText(valueOrId){
    if(document.getElementById(valueOrId)){
      const el = document.getElementById(valueOrId);
      const txt = el.value ?? el.textContent ?? '';
      navigator.clipboard.writeText(txt).catch(()=>{});
    } else {
      navigator.clipboard.writeText(String(valueOrId)).catch(()=>{});
    }
  }
  function abToHex(ab){ return [...new Uint8Array(ab)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function bytesToB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
  function b64ToBytes(b64){ const bin = atob(b64); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr; }

  // theme toggle
  document.getElementById('themeToggle').addEventListener('change', e => document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light'));

  // generic eye toggle for elements with data-target
  document.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.eye-btn');
    if(!btn) return;
    const tid = btn.getAttribute('data-target'); if(!tid) return;
    const el = document.getElementById(tid); if(!el) return;
    const icon = btn.querySelector('i');
    if(el.tagName === 'INPUT'){
      if(el.type === 'password'){ el.type = 'text'; icon.className = 'fa-regular fa-eye-slash'; }
      else { el.type = 'password'; icon.className = 'fa-regular fa-eye'; }
      return;
    }
    if(el.tagName === 'TEXTAREA' || el.tagName === 'DIV'){
      if(el.style.filter === 'blur(6px)'){ el.style.filter = 'none'; icon.className = 'fa-regular fa-eye'; }
      else { el.style.filter = 'blur(6px)'; icon.className = 'fa-regular fa-eye-slash'; }
    }
  });

  /******************************************************************
   * Password generator (with copy, clear, hide)
   ******************************************************************/
  const WORDS = ["lunacy","ceremony","kisser","cannon","devalue","alpha","bravo","charlie","delta","echo","foxtrot","gambit","harbor","island","jovial","krypton","lattice","magnet","nectar","opal","pylon","quartz","ripple","sable","tango","umbra","vivid","wander","xenon","yonder","zephyr"];

  document.getElementById('pwMode').addEventListener('change', function(){
    const mode = this.value;
    document.getElementById('classicSettings').style.display = mode === 'classic' ? 'block' : 'none';
    document.getElementById('wordsSettings').style.display = mode === 'words' ? 'block' : 'none';
  });

  function genClassic(len, lettersCount, numCount, symCount, groupsz, sep, incLower, incUpper, incNum, incSym){
    const lower='abcdefghijklmnopqrstuvwxyz', upper='ABCDEFGHIJKLMNOPQRSTUVWXYZ', digits='0123456789', syms='!@#$%^&*()-_=+[]{};:,.<>?/|`~';
    let pool='';
    if(incLower) pool += lower;
    if(incUpper) pool += upper;
    if(incNum) pool += digits;
    if(incSym) pool += syms;
    if(!pool) pool = lower + upper + digits;
    const arr=[];
    for(let i=0;i<lettersCount && arr.length<len;i++){
      const lp = ((incLower?lower:'') + (incUpper?upper:'')) || lower;
      arr.push(lp.charAt(rngInt(0,lp.length-1)));
    }
    for(let i=0;i<numCount && arr.length<len;i++) arr.push(digits.charAt(rngInt(0,digits.length-1)));
    for(let i=0;i<symCount && arr.length<len;i++) arr.push(syms.charAt(rngInt(0,syms.length-1)));
    while(arr.length < len) arr.push(pool.charAt(rngInt(0,pool.length-1)));
    for(let i=arr.length-1;i>0;i--){ const j=rngInt(0,i); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    let p = arr.join('');
    if(groupsz>0){ const parts=[]; for(let i=0;i<p.length;i+=groupsz) parts.push(p.slice(i,i+groupsz)); p = parts.join(sep); }
    return p;
  }

  function genWords(count, cap){
    const out=[];
    for(let i=0;i<count;i++){ let w = WORDS[rngInt(0,WORDS.length-1)]; if(cap) w = w.charAt(0).toUpperCase() + w.slice(1); out.push(w); }
    return out.join('-');
  }

  function secHuman(s){
    if(!isFinite(s) || s>1e18) return '>> centuries';
    if(s<60) return Math.round(s)+'s';
    if(s<3600) return Math.round(s/60)+'m';
    if(s<86400) return Math.round(s/3600)+'h';
    if(s<31536000) return Math.round(s/86400)+'d';
    return Math.round(s/31536000)+'y';
  }

  document.getElementById('genPwBtn').addEventListener('click', ()=>{
    const mode = document.getElementById('pwMode').value;
    let out = '';
    if(mode === 'classic'){
      const len = Math.max(6, Math.min(128, +document.getElementById('pwLength').value || 16));
      const lettersCount = Math.max(0, +document.getElementById('pwLetters').value || 0);
      const numCount = Math.max(0, +document.getElementById('pwDigits').value || 0);
      const symCount = Math.max(0, +document.getElementById('pwSymbols').value || 0);
      const groupsz = Math.max(0, +document.getElementById('groupSize').value || 0);
      const sep = document.getElementById('groupSep').value || '-';
      const incLower = document.getElementById('incLower').checked;
      const incUpper = document.getElementById('incUpper').checked;
      const incNum = document.getElementById('incNum').checked;
      const incSym = document.getElementById('incSym').checked;
      out = genClassic(len, lettersCount, numCount, symCount, groupsz, sep, incLower, incUpper, incNum, incSym);
      let poolSize = 0; if(incLower) poolSize+=26; if(incUpper) poolSize+=26; if(incNum) poolSize+=10; if(incSym) poolSize+=32; if(poolSize===0) poolSize=62;
      const bits = Math.log2(Math.pow(poolSize, out.replace(/[^A-Za-z0-9]/g,'').length));
      const seconds = Math.pow(2, bits)/1e9;
      document.getElementById('pwBar').style.width = Math.min(100,bits)+'%';
      document.getElementById('pwBar').textContent = Math.round(bits)+' bits';
      document.getElementById('pwInfo').textContent = 'Est. crack @1e9 g/s: '+secHuman(seconds);
    } else {
      const count = Math.max(2, Math.min(12, +document.getElementById('wordsCount').value || 5));
      const cap = document.getElementById('wordsCap').checked;
      out = genWords(count, cap);
      const bits = Math.log2(WORDS.length) * count;
      const seconds = Math.pow(2,bits)/1e9;
      document.getElementById('pwBar').style.width = Math.min(100,bits)+'%';
      document.getElementById('pwBar').textContent = Math.round(bits)+' bits';
      document.getElementById('pwInfo').textContent = 'Est. crack @1e9 g/s: '+secHuman(seconds);
    }
    document.getElementById('pwOutput').textContent = out;
    document.getElementById('pwOutput').style.filter = 'none';
    // ensure eye icon is "visible" state
    document.querySelectorAll('.eye-btn[data-target="pwOutput"]').forEach(b=> b.querySelector('i').className='fa-regular fa-eye');
  });

  document.getElementById('copyPw').addEventListener('click', ()=> copyText('pwOutput'));
  document.getElementById('clearPw').addEventListener('click', ()=> { document.getElementById('pwOutput').textContent=''; document.getElementById('pwBar').style.width='0%'; document.getElementById('pwBar').textContent=''; document.getElementById('pwInfo').textContent='Cleared'; });

  // email merge
  function mergeEmail(base){
    try{
      const parts = base.split('@'); if(parts.length!==2) return base;
      const local = parts[0]; const domain = parts[1];
      const suffix = Array.from({length:8}).map(()=> 'abcdefghijklmnopqrstuvwxyz0123456789'[rngInt(0,35)]).join('');
      return `${local.charAt(0).toUpperCase()+local.slice(1)}+${suffix}@${domain}`;
    }catch(e){ return base; }
  }
  document.getElementById('mergeEmailBtn').addEventListener('click', ()=>{
    const base = document.getElementById('baseEmail').value || 'alpha@gmail.com';
    const ul = document.getElementById('emailList'); ul.innerHTML='';
    for(let i=0;i<5;i++){ const e=mergeEmail(base); const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML=`<span>${e}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button></div>`; li.querySelector('.copy').addEventListener('click', ()=> copyText(e)); ul.appendChild(li);}
  });
  document.getElementById('copyEmailAll').addEventListener('click', ()=> {
    const items = Array.from(document.querySelectorAll('#emailList li span')).map(s=>s.textContent).join('\n');
    copyText(items);
  });

  /******************************************************************
   * Hash computation + file compare
   * - computes built-in hashes (MD5, SHA-1, SHA-256, SHA3-512, RIPEMD160)
   * - HAVAL-256 option is shown but requires an external library (not included by default)
   ******************************************************************/
  async function computeFileHashes(file){
    if(!file) return {};
    const ab = await file.arrayBuffer();
    const results = {};
    // SHA-1 and SHA-256 via WebCrypto for speed
    try {
      const sha1 = await crypto.subtle.digest('SHA-1', ab);
      results['SHA-1'] = abToHex(sha1);
    } catch(e){ results['SHA-1'] = '[error]'; }
    try {
      const sha256 = await crypto.subtle.digest('SHA-256', ab);
      results['SHA-256'] = abToHex(sha256);
    } catch(e){ results['SHA-256'] = '[error]'; }

    // MD5, SHA3, RIPEMD160 via CryptoJS (needs WordArray)
    const u8 = new Uint8Array(ab);
    const wa = CryptoJS.lib.WordArray.create(u8);
    try { results['MD5'] = CryptoJS.MD5(wa).toString(CryptoJS.enc.Hex); } catch(e){ results['MD5']='[error]'; }
    try { results['SHA3'] = CryptoJS.SHA3(wa, { outputLength: 512 }).toString(CryptoJS.enc.Hex); } catch(e){ results['SHA3'] = '[error]'; }
    try { results['RIPEMD160'] = CryptoJS.RIPEMD160(wa).toString(CryptoJS.enc.Hex); } catch(e){ results['RIPEMD160']='[error]'; }

    // HAVAL-256: not included by default. If a global `haval256` function exists, call it.
    if(typeof window.haval256 === 'function'){
      try { results['HAVAL-256'] = window.haval256(new TextDecoder().decode(ab)); }
      catch(e){ results['HAVAL-256'] = '[haval error]'; }
    } else {
      results['HAVAL-256'] = '[not available: add haval-js]';
    }

    return results;
  }

  document.getElementById('computeHashesBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('hashFilePicker').files[0];
    if(!f) return alert('Select a file first');
    const algoSel = document.getElementById('hashAlgoSelect').value;
    document.getElementById('computedHashes').textContent = 'Computing...';
    const hashes = await computeFileHashes(f);
    // display either specific or all
    if(algoSel === 'ALL'){
      let txt = '';
      for(const k of ['MD5','SHA-1','SHA-256','SHA3','RIPEMD160','HAVAL-256']){
        txt += `${k}: ${hashes[k] ?? '[n/a]'}\n`;
      }
      document.getElementById('computedHashes').textContent = txt.trim();
    } else {
      const v = hashes[algoSel] ?? '[n/a]';
      document.getElementById('computedHashes').textContent = `${algoSel}: ${v}`;
    }
    // store computed hashes on element for comparison
    document.getElementById('computedHashes').dataset.json = JSON.stringify(hashes);
    document.getElementById('hashCompareResult').innerHTML = '';
  });

  document.getElementById('copyAllHashesBtn').addEventListener('click', ()=>{
    const t = document.getElementById('computedHashes').textContent || '';
    copyText(t);
  });

  // Compare user pasted hash
  document.getElementById('hashCompareBtn').addEventListener('click', ()=>{
    const pasted = (document.getElementById('hashCompareInput').value || '').trim().toLowerCase();
    if(!pasted) return alert('Paste a hash to compare');
    const raw = document.getElementById('computedHashes').dataset.json;
    if(!raw) return alert('No computed hashes to compare (compute file first)');
    const hashes = JSON.parse(raw);
    const sel = document.getElementById('hashAlgoSelect').value;
    let match = false, matchedAlgo = null;
    if(sel && sel !== 'ALL' && sel !== 'HAVAL-256'){
      const hv = (hashes[sel] || '').toLowerCase();
      if(hv === pasted) { match = true; matchedAlgo = sel; }
    } else if(sel === 'HAVAL-256'){
      // user specifically asked HAVAL-256 — respond accordingly
      const hv = (hashes['HAVAL-256'] || '').toLowerCase();
      if(hv === pasted) { match = true; matchedAlgo = 'HAVAL-256'; }
    } else {
      // check all available computed hashes
      for(const [k,v] of Object.entries(hashes)){
        if(!v) continue;
        if(v.toLowerCase() === pasted){ match=true; matchedAlgo=k; break; }
      }
    }
    const out = document.getElementById('hashCompareResult');
    out.innerHTML = '';
    if(match){
      out.innerHTML = `<div class="alert alert-success p-2">Match found: algorithm = <strong>${matchedAlgo}</strong></div>`;
    } else {
      out.innerHTML = `<div class="alert alert-danger p-2">No match found against computed hashes.</div>`;
      // if HAVAL was requested but not available, show note
      if(document.getElementById('hashAlgoSelect').value === 'HAVAL-256' && (JSON.parse(raw)['HAVAL-256'] || '').startsWith('[not available')){
        out.innerHTML += `<div class="alert alert-warning p-2 small">HAVAL-256 is not available by default. To enable it, add a HAVAL implementation (e.g. haval-js) and expose a function <code>window.haval256(str)</code>.</div>`;
      }
    }
  });

  document.getElementById('clearHashCompareBtn').addEventListener('click', ()=>{
    document.getElementById('hashCompareInput').value = '';
    document.getElementById('hashCompareResult').innerHTML = '';
  });

  /******************************************************************
   * RSA using jsrsasign (preserves previous stable implementation)
   ******************************************************************/
  let rsa = { pub:null, prv:null };
  function setRsaStatus(s){ document.getElementById('rsaOutput').textContent = s; }
  document.getElementById('rsaGen').addEventListener('click', ()=>{
    const bits = +document.getElementById('rsaBits').value || 2048;
    setRsaStatus('Generating...');
    setTimeout(()=> {
      try{
        const kp = KEYUTIL.generateKeypair('RSA', bits);
        rsa.pub = kp.pubKeyObj; rsa.prv = kp.prvKeyObj;
        document.getElementById('rsaPub').value = KEYUTIL.getPEM(rsa.pub);
        document.getElementById('rsaPriv').value = KEYUTIL.getPEM(rsa.prv, 'PKCS8PRV');
        setRsaStatus('Generated RSA ' + bits);
      } catch(e){
        setRsaStatus('Generate failed: ' + e);
      }
    }, 50);
  });

  document.getElementById('rsaExportPub').addEventListener('click', ()=>{
    const pem = document.getElementById('rsaPub').value || ''; if(!pem) return alert('No public'); const blob=new Blob([pem],{type:'application/x-pem-file'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='public.pem'; a.click();
  });
  document.getElementById('rsaExportPriv').addEventListener('click', ()=>{
    const pem = document.getElementById('rsaPriv').value || ''; if(!pem) return alert('No private'); const blob=new Blob([pem],{type:'application/x-pem-file'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='private.pem'; a.click();
  });
  document.getElementById('rsaClear').addEventListener('click', ()=>{
    rsa={pub:null,prv:null}; document.getElementById('rsaPub').value=''; document.getElementById('rsaPriv').value=''; document.getElementById('rsaOutput').textContent='cleared';
  });

  document.getElementById('rsaEncBtn').addEventListener('click', ()=>{
    const msg = document.getElementById('rsaMsg').value || '';
    if(!msg) return alert('Enter message');
    let pem = document.getElementById('rsaPub').value || null;
    if(!pem && rsa.pub) pem = KEYUTIL.getPEM(rsa.pub);
    if(!pem) return alert('No public key available. Generate or paste a public PEM.');
    try{
      const hex = KJUR.crypto.Cipher.encrypt(msg, pem);
      const b64 = KJUR.crypto.Util.hex2b64(hex);
      document.getElementById('rsaOutput').textContent = b64;
    } catch(e){ document.getElementById('rsaOutput').textContent = 'RSA encrypt failed: ' + e; }
  });

  document.getElementById('rsaDecBtn').addEventListener('click', ()=>{
    const b64 = document.getElementById('rsaOutput').textContent.trim();
    if(!b64) return alert('No ciphertext to decrypt (in output area).');
    let pem = document.getElementById('rsaPriv').value || null;
    if(!pem && rsa.prv) pem = KEYUTIL.getPEM(rsa.prv, 'PKCS8PRV');
    if(!pem) return alert('No private key available. Generate/import private PEM.');
    try{
      const hex = KJUR.crypto.Util.b64tohex(b64);
      const dec = KJUR.crypto.Cipher.decrypt(hex, pem);
      document.getElementById('rsaOutput').textContent = dec;
    } catch(e){ document.getElementById('rsaOutput').textContent = 'RSA decrypt failed'; }
  });

  document.getElementById('rsaCopyOut').addEventListener('click', ()=> copyText('rsaOutput'));

  /******************************************************************
   * Symmetric text encryption (CryptoJS)
   ******************************************************************/
  function symEncrypt(alg, text, pass){
    switch(alg){
      case 'AES':
        const salt = CryptoJS.lib.WordArray.random(128/8);
        const iv = CryptoJS.lib.WordArray.random(128/8);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:200000 });
        const enc = CryptoJS.AES.encrypt(text, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        return JSON.stringify({ algo:'AES-CBC-CryptoJS', salt:CryptoJS.enc.Base64.stringify(salt), iv:CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext:CryptoJS.enc.Base64.stringify(enc.ciphertext) });
      case 'DES':
        const keydes = CryptoJS.PBKDF2(pass, CryptoJS.lib.WordArray.random(64/8), { keySize:64/32, iterations:10000 });
        return CryptoJS.DES.encrypt(text, keydes, { mode: CryptoJS.mode.ECB, padding: CryptoJS.pad.Pkcs7 }).toString();
      case 'TripleDES':
        const key3 = CryptoJS.PBKDF2(pass, CryptoJS.lib.WordArray.random(64/8), { keySize:192/32, iterations:10000 });
        return CryptoJS.TripleDES.encrypt(text, key3, { mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).toString();
      case 'RC4': return CryptoJS.RC4.encrypt(text, pass).toString();
      case 'Rabbit': return CryptoJS.Rabbit.encrypt(text, pass).toString();
      default: throw 'Unsupported algorithm';
    }
  }

  function symDecrypt(payload, alg, pass){
    try{
      if(alg === 'AES'){
        const p = JSON.parse(payload);
        if(p.algo !== 'AES-CBC-CryptoJS') return 'Invalid AES payload';
        const salt = CryptoJS.enc.Base64.parse(p.salt);
        const iv = CryptoJS.enc.Base64.parse(p.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations: p.iterations || 200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(p.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        return dec.toString(CryptoJS.enc.Utf8) || 'AES decryption failed';
      } else if(alg === 'DES'){
        const dec = CryptoJS.DES.decrypt(payload, CryptoJS.enc.Utf8.parse(pass), { mode: CryptoJS.mode.ECB, padding: CryptoJS.pad.Pkcs7 });
        return dec.toString(CryptoJS.enc.Utf8) || 'DES decryption failed';
      } else if(alg === 'TripleDES'){
        const dec = CryptoJS.TripleDES.decrypt(payload, CryptoJS.enc.Utf8.parse(pass));
        return dec.toString(CryptoJS.enc.Utf8) || '3DES decryption failed';
      } else if(alg === 'RC4'){
        const dec = CryptoJS.RC4.decrypt(payload, pass); return dec.toString(CryptoJS.enc.Utf8) || 'RC4 decryption failed';
      } else if(alg === 'Rabbit'){
        const dec = CryptoJS.Rabbit.decrypt(payload, pass); return dec.toString(CryptoJS.enc.Utf8) || 'Rabbit decryption failed';
      } else return 'Unsupported algorithm';
    } catch(e){ return 'Symmetric decryption error'; }
  }

  document.getElementById('symEncBtn').addEventListener('click', ()=>{
    const alg = document.getElementById('symAlgo').value;
    const pass = document.getElementById('symPass').value || ''; if(!pass) return alert('Enter passphrase');
    const text = document.getElementById('plainText').value || '';
    try{
      const out = symEncrypt(alg, text, pass);
      document.getElementById('symOutput').textContent = out;
    } catch(e){ alert('Encrypt failed: ' + e); }
  });

  document.getElementById('symDecBtn').addEventListener('click', ()=>{
    const alg = document.getElementById('symAlgo').value;
    const pass = document.getElementById('symPass').value || ''; if(!pass) return alert('Enter passphrase');
    const payload = document.getElementById('symOutput').textContent || '';
    const dec = symDecrypt(payload, alg, pass);
    document.getElementById('symOutput').textContent = dec;
  });

  /******************************************************************
   * Stego (LSB) with AES payload (kept functional)
   ******************************************************************/
  const stegCanvas = document.getElementById('stegCanvas'), stegCtx = stegCanvas.getContext('2d');
  let coverImg = null;
  document.getElementById('coverImage').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const img = new Image();
    img.onload = ()=> { stegCanvas.width = img.width; stegCanvas.height = img.height; stegCtx.drawImage(img,0,0); coverImg = img; document.getElementById('stegStatus').textContent='Cover loaded'; };
    img.src = URL.createObjectURL(f);
  });

  function strToBits(s){ const bytes = new TextEncoder().encode(s); const bits=[]; for(const b of bytes) for(let i=7;i>=0;i--) bits.push((b>>i)&1); return bits; }
  function bitsToStr(bits){ const bytes=[]; for(let i=0;i<bits.length;i+=8){ let v=0; for(let j=0;j<8 && (i+j)<bits.length;j++) v=(v<<1)|bits[i+j]; bytes.push(v);} return new TextDecoder().decode(new Uint8Array(bytes)); }

  document.getElementById('stegHide').addEventListener('click', ()=>{
    if(!coverImg){ document.getElementById('stegStatus').textContent='Upload cover'; return; }
    const msg = document.getElementById('stegMessage').value || '';
    const pass = document.getElementById('stegPass').value || ''; if(!pass){ document.getElementById('stegStatus').textContent='Enter password'; return; }
    const salt = CryptoJS.lib.WordArray.random(128/8);
    const iv = CryptoJS.lib.WordArray.random(128/8);
    const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:200000 });
    const ct = CryptoJS.AES.encrypt(msg, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).ciphertext;
    const payload = JSON.stringify({ salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(ct) });
    const b64 = btoa(payload);
    const bits = strToBits(b64);

    stegCtx.drawImage(coverImg, 0, 0);
    const imgd = stegCtx.getImageData(0,0,stegCanvas.width,stegCanvas.height);
    const px = imgd.data;
    const capacity = Math.floor(px.length/4) * 3;
    if(bits.length + 32 > capacity){ document.getElementById('stegStatus').textContent='Message too large'; return; }
    const lenBits = []; const len = bits.length;
    for(let i=31;i>=0;i--) lenBits.push((len>>i)&1);
    const all = lenBits.concat(bits);
    let bi=0;
    for(let i=0;i<px.length && bi<all.length;i+=4){
      for(let c=0;c<3 && bi<all.length;c++){
        px[i+c] = (px[i+c] & 0xFE) | all[bi++];
      }
    }
    stegCtx.putImageData(imgd,0,0);
    document.getElementById('stegStatus').textContent='Hidden — preview ready';
    document.getElementById('stegDownloadBtn').disabled = false;
    document.getElementById('stegDownloadBtn').onclick = ()=> stegCanvas.toBlob(b => { const url=URL.createObjectURL(b); const a=document.createElement('a'); a.href=url; a.download='stego.png'; a.click(); URL.revokeObjectURL(url); }, 'image/png');
  });

  document.getElementById('stegReveal').addEventListener('click', ()=>{
    const f = document.getElementById('stegUpload').files[0]; if(!f){ document.getElementById('stegStatus').textContent='Upload stego image'; return; }
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement('canvas'); c.width=img.width; c.height=img.height; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
      const imgd = ctx.getImageData(0,0,c.width,c.height); const px = imgd.data;
      const bits=[];
      for(let i=0;i<px.length;i+=4){ bits.push(px[i]&1); bits.push(px[i+1]&1); bits.push(px[i+2]&1); }
      const lenBits = bits.slice(0,32); let len=0; for(let i=0;i<32;i++) len=(len<<1)|lenBits[i];
      const payloadBits = bits.slice(32,32+len);
      const b64 = bitsToStr(payloadBits);
      try{
        const payload = JSON.parse(atob(b64));
        const pass = document.getElementById('stegPass').value || ''; if(!pass){ document.getElementById('stegStatus').textContent='Enter pass'; return; }
        const salt = CryptoJS.enc.Base64.parse(payload.salt); const iv = CryptoJS.enc.Base64.parse(payload.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations: payload.iterations || 200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const out = dec.toString(CryptoJS.enc.Utf8);
        if(!out) throw 'decrypt-empty';
        document.getElementById('stegStatus').textContent = 'Revealed: ' + out;
        document.getElementById('stegAttempts').textContent = 0;
      } catch(e){
        document.getElementById('stegAttempts').textContent = (+document.getElementById('stegAttempts').textContent||0)+1;
        document.getElementById('stegStatus').textContent = 'Reveal failed (wrong pass or corrupted)';
      }
    };
    img.src = URL.createObjectURL(f);
  });

  /******************************************************************
   * Morse encode / decode
   ******************************************************************/
  const morseMap = {
    'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---',
    'K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-',
    'U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..',
    '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
    '.':'.-.-.-',',':'--..--','?':'..--..','!':'-.-.--','/':'-..-.','(':'-.--.',')':'-.--.-','&':'.-...',
    ':':'---...',';':'-.-.-.','=':'-...-','+':'.-.-.','-':'-....-','_':'..--.-','"':'.-..-.','$':'...-..-','@':'.--.-.',
    '#':'......','*':'-..-.-'
  };
  const revMorse = {}; for(const k in morseMap) revMorse[morseMap[k]] = k;
  function morseEncode(s){ return s.toUpperCase().split('').map(ch => ch===' ' ? '/' : (morseMap[ch]||'?')).join(' '); }
  function morseDecode(s){ return s.split(' ').map(t => t==='/' ? ' ' : (revMorse[t]||'?')).join(''); }
  document.getElementById('morseEnc').addEventListener('click', ()=> document.getElementById('morseOut').textContent = morseEncode(document.getElementById('morseIn').value || ''));
  document.getElementById('morseDec').addEventListener('click', ()=> document.getElementById('morseOut').textContent = morseDecode(document.getElementById('morseIn').value || ''));

  /******************************************************************
   * Notes about HAVAL-256:
   * - HAVAL is not included by default. If you want HAVAL-256 support
   *   in the browser, add a HAVAL JS implementation and expose:
   *     window.haval256 = function(str){ return '...hex...'; }
   *   (the code above will call window.haval256 when present)
   ******************************************************************/

  // End of script
  </script>
</body>
</html>