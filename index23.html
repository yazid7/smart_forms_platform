<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Toolbox — Final</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CryptoJS (core, md5, sha256, sha3) -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/md5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha256.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha3.js"></script>

  <!-- jsrsasign (for RSA generation/import/export) -->
  <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.5.23/lib/jsrsasign-all-min.js"></script>

  <style>
    :root{
      --bg:#f8f9fa; --card:#ffffff; --muted:#6c757d; --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f1724; --muted:#9aa6bf; color-scheme: dark;
    }
    body{ background:var(--bg); padding:16px; color:var(--muted); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card{ background:var(--card); color:inherit; }
    .monos{ font-family:var(--mono); color:inherit; }
    .cipher-output{ white-space:pre-wrap; word-break:break-word; color:inherit; }
    footer small{ color:var(--muted); }
    .theme-toggle{ cursor:pointer; }
  </style>
</head>
<body data-theme="light">
  <div class="container-fluid">
    <header class="d-flex align-items-center mb-3">
      <h1 class="h4 me-3">Crypto Toolbox — Final (single file)</h1>
      <div class="ms-auto d-flex align-items-center gap-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="darkMode">
          <label class="form-check-label" for="darkMode">Dark mode</label>
        </div>
        <small class="text-muted">Client-side demo • CryptoJS + jsrsasign</small>
      </div>
    </header>

    <nav class="nav nav-pills flex-column flex-sm-row mb-3">
      <a class="nav-link active" href="#gen">Generators</a>
      <a class="nav-link" href="#file">File Encrypt</a>
      <a class="nav-link" href="#keys">Keys (RSA)</a>
      <a class="nav-link" href="#text">Text & Hash</a>
      <a class="nav-link" href="#steg">Stego (Image)</a>
      <a class="nav-link" href="#algos">Algorithms</a>
      <a class="nav-link" href="#morse">Morse</a>
    </nav>

    <!-- Generators -->
    <section id="gen" class="card mb-3 section-card">
      <div class="card-body">
        <h5>Generators & Passwords</h5>
        <div class="row">
          <div class="col-lg-6">
            <label>Length: <span id="pwLenLabel">16</span></label>
            <input id="pwLen" type="range" min="4" max="128" value="16" class="form-range">
            <div class="row g-2 mb-2">
              <div class="col"><label>Letters</label><input id="pwLetters" type="number" min="0" value="8" class="form-control"></div>
              <div class="col"><label>Numbers</label><input id="pwNums" type="number" min="0" value="4" class="form-control"></div>
              <div class="col"><label>Symbols</label><input id="pwSyms" type="number" min="0" value="4" class="form-control"></div>
            </div>
            <div class="mb-2">
              <div class="form-check form-check-inline"><input id="incLower" class="form-check-input" type="checkbox" checked><label class="form-check-label">lower</label></div>
              <div class="form-check form-check-inline"><input id="incUpper" class="form-check-input" type="checkbox" checked><label class="form-check-label">UPPER</label></div>
              <div class="form-check form-check-inline"><input id="incNum" class="form-check-input" type="checkbox" checked><label class="form-check-label">digits</label></div>
              <div class="form-check form-check-inline"><input id="incSym" class="form-check-input" type="checkbox" checked><label class="form-check-label">symbols</label></div>
            </div>
            <div class="d-flex gap-2 mb-2">
              <button id="genPw" class="btn btn-primary btn-sm">Generate</button>
              <button id="copyPw" class="btn btn-outline-secondary btn-sm">Copy</button>
              <button id="savePw" class="btn btn-success btn-sm">Save</button>
              <button id="sortPw" class="btn btn-info btn-sm">Sort</button>
              <button id="clearPw" class="btn btn-danger btn-sm">Clear saved</button>
            </div>
            <div><label>Output</label><div id="pwOut" class="p-2 border rounded monos"></div></div>
            <div class="mt-2"><div class="progress" style="height:10px"><div id="pwBar" class="progress-bar" style="width:0%"></div></div><small id="pwInfo" class="text-muted"></small></div>
            <ul id="pwList" class="list-group mt-2"></ul>
          </div>

          <div class="col-lg-6">
            <h6>OTP (simulated)</h6>
            <label>Length</label>
            <input id="otpLen" type="number" class="form-control mb-2" value="6" min="4" max="10">
            <div class="d-flex gap-2 mb-2">
              <button id="otpPhone" class="btn btn-warning btn-sm">Phone OTP</button>
              <button id="otpEmail" class="btn btn-warning btn-sm">Email OTP</button>
            </div>
            <div id="otpOut" class="monos"></div>

            <hr>
            <h6>Identity generator</h6>
            <label>Count</label>
            <input id="idCount" type="number" class="form-control mb-2" value="5" min="1" max="100">
            <div class="d-flex gap-2 mb-2">
              <button id="genNames" class="btn btn-secondary btn-sm">Names</button>
              <button id="genEmails" class="btn btn-secondary btn-sm">Emails</button>
              <button id="genPhrases" class="btn btn-secondary btn-sm">Phrases</button>
            </div>
            <ul id="idList" class="list-group"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- File encryption -->
    <section id="file" class="card mb-3 section-card">
      <div class="card-body">
        <h5>File encryption / decryption (AES-CBC via CryptoJS)</h5>
        <div class="row g-2">
          <div class="col-md-4"><label>Pick file</label><input id="fileIn" type="file" class="form-control"></div>
          <div class="col-md-4"><label>Passphrase</label><input id="filePass" type="password" class="form-control" placeholder="passphrase"></div>
          <div class="col-md-4 d-flex align-items-end gap-2">
            <button id="fileEncrypt" class="btn btn-primary btn-sm">Encrypt & Download</button>
            <input id="encUpload" type="file" accept=".enc" class="form-control form-control-sm">
            <button id="fileDecrypt" class="btn btn-success btn-sm">Decrypt uploaded</button>
          </div>

          <div class="col-12 mt-2">
            <div>File status: <span id="fileStatus" class="monos">Idle</span> &nbsp; Attempts: <span id="fileAttempts">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Keys (RSA) -->
    <section id="keys" class="card mb-3 section-card">
      <div class="card-body">
        <h5>RSA Keys — generate / import / export / encrypt / decrypt</h5>
        <div class="row g-2">
          <div class="col-md-2"><label>Size</label><select id="rsaSize" class="form-select"><option>2048</option><option>3072</option><option>4096</option></select></div>
          <div class="col-md-4 d-flex align-items-end gap-2">
            <button id="rsaGen" class="btn btn-primary btn-sm">Generate</button>
            <button id="rsaExportPub" class="btn btn-outline-secondary btn-sm">Export Pub</button>
            <button id="rsaExportPriv" class="btn btn-outline-secondary btn-sm">Export Priv</button>
            <button id="rsaClear" class="btn btn-danger btn-sm">Clear</button>
          </div>
          <div class="col-md-6 d-flex align-items-end gap-2">
            <input id="rsaImportPubFile" type="file" accept=".pem" class="form-control form-control-sm">
            <input id="rsaImportPrivFile" type="file" accept=".pem" class="form-control form-control-sm">
            <button id="rsaImportPub" class="btn btn-secondary btn-sm">Import Pub</button>
            <button id="rsaImportPriv" class="btn btn-secondary btn-sm">Import Priv</button>
          </div>

          <div class="col-12 mt-2">
            <label>Message</label>
            <textarea id="rsaMsg" class="form-control" rows="3"></textarea>
            <div class="mt-2 d-flex gap-2">
              <button id="rsaEnc" class="btn btn-outline-primary btn-sm">Encrypt (pub)</button>
              <button id="rsaDec" class="btn btn-outline-success btn-sm">Decrypt (priv)</button>
              <button id="rsaCopy" class="btn btn-outline-secondary btn-sm">Copy output</button>
            </div>
            <div class="mt-2">
              <label>Output</label>
              <div id="rsaOut" class="p-2 border monos cipher-output"></div>
            </div>
            <div class="mt-2">Key status: <span id="rsaStatus">no key</span> — Attempts: <span id="rsaAttempts">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Text & Hash -->
    <section id="text" class="card mb-3 section-card">
      <div class="card-body">
        <h5>Text encryption, hashes & fingerprint comparison</h5>
        <div class="row g-3">
          <div class="col-lg-6">
            <label>Input</label>
            <textarea id="textIn" class="form-control" rows="6"></textarea>

            <div class="mt-2 d-flex gap-2 flex-wrap">
              <button id="caesarEnc" class="btn btn-sm btn-outline-primary">Caesar Enc</button>
              <button id="caesarDec" class="btn btn-sm btn-outline-secondary">Caesar Dec</button>
              <input id="caesarShift" type="number" class="form-control form-control-sm" style="width:90px" value="3">

              <button id="vigEnc" class="btn btn-sm btn-outline-primary">Vigenère Enc</button>
              <button id="vigDec" class="btn btn-sm btn-outline-secondary">Vigenère Dec</button>
              <input id="vigKey" type="text" class="form-control form-control-sm" style="width:120px" value="KEY">

              <button id="xorEnc" class="btn btn-sm btn-outline-primary">XOR Enc (b64)</button>
              <button id="xorDec" class="btn btn-sm btn-outline-secondary">XOR Dec</button>
              <input id="xorKey" type="text" class="form-control form-control-sm" style="width:120px" value="secret">
            </div>

            <hr>
            <div class="d-flex gap-2">
              <button id="md5Btn" class="btn btn-outline-secondary btn-sm">MD5</button>
              <button id="sha256Btn" class="btn btn-outline-secondary btn-sm">SHA-256</button>
              <button id="sha3Btn" class="btn btn-outline-secondary btn-sm">SHA3-512</button>
              <button id="compareBtn" class="btn btn-primary btn-sm">Compare fingerprints</button>
            </div>

            <div class="mt-2"><label>Hashes</label><div id="hashOut" class="p-2 border monos cipher-output"></div></div>
          </div>

          <div class="col-lg-6">
            <label>AES encrypt (text) — passphrase</label>
            <input id="aesPass" class="form-control mb-2" placeholder="enter passphrase">
            <div class="d-flex gap-2 mb-2">
              <select id="aesMode" class="form-select form-select-sm" style="width:160px"><option value="CBC">AES-CBC (CryptoJS)</option><option value="GCM">AES-GCM (SubtleCrypto)</option></select>
              <button id="aesEnc" class="btn btn-outline-primary btn-sm">Encrypt</button>
              <button id="aesDec" class="btn btn-outline-success btn-sm">Decrypt</button>
            </div>

            <div><label>Output</label><div id="textOut" class="p-2 border monos cipher-output" style="min-height:200px"></div></div>
            <div class="mt-2 d-flex gap-2">
              <button id="copyTextOut" class="btn btn-sm btn-outline-secondary">Copy</button>
              <button id="saveTextOut" class="btn btn-sm btn-success">Save</button>
              <button id="clearTextSaved" class="btn btn-sm btn-danger">Clear saved</button>
            </div>
            <ul id="textSaved" class="list-group mt-2"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Steganography -->
    <section id="steg" class="card mb-3 section-card">
      <div class="card-body">
        <h5>Image Steganography (LSB) — AES-protected payload</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <label>Cover image</label><input id="coverFile" type="file" accept="image/*" class="form-control mb-2">
            <label>Message to hide</label><textarea id="stegMsg" class="form-control mb-2" rows="4"></textarea>
            <label>Password (protect hidden data)</label><input id="stegPass" class="form-control mb-2" placeholder="password">
            <div class="d-flex gap-2 mb-2">
              <button id="stegHide" class="btn btn-primary btn-sm">Hide & Download PNG</button>
              <input id="stegUpload" type="file" accept="image/*" class="form-control form-control-sm">
              <button id="stegReveal" class="btn btn-success btn-sm">Reveal (upload)</button>
            </div>
            <div>Stego status: <span id="stegStatus">Idle</span> — Attempts: <span id="stegAttempts">0</span></div>
          </div>

          <div class="col-md-6">
            <label>Preview</label>
            <canvas id="stegCanvas" class="border" style="max-width:100%"></canvas>
            <div class="mt-2"><button id="downloadSteg" class="btn btn-outline-secondary btn-sm">Download current canvas</button></div>
            <small class="text-muted">Hidden payload is AES-encrypted (PBKDF2+CBC) then base64 embedded with LSB. Use strong password.</small>
          </div>
        </div>
      </div>
    </section>

    <!-- Algorithms & explanations -->
    <section id="algos" class="card mb-3 section-card">
      <div class="card-body">
        <h5>Algorithms & Notes</h5>
        <div class="accordion" id="algAcc">
          <div class="accordion-item">
            <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#al1">AES (symmetric)</button></h2>
            <div id="al1" class="accordion-collapse collapse show" data-bs-parent="#algAcc"><div class="accordion-body">AES-CBC used via CryptoJS (not authenticated). For authenticated encryption use AES-GCM (SubtleCrypto) or libs supporting AEAD. Derive keys with PBKDF2 or Argon2.</div></div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#al2">RSA-OAEP (asymmetric)</button></h2>
            <div id="al2" class="accordion-collapse collapse" data-bs-parent="#algAcc"><div class="accordion-body">RSA encrypts small payloads. Typical pattern: encrypt data with symmetric AES key, encrypt AES key with RSA public key.</div></div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#al3">Classical ciphers</button></h2>
            <div id="al3" class="accordion-collapse collapse" data-bs-parent="#algAcc"><div class="accordion-body">Caesar (shift): P = (C - k) mod 26. Vigenère: polyalphabetic repeating key. XOR: stream XOR; secure only with one-time random key.</div></div>
          </div>
        </div>

        <hr>
        <h6>Password leak check helper (k-anonymity)</h6>
        <div class="row g-2">
          <div class="col-md-6"><input id="leakPass" class="form-control" placeholder="password to locally hash"></div>
          <div class="col-md-6 d-flex gap-2"><button id="leakBtn" class="btn btn-outline-primary btn-sm">Compute SHA-1 prefix</button><div class="monos" id="leakOut"></div></div>
        </div>
      </div>
    </section>

    <!-- Morse -->
    <section id="morse" class="card mb-3 section-card">
      <div class="card-body">
        <h5>Morse (table + encode/decode)</h5>
        <div class="row g-2">
          <div class="col-md-6"><textarea id="morseIn" class="form-control" rows="4"></textarea><div class="d-flex gap-2 mt-2"><button id="morseEnc" class="btn btn-sm btn-outline-primary">Encode</button><button id="morseDec" class="btn btn-sm btn-outline-secondary">Decode</button></div></div>
          <div class="col-md-6"><div id="morseOut" class="p-2 border monos cipher-output" style="min-height:120px"></div></div>
        </div>
        <hr>
        <div style="max-height:220px; overflow:auto"><table class="table table-sm table-bordered"><thead><tr><th>Char</th><th>Morse</th><th>Char</th><th>Morse</th></tr></thead><tbody id="morseTable"></tbody></table></div>
      </div>
    </section>

    <footer class="mt-4 mb-5 text-center"><small>Educational prototype — not a production-grade secure system. Use HTTPS for real key ops and server-side protections for OTP & leak checks.</small></footer>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ---------- Utilities ----------
  function rngInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function copyText(text){ navigator.clipboard?.writeText(text).catch(()=>{}); }
  function bytesToBase64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
  function base64ToBytes(b64){ const bin = atob(b64); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr; }

  // ---------- Theme toggle ----------
  const darkToggle = document.getElementById('darkMode');
  darkToggle.addEventListener('change', ()=>{
    document.body.setAttribute('data-theme', darkToggle.checked ? 'dark' : 'light');
  });

  // ---------- NAV active link handling ----------
  document.querySelectorAll('nav a').forEach(a=>{
    a.addEventListener('click', ()=>{
      document.querySelectorAll('nav a').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
    });
  });

  // ---------- PASSWORD GENERATOR ----------
  const pwLenEl = document.getElementById('pwLen'), pwLenLabel = document.getElementById('pwLenLabel');
  const pwOut = document.getElementById('pwOut'), pwBar = document.getElementById('pwBar'), pwInfo = document.getElementById('pwInfo');
  const pwList = document.getElementById('pwList');

  pwLenEl.addEventListener('input', ()=> pwLenLabel.textContent = pwLenEl.value);

  document.getElementById('genPw').addEventListener('click', ()=>{
    const L = +pwLenEl.value;
    let letters = +document.getElementById('pwLetters').value;
    let nums = +document.getElementById('pwNums').value;
    let syms = +document.getElementById('pwSyms').value;
    const lower = document.getElementById('incLower').checked;
    const upper = document.getElementById('incUpper').checked;
    const numbers = document.getElementById('incNum').checked;
    const symbols = document.getElementById('incSym').checked;

    let poolLetters = '';
    if(lower) poolLetters += 'abcdefghijklmnopqrstuvwxyz';
    if(upper) poolLetters += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const poolNums = '0123456789';
    const poolSyms = '!@#$%^&*()-_=+[]{};:,.<>?/|`~';

    // normalize counts
    let sum = letters+nums+syms;
    if(sum > L){
      const factor = L / sum;
      letters = Math.max(0, Math.floor(letters*factor));
      nums = Math.max(0, Math.floor(nums*factor));
      syms = Math.max(0, Math.floor(syms*factor));
    }
    let rem = L - (letters+nums+syms);
    letters += rem;

    const arr = [];
    for(let i=0;i<letters;i++) arr.push(poolLetters.charAt(rngInt(0, poolLetters.length-1)) || poolNums.charAt(rngInt(0,9)));
    for(let i=0;i<nums;i++) arr.push(poolNums.charAt(rngInt(0, poolNums.length-1)));
    for(let i=0;i<syms;i++) arr.push(poolSyms.charAt(rngInt(0, poolSyms.length-1)));
    // shuffle
    for(let i=arr.length-1;i>0;i--){ const j=rngInt(0,i); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    const p = arr.join('');
    pwOut.textContent = p;
    updatePwStrength(p);
  });

  document.getElementById('copyPw').addEventListener('click', ()=> copyText(pwOut.textContent));
  document.getElementById('savePw').addEventListener('click', ()=>{
    const v = pwOut.textContent; if(!v) return;
    const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center monos';
    li.innerHTML = `<span>${v}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button> <button class="btn btn-sm btn-danger del">Del</button></div>`;
    li.querySelector('.copy').addEventListener('click', ()=> copyText(v));
    li.querySelector('.del').addEventListener('click', ()=> li.remove());
    pwList.prepend(li);
  });
  document.getElementById('sortPw').addEventListener('click', ()=>{
    const items = [...pwList.querySelectorAll('li')].map(li=>li.firstElementChild.textContent);
    items.sort();
    pwList.innerHTML = ''; items.forEach(v=>{ const li=document.createElement('li'); li.className='list-group-item monos'; li.textContent=v; pwList.appendChild(li); });
  });
  document.getElementById('clearPw').addEventListener('click', ()=> pwList.innerHTML='');
  document.getElementById('clearPw').addEventListener || document.getElementById('clearPw').addEventListener('click', ()=> pwList.innerHTML='');
  document.querySelector('#clearPw')?.addEventListener('click', ()=> pwList.innerHTML='');

  function entropyBits(pw){
    let charset = 0;
    if(/[a-z]/.test(pw)) charset += 26;
    if(/[A-Z]/.test(pw)) charset += 26;
    if(/[0-9]/.test(pw)) charset += 10;
    if(/[^A-Za-z0-9]/.test(pw)) charset += 32;
    if(charset===0) charset=1;
    return Math.log2(Math.pow(charset, pw.length)) || 0;
  }
  function updatePwStrength(pw){
    const bits = Math.round(entropyBits(pw));
    const pct = Math.min(100, bits);
    pwBar.style.width = pct + '%';
    pwBar.textContent = bits + ' bits';
    // brute-force estimate at 1e9 g/s
    const guesses = Math.pow(2, bits);
    const seconds = guesses / 1e9;
    let human = '>> centuries';
    if(Number.isFinite(seconds)){
      if(seconds < 60) human = `${Math.round(seconds)}s`;
      else if(seconds < 3600) human = `${Math.round(seconds/60)}m`;
      else if(seconds < 86400) human = `${Math.round(seconds/3600)}h`;
      else if(seconds < 31536000) human = `${Math.round(seconds/86400)}d`;
      else human = `${Math.round(seconds/31536000)}y`;
    }
    pwInfo.textContent = `Estimated brute force (1e9 g/s): ${human} (${bits} bits)`;
  }

  // IDENTITY generator
  const names = ['Amina','Youssef','Khaled','Nadia','Sofia','Karim','Layla','Ibrahim','Sara','Rami','Hajar','Mounir','Omar','Yasmin'];
  document.getElementById('genNames').addEventListener('click', ()=>{
    const c = Math.min(100, Math.max(1, +document.getElementById('idCount').value));
    const ul = document.getElementById('idList'); ul.innerHTML='';
    for(let i=0;i<c;i++){
      const n = names[rngInt(0,names.length-1)] + rngInt(1,999);
      const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `<span>${n}</span><button class="btn btn-sm btn-outline-secondary copy">Copy</button>`;
      li.querySelector('.copy').addEventListener('click', ()=> copyText(n));
      ul.appendChild(li);
    }
  });
  document.getElementById('genEmails').addEventListener('click', ()=>{
    const c = Math.min(100, Math.max(1, +document.getElementById('idCount').value));
    const doms = ['example.com','mail.example','service.example'];
    const ul = document.getElementById('idList'); ul.innerHTML='';
    for(let i=0;i<c;i++){
      const e = names[rngInt(0,names.length-1)].toLowerCase()+rngInt(1,999)+'@'+doms[rngInt(0,doms.length-1)];
      const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `<span>${e}</span><button class="btn btn-sm btn-outline-secondary copy">Copy</button>`;
      li.querySelector('.copy').addEventListener('click', ()=> copyText(e));
      ul.appendChild(li);
    }
  });
  document.getElementById('genPhrases').addEventListener('click', ()=>{
    const words = ['ocean','secret','sun','river','mountain','coffee','kite','crypto','dream','lamp'];
    const c = Math.min(100, Math.max(1, +document.getElementById('idCount').value));
    const ul = document.getElementById('idList'); ul.innerHTML='';
    for(let i=0;i<c;i++){
      const p = Array.from({length:4}, ()=>words[rngInt(0,words.length-1)]).join(' ');
      const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `<span>${p}</span><button class="btn btn-sm btn-outline-secondary copy">Copy</button>`;
      li.querySelector('.copy').addEventListener('click', ()=> copyText(p));
      ul.appendChild(li);
    }
  });

  // OTP simulator
  document.getElementById('otpPhone').addEventListener('click', ()=> {
    const l = Math.max(4, +document.getElementById('otpLen').value);
    const code = Array.from({length:l}).map(()=>rngInt(0,9)).join('');
    const s = `Phone OTP (simulated): ${code} (local only)`;
    document.getElementById('otpOut').textContent = s;
    copyText(code);
  });
  document.getElementById('otpEmail').addEventListener('click', ()=> {
    const l = Math.max(4, +document.getElementById('otpLen').value);
    const code = Array.from({length:l}).map(()=>rngInt(0,9)).join('');
    const s = `Email OTP (simulated): ${code} (local only)`;
    document.getElementById('otpOut').textContent = s;
    copyText(code);
  });

  // ---------- FILE encryption (CryptoJS AES-CBC) ----------
  let fileFail = 0;
  document.getElementById('fileEncrypt').addEventListener('click', async ()=>{
    const f = document.getElementById('fileIn').files[0];
    const pass = document.getElementById('filePass').value;
    const status = document.getElementById('fileStatus'), attempts = document.getElementById('fileAttempts');
    if(!f || !pass){ status.textContent = 'Select file and passphrase'; return; }
    status.textContent = 'Encrypting...';
    const ab = await f.arrayBuffer();
    const wa = CryptoJS.lib.WordArray.create(new Uint8Array(ab));
    const salt = CryptoJS.lib.WordArray.random(128/8);
    const iv = CryptoJS.lib.WordArray.random(128/8);
    const key = CryptoJS.PBKDF2(pass, salt, { keySize: 256/32, iterations: 200000 });
    const encryptedWA = CryptoJS.AES.encrypt(wa, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).ciphertext;
    const payload = {
      filename: f.name,
      salt: CryptoJS.enc.Base64.stringify(salt),
      iv: CryptoJS.enc.Base64.stringify(iv),
      iterations: 200000,
      algo: 'AES-CBC-CryptoJS',
      ciphertext: CryptoJS.enc.Base64.stringify(encryptedWA)
    };
    const blob = new Blob([JSON.stringify(payload)], {type:'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = f.name + '.enc'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    status.textContent = 'Encrypted and downloaded.';
  });

  document.getElementById('fileDecrypt').addEventListener('click', async ()=>{
    const f = document.getElementById('encUpload').files[0];
    const pass = document.getElementById('filePass').value;
    const status = document.getElementById('fileStatus'), attempts = document.getElementById('fileAttempts');
    if(!f || !pass){ status.textContent = 'Upload .enc and enter passphrase'; return; }
    status.textContent = 'Decrypting...';
    try{
      const txt = await f.text();
      const payload = JSON.parse(txt);
      const salt = CryptoJS.enc.Base64.parse(payload.salt);
      const iv = CryptoJS.enc.Base64.parse(payload.iv);
      const key = CryptoJS.PBKDF2(pass, salt, { keySize: 256/32, iterations: payload.iterations || 200000 });
      const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
      const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
      const arr = new Uint8Array(dec.sigBytes);
      for(let i=0;i<dec.sigBytes;i++) arr[i] = (dec.words[i>>>2] >>> (24 - (i%4)*8)) & 0xFF;
      const blob = new Blob([arr], {type:'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = payload.filename || 'decrypted.bin'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      status.textContent = 'Decrypted and downloaded.';
      fileFail = 0; attempts.textContent = fileFail;
    } catch(e){
      fileFail++; attempts.textContent = fileFail;
      status.textContent = 'Decryption failed (wrong pass or corrupted).';
    }
  });

  // ---------- RSA with jsrsasign ----------
  let rsaKeyObj = { pub:null, priv:null };
  let rsaFail = 0;
  const rsaStatus = document.getElementById('rsaStatus'), rsaAttempts = document.getElementById('rsaAttempts');

  function exportPemPublic(hexPub){
    // hexPub is hex of SubjectPublicKeyInfo (SPKI)
    const b64 = KJUR.crypto.Util.hex2b64(hexPub);
    const chunk = b64.match(/.{1,64}/g).join('\n');
    return `-----BEGIN PUBLIC KEY-----\n${chunk}\n-----END PUBLIC KEY-----`;
  }
  function exportPemPrivate(hexPriv){
    const b64 = KJUR.crypto.Util.hex2b64(hexPriv);
    const chunk = b64.match(/.{1,64}/g).join('\n');
    return `-----BEGIN PRIVATE KEY-----\n${chunk}\n-----END PRIVATE KEY-----`;
  }

  document.getElementById('rsaGen').addEventListener('click', ()=>{
    const size = +document.getElementById('rsaSize').value;
    rsaStatus.textContent = 'Generating...';
    setTimeout(()=>{
      const rsakey = KEYUTIL.generateKeypair("RSA", size);
      rsaKeyObj.pub = rsakey.pubKeyObj;
      rsaKeyObj.priv = rsakey.prvKeyObj;
      rsaStatus.textContent = `RSA ${size} (in-memory)`;
      rsaAttempts.textContent = rsaFail;
    }, 50);
  });

  document.getElementById('rsaExportPub').addEventListener('click', ()=>{
    if(!rsaKeyObj.pub) return alert('No public key');
    const pem = KEYUTIL.getPEM(rsaKeyObj.pub);
    const blob = new Blob([pem], {type:'application/x-pem-file'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='public.pem'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  document.getElementById('rsaExportPriv').addEventListener('click', ()=>{
    if(!rsaKeyObj.priv) return alert('No private key');
    const pem = KEYUTIL.getPEM(rsaKeyObj.priv, "PKCS8PRV"); // pkcs8
    const blob = new Blob([pem], {type:'application/x-pem-file'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='private.pem'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // import public PEM
  document.getElementById('rsaImportPub').addEventListener('click', async ()=>{
    const f = document.getElementById('rsaImportPubFile').files[0]; if(!f) return alert('Choose public PEM file');
    const pem = await f.text();
    try{
      const key = KEYUTIL.getKey(pem);
      rsaKeyObj.pub = key;
      rsaStatus.textContent = 'Public key imported';
    } catch(e){ alert('Import failed: ' + e); }
  });
  // import private PEM
  document.getElementById('rsaImportPriv').addEventListener('click', async ()=>{
    const f = document.getElementById('rsaImportPrivFile').files[0]; if(!f) return alert('Choose private PEM file');
    const pem = await f.text();
    try{
      const key = KEYUTIL.getKey(pem);
      rsaKeyObj.priv = key;
      rsaStatus.textContent = 'Private key imported';
    } catch(e){ alert('Import failed: ' + e); }
  });

  document.getElementById('rsaClear').addEventListener('click', ()=> { rsaKeyObj={pub:null,priv:null}; rsaStatus.textContent='no key'; rsaFail=0; rsaAttempts.textContent=0; document.getElementById('rsaOut').textContent=''; });

  document.getElementById('rsaEnc').addEventListener('click', ()=>{
    const msg = document.getElementById('rsaMsg').value || '';
    if(!rsaKeyObj.pub) return alert('No public key');
    try{
      // use RSA-OAEP style via KJUR - we use RSAES-PKCS1v15 or raw RSA encrypt with RSAKey and do base64
      const pubpem = KEYUTIL.getPEM(rsaKeyObj.pub);
      const encrypt = KJUR.crypto.Cipher.encrypt(msg, pubpem);
      // encrypt returns hex; convert to base64
      const b64 = hextob64(encrypt);
      document.getElementById('rsaOut').textContent = b64;
    } catch(e){ alert('Encryption failed: ' + e); }
  });

  document.getElementById('rsaDec').addEventListener('click', ()=>{
    const b64 = document.getElementById('rsaOut').textContent.trim();
    if(!b64) return alert('No ciphertext');
    if(!rsaKeyObj.priv) return alert('No private key');
    try{
      const hex = b64tohex(b64);
      const dec = KJUR.crypto.Cipher.decrypt(hex, KEYUTIL.getPEM(rsaKeyObj.priv, "PKCS8PRV"));
      document.getElementById('rsaOut').textContent = dec;
      rsaFail = 0; rsaAttempts.textContent = rsaFail;
    } catch(e){
      rsaFail++; rsaAttempts.textContent = rsaFail;
      document.getElementById('rsaOut').textContent = 'Decryption failed (wrong key or data)';
    }
  });

  document.getElementById('rsaCopy').addEventListener('click', ()=> copyText(document.getElementById('rsaOut').textContent));

  // ---------- Text ciphers ----------
  function caesarEnc(s, shift){
    return s.replace(/[A-Za-z]/g, c=> {
      const base = c <= 'Z' ? 65 : 97;
      return String.fromCharCode((c.charCodeAt(0)-base + shift + 26) % 26 + base);
    });
  }
  function caesarDec(s, shift){ return caesarEnc(s, (26-shift)%26); }
  document.getElementById('caesarEnc').addEventListener('click', ()=> document.getElementById('textOut').textContent = caesarEnc(document.getElementById('textIn').value || '', +document.getElementById('caesarShift').value || 3));
  document.getElementById('caesarDec').addEventListener('click', ()=> document.getElementById('textOut').textContent = caesarDec(document.getElementById('textIn').value || '', +document.getElementById('caesarShift').value || 3));

  function vigenere(text, key, decrypt=false){
    if(!key) return text;
    let ki=0; const out=[];
    for(const ch of text){
      if(/[A-Za-z]/.test(ch)){
        const base = ch <= 'Z' ? 65 : 97;
        const k = key[ki % key.length].toUpperCase().charCodeAt(0) - 65;
        const shift = decrypt ? (26 - k) : k;
        out.push(String.fromCharCode((ch.charCodeAt(0)-base + shift) % 26 + base));
        ki++;
      } else out.push(ch);
    }
    return out.join('');
  }
  document.getElementById('vigEnc').addEventListener('click', ()=> document.getElementById('textOut').textContent = vigenere(document.getElementById('textIn').value || '', document.getElementById('vigKey').value || 'KEY', false));
  document.getElementById('vigDec').addEventListener('click', ()=> document.getElementById('textOut').textContent = vigenere(document.getElementById('textIn').value || '', document.getElementById('vigKey').value || 'KEY', true));

  function xorBase64(text, key){
    const t = new TextEncoder().encode(text);
    const k = new TextEncoder().encode(key);
    const out = new Uint8Array(t.length);
    for(let i=0;i<t.length;i++) out[i] = t[i] ^ k[i % k.length];
    return bytesToBase64(out);
  }
  function xorFromBase64(b64, key){
    const bin = base64ToBytes(b64);
    const k = new TextEncoder().encode(key);
    const out = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) out[i] = bin[i] ^ k[i % k.length];
    return new TextDecoder().decode(out);
  }
  document.getElementById('xorEnc').addEventListener('click', ()=> document.getElementById('textOut').textContent = xorBase64(document.getElementById('textIn').value || '', document.getElementById('xorKey').value || 'k'));
  document.getElementById('xorDec').addEventListener('click', ()=> {
    try{ document.getElementById('textOut').textContent = xorFromBase64(document.getElementById('textOut').textContent || '', document.getElementById('xorKey').value || 'k'); } catch(e){ document.getElementById('textOut').textContent = 'XOR decode failed'; }
  });

  // AES text (CryptoJS for CBC; SubtleCrypto for GCM)
  async function subtleAesEncryptGcm(plain, pass){
    const enc = new TextEncoder();
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt: salt, iterations: 200000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
    const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv: iv}, key, enc.encode(plain));
    return { salt: bytesToBase64(salt), iv: bytesToBase64(iv), ciphertext: bytesToBase64(ct), algo:'AES-GCM-Subtle', iterations:200000 };
  }
  async function subtleAesDecryptGcm(payload, pass){
    const enc = new TextEncoder(), dec = new TextDecoder();
    const salt = base64ToBytes(payload.salt);
    const iv = base64ToBytes(payload.iv);
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt: salt, iterations: payload.iterations || 200000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
    const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv: iv}, key, base64ToBytes(payload.ciphertext).buffer);
    return dec.decode(pt);
  }

  document.getElementById('aesEnc').addEventListener('click', async ()=>{
    const pass = document.getElementById('aesPass').value || '';
    if(!pass) return alert('Enter passphrase');
    const mode = document.getElementById('aesMode').value;
    const plain = document.getElementById('textIn').value || '';
    if(mode === 'CBC'){
      const salt = CryptoJS.lib.WordArray.random(128/8);
      const iv = CryptoJS.lib.WordArray.random(128/8);
      const key = CryptoJS.PBKDF2(pass, salt, { keySize: 256/32, iterations: 200000 });
      const enc = CryptoJS.AES.encrypt(plain, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
      const payload = { salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, algo:'AES-CBC-CryptoJS', ciphertext: CryptoJS.enc.Base64.stringify(enc.ciphertext) };
      document.getElementById('textOut').textContent = JSON.stringify(payload);
    } else {
      // GCM SubtleCrypto
      try{
        const payload = await subtleAesEncryptGcm(plain, pass);
        document.getElementById('textOut').textContent = JSON.stringify(payload);
      } catch(e){ alert('GCM encrypt failed: ' + e); }
    }
  });

  document.getElementById('aesDec').addEventListener('click', async ()=>{
    const pass = document.getElementById('aesPass').value || '';
    if(!pass) return alert('Enter passphrase');
    const outEl = document.getElementById('textOut');
    try{
      const payload = JSON.parse(outEl.textContent || '{}');
      if(payload.algo === 'AES-CBC-CryptoJS'){
        const salt = CryptoJS.enc.Base64.parse(payload.salt);
        const iv = CryptoJS.enc.Base64.parse(payload.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize: 256/32, iterations: payload.iterations || 200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const text = dec.toString(CryptoJS.enc.Utf8);
        if(!text) throw 'Decryption failed';
        outEl.textContent = text;
      } else if(payload.algo === 'AES-GCM-Subtle'){
        try{
          const msg = await subtleAesDecryptGcm(payload, pass);
          outEl.textContent = msg;
        } catch(e){ outEl.textContent = 'GCM decryption failed'; }
      } else outEl.textContent = 'Unknown payload';
    } catch(e){ outEl.textContent = 'AES decryption failed'; }
  });

  // Hashes
  document.getElementById('md5Btn').addEventListener('click', ()=> { const t = document.getElementById('textIn').value || ''; document.getElementById('hashOut').textContent = 'MD5: ' + CryptoJS.MD5(t).toString(CryptoJS.enc.Hex); });
  document.getElementById('sha256Btn').addEventListener('click', ()=> { const t = document.getElementById('textIn').value || ''; document.getElementById('hashOut').textContent = 'SHA-256: ' + CryptoJS.SHA256(t).toString(CryptoJS.enc.Hex); });
  document.getElementById('sha3Btn').addEventListener('click', ()=> { const t = document.getElementById('textIn').value || ''; document.getElementById('hashOut').textContent = 'SHA3-512: ' + CryptoJS.SHA3(t,{ outputLength: 512 }).toString(CryptoJS.enc.Hex); });
  document.getElementById('compareBtn').addEventListener('click', ()=> {
    const t = document.getElementById('textIn').value || '';
    const md5 = CryptoJS.MD5(t).toString(CryptoJS.enc.Hex);
    const sha256 = CryptoJS.SHA256(t).toString(CryptoJS.enc.Hex);
    const sha3 = CryptoJS.SHA3(t, { outputLength: 512 }).toString(CryptoJS.enc.Hex);
    document.getElementById('hashOut').textContent = `MD5: ${md5}\nSHA256: ${sha256}\nSHA3-512: ${sha3}`;
  });

  document.getElementById('copyTextOut').addEventListener('click', ()=> copyText(document.getElementById('textOut').textContent));
  document.getElementById('saveTextOut').addEventListener('click', ()=> {
    const v = document.getElementById('textOut').textContent; if(!v) return;
    const ul = document.getElementById('textSaved'); const li = document.createElement('li'); li.className='list-group-item monos d-flex justify-content-between align-items-center';
    li.innerHTML = `<span>${v}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button> <button class="btn btn-sm btn-danger del">Del</button></div>`;
    li.querySelector('.copy').addEventListener('click', ()=> copyText(v)); li.querySelector('.del').addEventListener('click', ()=> li.remove());
    ul.prepend(li);
  });
  document.getElementById('clearTextSaved').addEventListener('click', ()=> document.getElementById('textSaved').innerHTML='');

  // ---------- Steganography LSB with AES payload ----------
  const stegCanvas = document.getElementById('stegCanvas'), stegCtx = stegCanvas.getContext('2d');
  let coverImage = null, stegFail = 0;

  document.getElementById('coverFile').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const img = new Image();
    img.onload = ()=>{ stegCanvas.width = img.width; stegCanvas.height = img.height; stegCtx.drawImage(img,0,0); coverImage = img; };
    img.src = URL.createObjectURL(f);
  });

  function strToBits(s){
    const bytes = new TextEncoder().encode(s);
    const bits = [];
    for(const b of bytes) for(let i=7;i>=0;i--) bits.push((b>>i)&1);
    return bits;
  }
  function bitsToStr(bits){
    const bytes = [];
    for(let i=0;i<bits.length;i+=8){
      let val = 0;
      for(let j=0;j<8 && (i+j)<bits.length;j++) val = (val<<1) | bits[i+j];
      bytes.push(val);
    }
    return new TextDecoder().decode(new Uint8Array(bytes));
  }

  document.getElementById('stegHide').addEventListener('click', ()=>{
    if(!coverImage) return document.getElementById('stegStatus').textContent = 'Upload cover image';
    const msg = document.getElementById('stegMsg').value || '';
    const pass = document.getElementById('stegPass').value || '';
    if(!pass) return document.getElementById('stegStatus').textContent = 'Enter password';
    // encrypt msg
    const salt = CryptoJS.lib.WordArray.random(128/8);
    const iv = CryptoJS.lib.WordArray.random(128/8);
    const key = CryptoJS.PBKDF2(pass, salt, { keySize: 256/32, iterations: 200000 });
    const ct = CryptoJS.AES.encrypt(msg, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).ciphertext;
    const payload = JSON.stringify({ salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(ct) });
    const b64 = btoa(payload);
    const bits = strToBits(b64);
    // draw cover
    stegCtx.drawImage(coverImage,0,0);
    const imgd = stegCtx.getImageData(0,0,stegCanvas.width,stegCanvas.height);
    const px = imgd.data; const capacity = Math.floor(px.length/4) * 3;
    if(bits.length + 32 > capacity){ document.getElementById('stegStatus').textContent = 'Message too large for image'; return; }
    const len = bits.length; const lenBits = []; for(let i=31;i>=0;i--) lenBits.push((len>>i)&1);
    const all = lenBits.concat(bits);
    let bi = 0;
    for(let i=0;i<px.length && bi<all.length;i+=4){
      for(let c=0;c<3 && bi<all.length;c++){ px[i+c] = (px[i+c] & 0xFE) | all[bi++]; }
    }
    stegCtx.putImageData(imgd,0,0);
    document.getElementById('stegStatus').textContent = 'Hidden. Click download.';
    document.getElementById('downloadSteg').onclick = ()=> { stegCanvas.toBlob(b=>{ const url = URL.createObjectURL(b); const a = document.createElement('a'); a.href=url; a.download='stego.png'; document.body.appendChild(a); a.click(); a.remove(); }); };
  });

  document.getElementById('stegReveal').addEventListener('click', async ()=>{
    const f = document.getElementById('stegUpload').files[0];
    if(!f) return document.getElementById('stegStatus').textContent = 'Upload encoded image to reveal';
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
      const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
      const imgd = ctx.getImageData(0,0,c.width,c.height);
      const px = imgd.data;
      const bits = [];
      for(let i=0;i<px.length;i+=4){ bits.push(px[i]&1); bits.push(px[i+1]&1); bits.push(px[i+2]&1); }
      const lenBits = bits.slice(0,32); let len=0; for(let i=0;i<32;i++) len = (len<<1) | lenBits[i];
      const msgBits = bits.slice(32, 32+len);
      const b64payload = bitsToStr(msgBits);
      try{
        const payload = JSON.parse(atob(b64payload));
        const pass = document.getElementById('stegPass').value || '';
        if(!pass) return document.getElementById('stegStatus').textContent = 'Enter password to decrypt hidden message';
        const salt = CryptoJS.enc.Base64.parse(payload.salt);
        const iv = CryptoJS.enc.Base64.parse(payload.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize: 256/32, iterations: payload.iterations || 200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const out = dec.toString(CryptoJS.enc.Utf8);
        if(!out) throw 'Decryption empty';
        document.getElementById('stegStatus').textContent = 'Revealed: ' + out;
        stegFail = 0; document.getElementById('stegAttempts').textContent = stegFail;
      } catch(e){
        stegFail++; document.getElementById('stegAttempts').textContent = stegFail;
        document.getElementById('stegStatus').textContent = 'Reveal failed (wrong password or corrupted)';
      }
    };
    img.src = URL.createObjectURL(f);
  });

  // ---------- Password leak SHA-1 prefix helper ----------
  async function sha1hex(msg){
    const buf = await crypto.subtle.digest('SHA-1', new TextEncoder().encode(msg));
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
  }
  document.getElementById('leakBtn').addEventListener('click', async ()=> {
    const p = document.getElementById('leakPass').value || '';
    if(!p) return;
    const hex = await sha1hex(p);
    document.getElementById('leakOut').textContent = `SHA-1: ${hex}\nPrefix: ${hex.slice(0,5)}\nSuffix: ${hex.slice(5)}`;
  });

  // ---------- Morse ----------
  const morseMap = {
    'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---',
    'K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-',
    'U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..',
    '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
    '.':'.-.-.-',',':'--..--','?':'..--..','!':'-.-.--','/':'-..-.','(':'-.--.',')':'-.--.-','&':'.-...'
  }, revMorse = {};
  for(const k in morseMap) revMorse[morseMap[k]] = k;

  function morseEncode(t){ return t.toUpperCase().split('').map(ch => ch === ' ' ? '/' : (morseMap[ch] || '?')).join(' '); }
  function morseDecode(s){ return s.split(' ').map(token => token==='/' ? ' ' : (revMorse[token] || '?')).join(''); }
  document.getElementById('morseEnc').addEventListener('click', ()=> document.getElementById('morseOut').textContent = morseEncode(document.getElementById('morseIn').value || ''));
  document.getElementById('morseDec').addEventListener('click', ()=> document.getElementById('morseOut').textContent = morseDecode(document.getElementById('morseIn').value || ''));

  (()=>{
    const tbody = document.getElementById('morseTable');
    const keys = Object.keys(morseMap).sort();
    for(let i=0;i<keys.length;i+=2){
      const a = keys[i], b = keys[i+1] || '';
      const row = document.createElement('tr');
      row.innerHTML = `<td>${a}</td><td>${morseMap[a]||''}</td><td>${b}</td><td>${morseMap[b]||''}</td>`;
      tbody.appendChild(row);
    }
  })();

  // Helper: hextob64 / b64tohex using jsrsasign helpers if present
  function hextob64(hex){ return hex ? KJUR.crypto.Util.hex2b64(hex) : ''; }
  function b64tohex(b64){ return b64 ? KJUR.crypto.Util.b64tohex(b64) : ''; }

  // End
  </script>
</body>
</html>