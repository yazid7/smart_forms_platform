<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Crypto Toolbox — Updated (eye toggles & restored generator)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for eye icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- CryptoJS -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/md5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha256.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha3.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/ripemd160.js"></script>

  <!-- jsrsasign (kept for RSA utilities) -->
  <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.5.23/lib/jsrsasign-all-min.js"></script>

  <style>
    :root{ --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#6b7280; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    [data-theme="dark"]{ --bg:#071127; --card:#0b1524; --text:#e6eef8; --muted:#9fb3d7; }
    body{ margin:0; padding:20px; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card{ background:var(--card); border:none; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.06); }
    .monos{ font-family:var(--mono); }
    .cipher-output{ white-space:pre-wrap; word-break:break-word; }
    .eye-input { position:relative; }
    .eye-input .eye-btn { position:absolute; right:10px; top:50%; transform:translateY(-50%); background:transparent; border:none; color:var(--muted); cursor:pointer; }
    .rounded-lg{ border-radius:0.75rem; }
    footer small{ color:var(--muted); }
  </style>
</head>
<body data-theme="light">
  <div class="container-fluid">
    <header class="d-flex align-items-center mb-3">
      <h1 class="h4 me-3">Crypto Toolbox — Updated</h1>
      <div class="ms-auto d-flex gap-3 align-items-center">
        <div class="form-check form-switch">
          <input id="darkToggle" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="darkToggle">Dark mode</label>
        </div>
        <small class="text-muted">Client-side demo • CryptoJS & WebCrypto</small>
      </div>
    </header>

    <nav class="nav nav-pills mb-3 flex-column flex-sm-row gap-2">
      <a class="nav-link active" href="#gen">Generators</a>
      <a class="nav-link" href="#file">File</a>
      <a class="nav-link" href="#keys">RSA Keys</a>
      <a class="nav-link" href="#text">Text & Hash</a>
      <a class="nav-link" href="#stego">Steganography</a>
      <a class="nav-link" href="#morse">Morse</a>
      <a class="nav-link" href="#leak">Leak Check</a>
    </nav>

    <!-- =========================================
         GENERATORS (restored full settings)
         ========================================= -->
    <section id="gen" class="card mb-3 p-3">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <h5 class="mb-0">Password & Identity Generator</h5>
        <small class="text-muted">Full settings + words-only mode + email merge</small>
      </div>

      <div class="row g-3">
        <div class="col-lg-6">
          <div class="mb-2 d-flex gap-2 align-items-center">
            <label class="mb-0">Mode</label>
            <select id="pwMode" class="form-select form-select-sm" style="width:180px">
              <option value="mixed">Classic (letters/numbers/symbols)</option>
              <option value="words">Words-only passphrase (lunacy-...)</option>
            </select>

            <label class="mb-0">Length</label>
            <input id="pwLength" type="number" class="form-control form-control-sm" value="16" min="6" max="128" style="width:100px">

            <button id="generatePwBtn" class="btn btn-primary btn-sm">Generate</button>
            <button id="copyPwBtn" class="btn btn-outline-secondary btn-sm">Copy</button>
            <button id="savePwBtn" class="btn btn-success btn-sm">Save</button>
            <button id="clearPwSavedBtn" class="btn btn-danger btn-sm">Clear saved</button>
          </div>

          <!-- advanced settings for Classic mode -->
          <div id="classicSettings" class="mb-2">
            <div class="d-flex gap-2 mb-2">
              <div class="input-group" style="width:160px">
                <span class="input-group-text">letters</span>
                <input id="pwLetters" type="number" class="form-control form-control-sm" value="10" min="0">
              </div>
              <div class="input-group" style="width:140px">
                <span class="input-group-text">digits</span>
                <input id="pwDigits" type="number" class="form-control form-control-sm" value="4" min="0">
              </div>
              <div class="input-group" style="width:140px">
                <span class="input-group-text">symbols</span>
                <input id="pwSymbols" type="number" class="form-control form-control-sm" value="2" min="0">
              </div>
            </div>
            <div class="mb-2">
              <div class="form-check form-check-inline"><input id="incLower" type="checkbox" class="form-check-input" checked><label class="form-check-label">lower</label></div>
              <div class="form-check form-check-inline"><input id="incUpper" type="checkbox" class="form-check-input" checked><label class="form-check-label">UPPER</label></div>
              <div class="form-check form-check-inline"><input id="incNum" type="checkbox" class="form-check-input" checked><label class="form-check-label">digits</label></div>
              <div class="form-check form-check-inline"><input id="incSym" type="checkbox" class="form-check-input" checked><label class="form-check-label">symbols</label></div>
            </div>
            <div class="d-flex gap-2 mb-1">
              <label class="mb-0">Group size</label>
              <input id="groupSize" type="number" class="form-control form-control-sm" value="4" min="0" style="width:90px">
              <label class="mb-0">Separator</label>
              <input id="groupSep" class="form-control form-control-sm" value="-" style="width:90px">
            </div>
          </div>

          <!-- words-only extras -->
          <div id="wordsSettings" class="mb-2" style="display:none">
            <div class="d-flex gap-2 mb-2">
              <label class="mb-0">Words count</label>
              <input id="wordsCount" type="number" class="form-control form-control-sm" value="5" min="2" max="12" style="width:100px">
              <label class="mb-0">Capitalize</label>
              <input id="wordsCap" type="checkbox" class="form-check-input" checked>
            </div>
          </div>

          <!-- output + controls -->
          <label class="form-label mt-2">Generated password</label>
          <div class="d-flex eye-input">
            <div id="pwOutput" class="p-2 border rounded-lg monos large-text" style="flex:1; min-height:48px;"></div>
            <button class="eye-btn" data-target="pwOutput" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="mt-2">
            <div class="progress" style="height:10px"><div id="pwStrengthBar" class="progress-bar" style="width:0%"></div></div>
            <small id="pwStrengthInfo" class="text-muted">Entropy & crack-time will appear here.</small>
          </div>

          <div class="mt-3">
            <h6>Saved passphrases</h6>
            <ul id="pwSavedList" class="list-group"></ul>
          </div>
        </div>

        <div class="col-lg-6">
          <!-- email merge -->
          <label class="form-label">Email merging</label>
          <div class="input-group mb-2 eye-input">
            <input id="baseEmail" class="form-control" placeholder="alpha@gmail.com">
            <button id="emailMergeBtn" class="btn btn-secondary btn-sm">Merge</button>
            <button class="eye-btn" data-target="baseEmail" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="mb-2">
            <button id="copyEmailList" class="btn btn-outline-secondary btn-sm">Copy all</button>
            <button id="genEmailsFromBase" class="btn btn-outline-primary btn-sm">Generate 5</button>
          </div>
          <ul id="emailList" class="list-group mb-2"></ul>

          <!-- random identities -->
          <hr>
          <label class="form-label">Random identities</label>
          <div class="input-group mb-2">
            <input id="idCount" type="number" class="form-control form-control-sm" value="5" min="1" max="100" style="width:100px">
            <button id="genNamesBtn" class="btn btn-outline-secondary btn-sm">Names</button>
            <button id="genEmailsBtn" class="btn btn-outline-secondary btn-sm">Emails</button>
            <button id="genRandomPassphrasesBtn" class="btn btn-outline-secondary btn-sm">Passphrases</button>
          </div>
          <ul id="idList" class="list-group"></ul>

          <!-- OTP -->
          <hr>
          <label>OTP simulator</label>
          <div class="d-flex gap-2 align-items-center">
            <input id="otpLen" type="number" class="form-control form-control-sm" value="6" min="4" max="10" style="width:90px">
            <button id="otpPhoneBtn" class="btn btn-warning btn-sm">Phone OTP</button>
            <button id="otpEmailBtn" class="btn btn-warning btn-sm">Email OTP</button>
            <button id="otpCopyBtn" class="btn btn-outline-secondary btn-sm">Copy</button>
          </div>
          <pre id="otpOutput" class="small-muted mt-2"></pre>
        </div>
      </div>
    </section>

    <!-- =========================================
         FILE section (keeps show/hide pass icon)
         ========================================= -->
    <section id="file" class="card mb-3 p-3">
      <h5>File Encryption & SHA-256 fingerprint</h5>
      <div class="row g-2 align-items-end">
        <div class="col-md-4"><input id="filePicker" type="file" class="form-control"></div>
        <div class="col-md-4 eye-input">
          <input id="filePass" type="password" class="form-control" placeholder="passphrase">
          <button class="eye-btn" data-target="filePass" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
        </div>
        <div class="col-md-4 d-flex gap-2">
          <button id="fileEncryptBtn" class="btn btn-primary btn-sm">Encrypt & Download</button>
          <input id="encUpload" type="file" accept=".enc" class="form-control form-control-sm">
          <button id="fileDecryptBtn" class="btn btn-success btn-sm">Decrypt uploaded</button>
        </div>

        <div class="col-12 mt-2 d-flex gap-3 align-items-center">
          <div>File status: <span id="fileStatus">Idle</span></div>
          <div>Attempts: <span id="fileAttempts">0</span></div>
          <div>SHA-256: <span id="fileSha" class="monos"></span> <button id="copyFileShaBtn" class="btn btn-sm btn-outline-secondary">Copy</button></div>
          <div><button id="computeFileShaBtn" class="btn btn-outline-info btn-sm">Compute SHA-256</button></div>
        </div>
      </div>
    </section>

    <!-- =========================================
         RSA Keys (unchanged features preserved)
         ========================================= -->
    <section id="keys" class="card mb-3 p-3">
      <h5>RSA Keys — generate / import / export / encrypt / decrypt</h5>
      <div class="row g-2">
        <div class="col-md-2"><select id="rsaSize" class="form-select form-select-sm"><option>2048</option><option>3072</option><option>4096</option></select></div>
        <div class="col-md-5 d-flex align-items-end gap-2">
          <button id="rsaGenBtn" class="btn btn-primary btn-sm">Generate</button>
          <button id="rsaExportPubBtn" class="btn btn-outline-secondary btn-sm">Export Public</button>
          <button id="rsaExportPrivBtn" class="btn btn-outline-secondary btn-sm">Export Private</button>
          <button id="rsaClearBtn" class="btn btn-danger btn-sm">Clear</button>
        </div>
        <div class="col-md-5 d-flex align-items-end gap-2">
          <input id="rsaImportPubFile" type="file" accept=".pem" class="form-control form-control-sm">
          <button id="rsaImportPubBtn" class="btn btn-secondary btn-sm">Import Pub</button>
          <input id="rsaImportPrivFile" type="file" accept=".pem" class="form-control form-control-sm">
          <button id="rsaImportPrivBtn" class="btn btn-secondary btn-sm">Import Priv</button>
        </div>

        <div class="col-12 mt-2">
          <label>Message</label>
          <div class="input-group mb-2 eye-input">
            <textarea id="rsaMessage" rows="3" class="form-control monos"></textarea>
            <button class="eye-btn" data-target="rsaMessage" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="d-flex gap-2">
            <button id="rsaEncryptBtn" class="btn btn-primary btn-sm">Encrypt</button>
            <button id="rsaDecryptBtn" class="btn btn-success btn-sm">Decrypt</button>
            <button id="rsaCopyBtn" class="btn btn-outline-secondary btn-sm">Copy</button>
          </div>

          <div class="mt-2">
            <label>Result</label>
            <div id="rsaResult" class="p-2 border monos cipher-output" style="min-height:80px"></div>
          </div>

          <div class="mt-2 d-flex justify-content-between">
            <div>Stored: <span id="rsaStatus">no key</span></div>
            <div>Decrypt attempts: <span id="rsaAttempts">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================================
         Text & Hash section (extended hash + file hash)
         ========================================= -->
    <section id="text" class="card mb-3 p-3">
      <h5>Text Encryption, Hashes & Fingerprint Comparison</h5>
      <div class="row g-3">
        <div class="col-lg-6">
          <label>Text input</label>
          <div class="input-group mb-2 eye-input">
            <textarea id="textInput" rows="6" class="form-control"></textarea>
            <button class="eye-btn" data-target="textInput" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>

          <div class="d-flex gap-2 mb-2">
            <button id="copyInBtn" class="btn btn-outline-secondary btn-sm">Copy</button>
            <button id="pasteInBtn" class="btn btn-outline-secondary btn-sm">Paste</button>
            <button id="clearInBtn" class="btn btn-danger btn-sm">Clear</button>
          </div>

          <div class="d-flex gap-2 flex-wrap mb-2">
            <button id="caesarEncBtn" class="btn btn-sm btn-outline-primary">Caesar Enc</button>
            <button id="caesarDecBtn" class="btn btn-sm btn-outline-secondary">Caesar Dec</button>
            <input id="caesarShift" type="number" class="form-control form-control-sm" style="width:90px" value="3">

            <button id="vigEncBtn" class="btn btn-sm btn-outline-primary">Vigenère Enc</button>
            <button id="vigDecBtn" class="btn btn-sm btn-outline-secondary">Vigenère Dec</button>
            <input id="vigKey" type="text" class="form-control form-control-sm" style="width:120px" value="KEY">

            <button id="xorEncBtn" class="btn btn-sm btn-outline-primary">XOR Enc</button>
            <button id="xorDecBtn" class="btn btn-sm btn-outline-secondary">XOR Dec</button>
            <input id="xorKey" type="text" class="form-control form-control-sm" style="width:120px" value="secret">
          </div>

          <hr>
          <div class="d-flex gap-2 mb-2">
            <button id="md5Btn" class="btn btn-outline-secondary btn-sm">MD5</button>
            <button id="sha1Btn" class="btn btn-outline-secondary btn-sm">SHA-1</button>
            <button id="sha256Btn" class="btn btn-outline-secondary btn-sm">SHA-256</button>
            <button id="sha3Btn" class="btn btn-outline-secondary btn-sm">SHA3-512</button>
            <button id="ripemdBtn" class="btn btn-outline-secondary btn-sm">RIPEMD160</button>
            <select id="havalSelect" class="form-select form-select-sm" style="width:160px">
              <option>HAVAL-256 (placeholder)</option>
            </select>
            <button id="compareBtn" class="btn btn-primary btn-sm">Compare</button>
          </div>

          <div class="mt-2">
            <label>Hashes</label>
            <div id="hashOutput" class="p-2 border monos cipher-output"></div>
          </div>

          <div class="mt-2 d-flex gap-2 align-items-center">
            <label>File hash:</label>
            <select id="fileHashAlgo" class="form-select form-select-sm" style="width:160px">
              <option>SHA-1</option><option>SHA-256</option><option>MD5</option><option>SHA3</option><option>RIPEMD160</option>
            </select>
            <input id="fileHashFile" type="file" class="form-control form-control-sm" style="width:220px">
            <button id="computeFileHashBtn" class="btn btn-outline-primary btn-sm">Compute file hash</button>
            <div id="fileHashResult" class="monos ms-2"></div>
          </div>
        </div>

        <div class="col-lg-6">
          <label>AES text encryption</label>
          <div class="input-group mb-2 eye-input">
            <input id="aesPass" type="password" class="form-control form-control-lg" placeholder="passphrase">
            <button class="eye-btn" data-target="aesPass" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>

          <div class="d-flex gap-2 mb-2 align-items-center">
            <select id="aesMode" class="form-select form-select-sm" style="width:160px"><option value="CBC">AES-CBC (CryptoJS)</option><option value="GCM">AES-GCM (Subtle)</option></select>
            <button id="aesEncryptTextBtn" class="btn btn-outline-primary btn-sm">Encrypt</button>
            <button id="aesDecryptTextBtn" class="btn btn-outline-success btn-sm">Decrypt</button>
            <button id="copyTextOutBtn" class="btn btn-outline-secondary btn-sm">Copy</button>
          </div>

          <div class="mt-2">
            <label>Output</label>
            <div id="textOutput" class="p-2 border monos cipher-output" style="min-height:200px"></div>
          </div>

          <div class="mt-2 d-flex gap-2">
            <button id="saveTextOutBtn" class="btn btn-success btn-sm">Save</button>
            <button id="clearTextSavedBtn" class="btn btn-danger btn-sm">Clear saved</button>
          </div>
          <ul id="textSaved" class="list-group mt-2"></ul>
        </div>
      </div>
    </section>

    <!-- =========================================
         Steganography section
         ========================================= -->
    <section id="stego" class="card mb-3 p-3">
      <h5>Image Steganography (LSB) — AES-protected payload</h5>
      <div class="row g-2">
        <div class="col-md-6">
          <input id="coverFile" type="file" accept="image/*" class="form-control mb-2">
          <label>Message</label>
          <textarea id="stegMsg" class="form-control mb-2" rows="3"></textarea>
          <div class="input-group eye-input mb-2">
            <input id="stegPw" type="password" class="form-control" placeholder="password to protect hidden payload">
            <button class="eye-btn" data-target="stegPw" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="d-flex gap-2 mb-2">
            <button id="stegHideBtn" class="btn btn-primary btn-sm">Hide</button>
            <button id="stegRevealUploadBtn" class="btn btn-success btn-sm">Reveal (upload)</button>
            <input id="stegUpload" type="file" accept="image/*" class="form-control form-control-sm">
            <button id="stegDownloadBtn" class="btn btn-outline-secondary btn-sm" disabled>Download</button>
          </div>
          <div>Stego status: <span id="stegStatus">Idle</span> — Attempts: <span id="stegAttempts">0</span></div>
        </div>
        <div class="col-md-6">
          <label>Preview</label>
          <canvas id="stegCanvas" class="border" style="max-width:100%"></canvas>
          <small class="text-muted d-block mt-2">Payload: PBKDF2 + AES-CBC → base64 → LSB bits.</small>
        </div>
      </div>
    </section>

    <!-- =========================================
         Morse & Leak (unchanged behavior)
         ========================================= -->
    <section id="morse" class="card mb-3 p-3">
      <h5>Morse (extended)</h5>
      <div class="row g-2">
        <div class="col-md-6">
          <textarea id="morseIn" class="form-control" rows="3"></textarea>
          <div class="mt-2 d-flex gap-2">
            <button id="morseEncBtn" class="btn btn-outline-primary btn-sm">Encode</button>
            <button id="morseDecBtn" class="btn btn-outline-secondary btn-sm">Decode</button>
          </div>
        </div>
        <div class="col-md-6">
          <div id="morseOut" class="p-2 border monos cipher-output" style="min-height:120px"></div>
        </div>
      </div>
      <hr>
      <div style="max-height:200px; overflow:auto">
        <table class="table table-sm table-bordered">
          <thead><tr><th>Char</th><th>Morse</th><th>Char</th><th>Morse</th></tr></thead>
          <tbody id="morseTable"></tbody>
        </table>
      </div>
    </section>

    <section id="leak" class="card mb-4 p-3">
      <h5>Leaked password check (simulated) & SHA-1 helper</h5>
      <div class="row g-2">
        <div class="col-md-4">
          <input id="leakEmail" class="form-control" placeholder="email@example.com">
          <div class="mt-2"><button id="checkLeakBtn" class="btn btn-outline-primary btn-sm">Check (sim)</button></div>
          <div id="leakResult" class="monos mt-2"></div>
        </div>
        <div class="col-md-8">
          <div class="input-group eye-input mb-2">
            <input id="leakPass" type="password" class="form-control" placeholder="password to hash">
            <button class="eye-btn" data-target="leakPass" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="d-flex gap-2">
            <button id="computeSha1PrefixBtn" class="btn btn-outline-primary btn-sm">Compute SHA-1 prefix</button>
            <div id="sha1Output" class="monos"></div>
          </div>
        </div>
      </div>
    </section>

    <footer class="text-center mb-4">
      <small>Educational. Use HTTPS/localhost for SubtleCrypto RSA keygen.</small>
    </footer>

  </div>

  <!-- bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /*******************
    Utilities & helpers
  ********************/
  function rngInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function copyText(text){ navigator.clipboard?.writeText(text).catch(()=>{}); }
  function bytesToB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
  function b64ToBytes(b64){ const bin = atob(b64); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr; }
  function arrayBufferToHex(ab){ return [...new Uint8Array(ab)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

  // Eye icon toggles (attach to elements with class 'eye-btn' and data-target=elementId)
  document.querySelectorAll('.eye-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const targetId = btn.getAttribute('data-target');
      if(!targetId) return;
      const el = document.getElementById(targetId);
      if(!el) return;
      // If textarea/div: toggle blur for privacy (can't change type)
      if(el.tagName === 'TEXTAREA' || el.tagName === 'DIV') {
        if(el.style.filter === 'blur(6px)') { el.style.filter='none'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>'; }
        else { el.style.filter='blur(6px)'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>'; }
        return;
      }
      // Input: toggle type
      if(el.type === 'password'){ el.type = 'text'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>'; }
      else { el.type = 'password'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>'; }
    });
  });

  // Dark mode
  document.getElementById('darkToggle').addEventListener('change', e=>{
    document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
  });

  /*******************
    PASSWORD GENERATOR (restored full)
  ********************/
  const WORDLIST = [
    "lunacy","ceremony","kisser","cannon","devalue","alpha","bravo","charlie","delta","echo","foxtrot",
    "gambit","harbor","island","jovial","krypton","lattice","magnet","nectar","opal","pylon","quartz",
    "ripple","sable","tango","umbra","vivid","wander","xenon","yonder","zephyr",
    // add more words if you like...
  ];

  function randChars(pool, n){
    let out = '';
    for(let i=0;i<n;i++) out += pool.charAt(rngInt(0, pool.length-1));
    return out;
  }

  function generateClassicPassword(len, lettersCount, numCount, symCount, groupsz, sep, incLower, incUpper, incNum, incSym){
    const lower = 'abcdefghijklmnopqrstuvwxyz', upper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', digits = '0123456789', syms = '!@#$%^&*()-_=+[]{};:,.<>?/|`~';
    let pool = '';
    if(incLower) pool += lower;
    if(incUpper) pool += upper;
    if(incNum) pool += digits;
    if(incSym) pool += syms;
    if(!pool) pool = lower + upper + digits;

    // Preferred counts: fill requested numbers if possible, otherwise mix
    const arr = [];
    // letters from pool of letters only if requested:
    for(let i=0;i<lettersCount && arr.length < len; i++){
      const letterPool = ((incLower?lower:'') + (incUpper?upper:'')) || lower;
      arr.push(letterPool.charAt(rngInt(0, letterPool.length-1)));
    }
    for(let i=0;i<numCount && arr.length < len; i++) arr.push(digits.charAt(rngInt(0,digits.length-1)));
    for(let i=0;i<symCount && arr.length < len; i++) arr.push(syms.charAt(rngInt(0,syms.length-1)));
    while(arr.length < len) arr.push(pool.charAt(rngInt(0,pool.length-1)));
    // shuffle
    for(let i=arr.length-1;i>0;i--){ const j=rngInt(0,i); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    let p = arr.join('');
    if(groupsz > 0){
      const parts = []; for(let i=0;i<p.length;i+=groupsz) parts.push(p.slice(i,i+groupsz));
      p = parts.join(sep);
    }
    return p;
  }

  function generateWordsPassphrase(count, cap){
    const parts=[];
    for(let i=0;i<count;i++){
      let w = WORDLIST[rngInt(0, WORDLIST.length-1)];
      if(cap) w = w.charAt(0).toUpperCase() + w.slice(1);
      parts.push(w);
    }
    return parts.join('-');
  }

  function entropyBitsWordlist(count){ return Math.log2(WORDLIST.length) * count; }
  function secondsToHuman(s){
    if(!isFinite(s) || s > 1e18) return '>> centuries';
    if(s < 60) return Math.round(s) + 's';
    if(s < 3600) return Math.round(s/60) + 'm';
    if(s < 86400) return Math.round(s/3600) + 'h';
    if(s < 31536000) return Math.round(s/86400) + 'd';
    return Math.round(s/31536000) + 'y';
  }

  // UI wiring
  const pwModeEl = document.getElementById('pwMode');
  pwModeEl.addEventListener('change', ()=> {
    const mode = pwModeEl.value;
    document.getElementById('classicSettings').style.display = mode === 'mixed' ? 'block' : 'none';
    document.getElementById('wordsSettings').style.display = mode === 'words' ? 'block' : 'none';
  });

  document.getElementById('generatePwBtn').addEventListener('click', ()=>{
    const mode = pwModeEl.value;
    let out = '';
    if(mode === 'mixed'){
      const len = Math.max(6, Math.min(128, +document.getElementById('pwLength').value || 16));
      const lettersCount = Math.max(0, +document.getElementById('pwLetters').value || 0);
      const numCount = Math.max(0, +document.getElementById('pwDigits').value || 0);
      const symCount = Math.max(0, +document.getElementById('pwSymbols').value || 0);
      const groupsz = Math.max(0, +document.getElementById('groupSize').value || 0);
      const sep = document.getElementById('groupSep').value || '-';
      const incLower = document.getElementById('incLower').checked;
      const incUpper = document.getElementById('incUpper').checked;
      const incNum = document.getElementById('incNum').checked;
      const incSym = document.getElementById('incSym').checked;
      out = generateClassicPassword(len, lettersCount, numCount, symCount, groupsz, sep, incLower, incUpper, incNum, incSym);
      // estimate entropy: approximate pool size
      let poolSize = 0;
      if(incLower) poolSize += 26;
      if(incUpper) poolSize += 26;
      if(incNum) poolSize += 10;
      if(incSym) poolSize += 32;
      if(poolSize === 0) poolSize = 62;
      const bits = Math.log2(Math.pow(poolSize, Math.max(1, out.replace(/[^A-Za-z0-9]/g,'').length)));
      const seconds = Math.pow(2, bits) / 1e9;
      document.getElementById('pwStrengthBar').style.width = Math.min(100, bits) + '%';
      document.getElementById('pwStrengthBar').textContent = Math.round(bits) + ' bits';
      document.getElementById('pwStrengthInfo').textContent = 'Est. crack @1e9 g/s: ' + secondsToHuman(seconds);
    } else {
      const count = Math.max(2, Math.min(12, +document.getElementById('wordsCount').value || 5));
      const cap = document.getElementById('wordsCap').checked;
      out = generateWordsPassphrase(count, cap);
      const bits = entropyBitsWordlist(count);
      const seconds = Math.pow(2, bits) / 1e9;
      document.getElementById('pwStrengthBar').style.width = Math.min(100, bits) + '%';
      document.getElementById('pwStrengthBar').textContent = Math.round(bits) + ' bits';
      document.getElementById('pwStrengthInfo').textContent = 'Est. crack @1e9 g/s: ' + secondsToHuman(seconds);
    }
    const outEl = document.getElementById('pwOutput');
    outEl.textContent = out;
    outEl.style.filter = 'none';
    // ensure eye icon is in "visible" state icon (eye not slashed)
    document.querySelectorAll('.eye-btn[data-target="pwOutput"]').forEach(b=> b.innerHTML = '<i class="fa-regular fa-eye"></i>');
  });

  document.getElementById('copyPwBtn').addEventListener('click', ()=> copyText(document.getElementById('pwOutput').textContent || ''));
  document.getElementById('savePwBtn').addEventListener('click', ()=>{
    const v = document.getElementById('pwOutput').textContent || ''; if(!v) return;
    const ul = document.getElementById('pwSavedList');
    const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center monos';
    li.innerHTML = `<span>${v}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button> <button class="btn btn-sm btn-danger del">Del</button></div>`;
    li.querySelector('.copy').addEventListener('click', ()=> copyText(v));
    li.querySelector('.del').addEventListener('click', ()=> li.remove());
    ul.prepend(li);
  });
  document.getElementById('clearPwSavedBtn').addEventListener('click', ()=> document.getElementById('pwSavedList').innerHTML = '');

  // Email merge
  function mergeEmail(original){
    try{
      const parts = original.split('@'); if(parts.length !== 2) return original;
      const local = parts[0]; const domain = parts[1];
      const suffix = Array.from({length:8}).map(()=> 'abcdefghijklmnopqrstuvwxyz0123456789'[rngInt(0,35)]).join('');
      const localCap = local.charAt(0).toUpperCase() + local.slice(1);
      return `${localCap}+${suffix}@${domain}`;
    }catch(e){ return original; }
  }
  document.getElementById('emailMergeBtn').addEventListener('click', ()=>{
    const base = document.getElementById('baseEmail').value || 'alpha@gmail.com';
    const outList = document.getElementById('emailList'); outList.innerHTML = '';
    for(let i=0;i<5;i++){ const e = mergeEmail(base); const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML = `<span>${e}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button></div>`; li.querySelector('.copy').addEventListener('click', ()=> copyText(e)); outList.appendChild(li); }
  });
  document.getElementById('genEmailsFromBase').addEventListener('click', ()=> document.getElementById('emailMergeBtn').click());
  document.getElementById('copyEmailList').addEventListener('click', ()=> copyText(Array.from(document.querySelectorAll('#emailList li span')).map(s=>s.textContent).join('\n')));

  // Random identities (reused)
  function randAlnum(len){ return Array.from({length:len}).map(()=> 'abcdefghijklmnopqrstuvwxyz0123456789'[rngInt(0,35)]).join(''); }
  document.getElementById('genNamesBtn').addEventListener('click', ()=> {
    const c = Math.min(100, Math.max(1, +document.getElementById('idCount').value || 5));
    const ul = document.getElementById('idList'); ul.innerHTML='';
    for(let i=0;i<c;i++){ const s = randAlnum(rngInt(6,12)); const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML=`<span>${s}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button></div>`; li.querySelector('.copy').addEventListener('click', ()=> copyText(s)); ul.appendChild(li); }
  });
  document.getElementById('genEmailsBtn').addEventListener('click', ()=>{
    const c = Math.min(100, Math.max(1, +document.getElementById('idCount').value || 5));
    const domains = ['mail.example','service.test','random.xyz']; const ul = document.getElementById('idList'); ul.innerHTML='';
    for(let i=0;i<c;i++){ const e = randAlnum(rngInt(6,10)) + '@' + domains[rngInt(0,domains.length-1)]; const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML=`<span>${e}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button></div>`; li.querySelector('.copy').addEventListener('click', ()=> copyText(e)); ul.appendChild(li); }
  });
  document.getElementById('genRandomPassphrasesBtn').addEventListener('click', ()=>{
    const c = Math.min(100, Math.max(1, +document.getElementById('idCount').value || 5));
    const ul = document.getElementById('idList'); ul.innerHTML='';
    for(let i=0;i<c;i++){ const p = generateWordsPassphrase(3,true); const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center monos'; li.innerHTML=`<span>${p}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button></div>`; li.querySelector('.copy').addEventListener('click', ()=> copyText(p)); ul.appendChild(li); }
  });

  // OTP
  document.getElementById('otpPhoneBtn').addEventListener('click', ()=> {
    const l = Math.max(4, +document.getElementById('otpLen').value || 6); const code = Array.from({length:l}).map(()=>rngInt(0,9)).join(''); document.getElementById('otpOutput').textContent = 'Phone OTP: ' + code;
  });
  document.getElementById('otpEmailBtn').addEventListener('click', ()=> {
    const l = Math.max(4, +document.getElementById('otpLen').value || 6); const code = Array.from({length:l}).map(()=>rngInt(0,9)).join(''); document.getElementById('otpOutput').textContent = 'Email OTP: ' + code;
  });
  document.getElementById('otpCopyBtn').addEventListener('click', ()=> copyText(document.getElementById('otpOutput').textContent || ''));

  /*******************
    FILE handling & SHA256 fingerprint (keeps previous fixes)
  ********************/
  let fileFailCount = 0;
  function wordArrayFromArrayBuffer(ab){
    const u8 = new Uint8Array(ab);
    return CryptoJS.lib.WordArray.create(u8);
  }
  async function computeSHA256ForFile(file){
    const ab = await file.arrayBuffer();
    const hash = await crypto.subtle.digest('SHA-256', ab);
    return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  document.getElementById('computeFileShaBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('filePicker').files[0];
    if(!f) return alert('Choose a file first');
    document.getElementById('fileSha').textContent = 'computing...';
    const hex = await computeSHA256ForFile(f);
    document.getElementById('fileSha').textContent = hex;
  });
  document.getElementById('copyFileShaBtn').addEventListener('click', ()=> copyText(document.getElementById('fileSha').textContent || ''));

  document.getElementById('fileEncryptBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('filePicker').files[0];
    const pass = document.getElementById('filePass').value || '';
    if(!f || !pass){ document.getElementById('fileStatus').textContent = 'Choose file and enter passphrase'; return; }
    document.getElementById('fileStatus').textContent = 'Encrypting...';
    const ab = await f.arrayBuffer();
    const wa = CryptoJS.lib.WordArray.create(new Uint8Array(ab));
    const salt = CryptoJS.lib.WordArray.random(128/8);
    const iv = CryptoJS.lib.WordArray.random(128/8);
    const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:200000 });
    const ciphertext = CryptoJS.AES.encrypt(wa, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).ciphertext;
    const payload = { filename: f.name, algo:'AES-CBC-CryptoJS', salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(ciphertext) };
    const blob = new Blob([JSON.stringify(payload)], {type:'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = f.name + '.enc'; a.click(); a.remove(); URL.revokeObjectURL(url);
    document.getElementById('fileStatus').textContent = 'Encrypted & downloaded';
  });

  document.getElementById('fileDecryptBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('encUpload').files[0];
    const pass = document.getElementById('filePass').value || '';
    if(!f || !pass){ document.getElementById('fileStatus').textContent = 'Upload .enc and enter passphrase'; return; }
    document.getElementById('fileStatus').textContent = 'Decrypting...';
    try{
      const txt = await f.text(); const payload = JSON.parse(txt);
      const salt = CryptoJS.enc.Base64.parse(payload.salt); const iv = CryptoJS.enc.Base64.parse(payload.iv);
      const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations: payload.iterations || 200000 });
      const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
      const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
      const out = new Uint8Array(dec.sigBytes); for(let i=0;i<dec.sigBytes;i++) out[i] = (dec.words[i>>>2] >>> (24 - (i%4)*8)) & 0xFF;
      const blob = new Blob([out], {type:'application/octet-stream'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = payload.filename || 'decrypted.bin'; a.click(); a.remove(); URL.revokeObjectURL(url);
      document.getElementById('fileStatus').textContent = 'Decrypted & downloaded'; fileFailCount = 0; document.getElementById('fileAttempts').textContent = fileFailCount;
    } catch(e){ fileFailCount++; document.getElementById('fileAttempts').textContent = fileFailCount; document.getElementById('fileStatus').textContent = 'Decryption failed (wrong pass or corrupted)'; }
  });

  // Eye toggle in file pass input
  document.querySelectorAll('.eye-btn[data-target="filePass"]').forEach(b=>{
    b.addEventListener('click', ()=> { const el = document.getElementById('filePass'); el.type = el.type==='password' ? 'text' : 'password'; b.innerHTML = el.type==='text' ? '<i class="fa-regular fa-eye-slash"></i>' : '<i class="fa-regular fa-eye"></i>'; });
  });

  /*********************
    RSA section (kept fixes, using jsrsasign for PEM handling)
  *********************/
  let rsaKeypair = { pub: null, prv: null };
  let rsaFailures = 0;
  const rsaStatusEl = document.getElementById('rsaStatus'), rsaAttemptsEl = document.getElementById('rsaAttempts');

  document.getElementById('rsaGenBtn').addEventListener('click', ()=> {
    const bits = +document.getElementById('rsaSize').value;
    try{
      const kp = KEYUTIL.generateKeypair('RSA', bits);
      rsaKeypair.pub = kp.pubKeyObj; rsaKeypair.prv = kp.prvKeyObj;
      rsaStatusEl.textContent = `RSA ${bits} generated`;
      document.getElementById('rsaResult').textContent = '';
      rsaAttemptsEl.textContent = rsaFailures;
    } catch(e){ alert('RSA generate failed: ' + e); }
  });

  document.getElementById('rsaExportPubBtn').addEventListener('click', ()=> {
    if(!rsaKeypair.pub) return alert('No public key');
    const pem = KEYUTIL.getPEM(rsaKeypair.pub);
    const blob = new Blob([pem], {type:'application/x-pem-file'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'public.pem'; a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  document.getElementById('rsaExportPrivBtn').addEventListener('click', ()=> {
    if(!rsaKeypair.prv) return alert('No private key');
    const pem = KEYUTIL.getPEM(rsaKeypair.prv, 'PKCS8PRV'); const blob = new Blob([pem], {type:'application/x-pem-file'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'private.pem'; a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  document.getElementById('rsaImportPubBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('rsaImportPubFile').files[0]; if(!f) return alert('Select public PEM'); const pem = await f.text(); try{ rsaKeypair.pub = KEYUTIL.getKey(pem); rsaStatusEl.textContent = 'Public imported'; } catch(e){ alert('Import failed: ' + e); }
  });
  document.getElementById('rsaImportPrivBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('rsaImportPrivFile').files[0]; if(!f) return alert('Select private PEM'); const pem = await f.text(); try{ rsaKeypair.prv = KEYUTIL.getKey(pem); rsaStatusEl.textContent = 'Private imported'; } catch(e){ alert('Import failed: ' + e); }
  });

  document.getElementById('rsaClearBtn').addEventListener('click', ()=> { rsaKeypair = {pub:null,prv:null}; rsaStatusEl.textContent='no key'; rsaFailures=0; rsaAttemptsEl.textContent=0; document.getElementById('rsaResult').textContent=''; });

  document.getElementById('rsaEncryptBtn').addEventListener('click', ()=>{
    const txt = document.getElementById('rsaMessage').value || '';
    if(!rsaKeypair.pub) return alert('No public key');
    try{
      const pubPEM = KEYUTIL.getPEM(rsaKeypair.pub);
      const hex = KJUR.crypto.Cipher.encrypt(txt, pubPEM); // hex
      const b64 = KJUR.crypto.Util.hex2b64(hex);
      document.getElementById('rsaResult').textContent = b64;
    } catch(e){ alert('RSA encrypt failed: ' + e); }
  });

  document.getElementById('rsaDecryptBtn').addEventListener('click', ()=>{
    const b64 = document.getElementById('rsaResult').textContent.trim();
    if(!b64) return alert('No ciphertext');
    if(!rsaKeypair.prv) return alert('No private key');
    try{
      const hex = KJUR.crypto.Util.b64tohex(b64);
      const pemPrv = KEYUTIL.getPEM(rsaKeypair.prv, 'PKCS8PRV');
      const dec = KJUR.crypto.Cipher.decrypt(hex, pemPrv);
      document.getElementById('rsaResult').textContent = dec;
      rsaFailures = 0; rsaAttemptsEl.textContent = rsaFailures;
    } catch(e){ rsaFailures++; rsaAttemptsEl.textContent = rsaFailures; document.getElementById('rsaResult').textContent = 'RSA decryption failed'; }
  });

  document.getElementById('rsaCopyBtn').addEventListener('click', ()=> copyText(document.getElementById('rsaResult').textContent || ''));
  document.getElementById('rsaPasteBtn')?.addEventListener('click', async ()=> { const txt = await navigator.clipboard.readText(); document.getElementById('rsaMessage').value = txt; });

  /***********************
    Text ciphers, AES & Hash
  ************************/
  // Caesar, Vigenere, XOR (same as earlier)
  function caesarEnc(s, shift){ return s.replace(/[A-Za-z]/g, c=>{ const base = c<='Z'?65:97; return String.fromCharCode((c.charCodeAt(0)-base+shift+26)%26+base); }); }
  function caesarDec(s, shift){ return caesarEnc(s, (26-shift)%26); }
  document.getElementById('caesarEncBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = caesarEnc(document.getElementById('textInput').value || '', +document.getElementById('caesarShift').value || 3));
  document.getElementById('caesarDecBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = caesarDec(document.getElementById('textInput').value || '', +document.getElementById('caesarShift').value || 3));
  function vigenere(text,key,dec=false){ if(!key) return text; let ki=0; const out=[]; for(const ch of text){ if(/[A-Za-z]/.test(ch)){ const base = ch<='Z'?65:97; const k = key[ki%key.length].toUpperCase().charCodeAt(0)-65; const shift = dec?(26-k):k; out.push(String.fromCharCode((ch.charCodeAt(0)-base+shift)%26+base)); ki++; } else out.push(ch); } return out.join(''); }
  document.getElementById('vigEncBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = vigenere(document.getElementById('textInput').value || '', document.getElementById('vigKey').value || 'KEY', false));
  document.getElementById('vigDecBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = vigenere(document.getElementById('textInput').value || '', document.getElementById('vigKey').value || 'KEY', true));
  function xorEnc(text,key){ const t=new TextEncoder().encode(text); const k=new TextEncoder().encode(key); const out=new Uint8Array(t.length); for(let i=0;i<t.length;i++) out[i]=t[i]^k[i%k.length]; return bytesToB64(out); }
  function xorDec(b64,key){ const data=b64ToBytes(b64); const k=new TextEncoder().encode(key); const out=new Uint8Array(data.length); for(let i=0;i<data.length;i++) out[i]=data[i]^k[i%k.length]; return new TextDecoder().decode(out); }
  document.getElementById('xorEncBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = xorEnc(document.getElementById('textInput').value||'', document.getElementById('xorKey').value||'k'));
  document.getElementById('xorDecBtn').addEventListener('click', ()=> { try{ document.getElementById('textOutput').textContent = xorDec(document.getElementById('textOutput').textContent||'', document.getElementById('xorKey').value||'k'); } catch(e){ document.getElementById('textOutput').textContent = 'XOR decode failed'; } });

  // Hash buttons wiring
  document.getElementById('md5Btn').addEventListener('click', ()=> {
    const t = document.getElementById('textInput').value || '';
    document.getElementById('hashOutput').textContent = 'MD5: ' + CryptoJS.MD5(t).toString(CryptoJS.enc.Hex);
  });
  document.getElementById('sha1Btn').addEventListener('click', ()=> {
    const t = document.getElementById('textInput').value || '';
    document.getElementById('hashOutput').textContent = 'SHA1: ' + CryptoJS.SHA1(t).toString(CryptoJS.enc.Hex);
  });
  document.getElementById('sha256Btn').addEventListener('click', ()=> {
    const t = document.getElementById('textInput').value || '';
    document.getElementById('hashOutput').textContent = 'SHA256: ' + CryptoJS.SHA256(t).toString(CryptoJS.enc.Hex);
  });
  document.getElementById('sha3Btn').addEventListener('click', ()=> {
    const t = document.getElementById('textInput').value || '';
    document.getElementById('hashOutput').textContent = 'SHA3-512: ' + CryptoJS.SHA3(t, {outputLength:512}).toString(CryptoJS.enc.Hex);
  });
  document.getElementById('ripemdBtn').addEventListener('click', ()=> {
    const t = document.getElementById('textInput').value || '';
    document.getElementById('hashOutput').textContent = 'RIPEMD160: ' + CryptoJS.RIPEMD160(t).toString(CryptoJS.enc.Hex);
  });
  document.getElementById('compareBtn').addEventListener('click', ()=> {
    const t = document.getElementById('textInput').value || '';
    const md5 = CryptoJS.MD5(t).toString(CryptoJS.enc.Hex);
    const sha1 = CryptoJS.SHA1(t).toString(CryptoJS.enc.Hex);
    const sha256 = CryptoJS.SHA256(t).toString(CryptoJS.enc.Hex);
    const sha3 = CryptoJS.SHA3(t, {outputLength:512}).toString(CryptoJS.enc.Hex);
    const rip = CryptoJS.RIPEMD160(t).toString(CryptoJS.enc.Hex);
    document.getElementById('hashOutput').textContent = `MD5: ${md5}\nSHA1: ${sha1}\nSHA256: ${sha256}\nSHA3-512: ${sha3}\nRIPEMD160: ${rip}\nHAVAL-256: [not available unless HAVAL lib is included]`;
  });

  // File hash compute (selected algo)
  async function computeFileHash(algorithm, file){
    const ab = await file.arrayBuffer();
    const subtleMap = { 'SHA-1':'SHA-1', 'SHA-256':'SHA-256', 'SHA-384':'SHA-384', 'SHA-512':'SHA-512' };
    if(algorithm in subtleMap){
      const buf = await crypto.subtle.digest(subtleMap[algorithm], ab);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    // fallback for MD5/SHA3/RIPEMD160 using CryptoJS
    function abToWordArray(ab){
      const u8 = new Uint8Array(ab);
      return CryptoJS.lib.WordArray.create(u8);
    }
    const wa = abToWordArray(ab);
    switch(algorithm){
      case 'MD5': return CryptoJS.MD5(wa).toString(CryptoJS.enc.Hex);
      case 'SHA3': return CryptoJS.SHA3(wa, {outputLength:512}).toString(CryptoJS.enc.Hex);
      case 'RIPEMD160': return CryptoJS.RIPEMD160(wa).toString(CryptoJS.enc.Hex);
      case 'HAVAL-256': return '[HAVAL-256 not available unless library included]';
      default: return '[unsupported]';
    }
  }

  document.getElementById('computeFileHashBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('fileHashFile').files[0];
    const algo = document.getElementById('fileHashAlgo').value;
    if(!f) return alert('Choose a file');
    document.getElementById('fileHashResult').textContent = 'Computing...';
    const res = await computeFileHash(algo, f);
    document.getElementById('fileHashResult').textContent = `${algo}: ${res}`;
  });

  // AES text encryption (CBC via CryptoJS + GCM via Subtle)
  async function subtleAesGcmEncrypt(plain, pass){
    const enc = new TextEncoder();
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:200000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
    const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(plain));
    return { algo:'AES-GCM-Subtle', salt: bytesToB64(salt), iv: bytesToB64(iv), ciphertext: bytesToB64(ct), iterations:200000 };
  }
  async function subtleAesGcmDecrypt(payload, pass){
    const enc = new TextEncoder(), dec = new TextDecoder();
    const salt = b64ToBytes(payload.salt),
          iv = b64ToBytes(payload.iv);
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations: payload.iterations || 200000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
    const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, b64ToBytes(payload.ciphertext).buffer);
    return dec.decode(pt);
  }

  document.getElementById('aesEncryptTextBtn').addEventListener('click', async ()=>{
    const pass = document.getElementById('aesPass').value || ''; if(!pass) return alert('Enter passphrase');
    const plain = document.getElementById('textInput').value || '';
    const mode = document.getElementById('aesMode').value;
    if(mode === 'CBC'){
      const salt = CryptoJS.lib.WordArray.random(128/8);
      const iv = CryptoJS.lib.WordArray.random(128/8);
      const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:200000 });
      const enc = CryptoJS.AES.encrypt(plain, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
      const payload = { algo:'AES-CBC-CryptoJS', salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(enc.ciphertext) };
      document.getElementById('textOutput').textContent = JSON.stringify(payload);
    } else {
      try{ const payload = await subtleAesGcmEncrypt(plain, pass); document.getElementById('textOutput').textContent = JSON.stringify(payload); } catch(e){ alert('GCM encrypt failed: '+e); }
    }
  });

  document.getElementById('aesDecryptTextBtn').addEventListener('click', async ()=>{
    const pass = document.getElementById('aesPass').value || ''; if(!pass) return alert('Enter passphrase');
    const outEl = document.getElementById('textOutput');
    try{
      const payload = JSON.parse(outEl.textContent || '{}');
      if(payload.algo === 'AES-CBC-CryptoJS'){
        const salt = CryptoJS.enc.Base64.parse(payload.salt), iv = CryptoJS.enc.Base64.parse(payload.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations: payload.iterations || 200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const text = dec.toString(CryptoJS.enc.Utf8);
        if(!text) throw 'empty';
        outEl.textContent = text;
      } else if(payload.algo === 'AES-GCM-Subtle'){
        try{ const txt = await subtleAesGcmDecrypt(payload, pass); outEl.textContent = txt; } catch(e){ outEl.textContent = 'GCM decryption failed'; }
      } else outEl.textContent = 'Unknown payload';
    } catch(e){ outEl.textContent = 'AES decryption failed'; }
  });

  document.getElementById('copyTextOutBtn').addEventListener('click', ()=> copyText(document.getElementById('textOutput').textContent || ''));
  document.getElementById('saveTextOutBtn').addEventListener('click', ()=> {
    const v = document.getElementById('textOutput').textContent || ''; if(!v) return;
    const ul = document.getElementById('textSaved'); const li = document.createElement('li'); li.className = 'list-group-item monos d-flex justify-content-between align-items-center'; li.innerHTML = `<span>${v}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button> <button class="btn btn-sm btn-danger del">Del</button></div>`; li.querySelector('.copy').addEventListener('click', ()=> copyText(v)); li.querySelector('.del').addEventListener('click', ()=> li.remove()); ul.prepend(li);
  });
  document.getElementById('clearTextSavedBtn').addEventListener('click', ()=> document.getElementById('textSaved').innerHTML='');

  // Show/Hide inputs toggles for other password fields (link eye buttons to behavior)
  document.querySelectorAll('.eye-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const target = btn.getAttribute('data-target');
      if(!target) return;
      const el = document.getElementById(target);
      if(!el) return;
      if(el.tagName === 'DIV' || el.tagName === 'TEXTAREA'){
        // toggle blur for privacy (already handled earlier)
        return;
      }
      if(el.type === 'password'){ el.type = 'text'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>'; }
      else { el.type = 'password'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>'; }
    });
  });

  /*********************
    Steganography (LSB) functions (kept fixed)
  **********************/
  const stegCanvas = document.getElementById('stegCanvas');
  const stegCtx = stegCanvas.getContext('2d');
  let coverImage = null, stegFailCount = 0;
  document.getElementById('coverFile')?.addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const img = new Image();
    img.onload = ()=> { stegCanvas.width = img.width; stegCanvas.height = img.height; stegCtx.drawImage(img,0,0); coverImage = img; document.getElementById('stegStatus').textContent = 'Cover loaded'; };
    img.src = URL.createObjectURL(f);
  });

  function strToBits(str){
    const bytes = new TextEncoder().encode(str);
    const bits = [];
    for(const b of bytes) for(let i=7;i>=0;i--) bits.push((b>>i)&1);
    return bits;
  }
  function bitsToStr(bits){
    const bytes = [];
    for(let i=0;i<bits.length;i+=8){
      let val = 0; for(let j=0;j<8 && (i+j)<bits.length;j++) val = (val<<1) | bits[i+j];
      bytes.push(val);
    }
    return new TextDecoder().decode(new Uint8Array(bytes));
  }

  document.getElementById('stegHideBtn').addEventListener('click', ()=>{
    if(!coverImage){ document.getElementById('stegStatus').textContent = 'Upload cover image'; return; }
    const msg = document.getElementById('stegMsg').value || '';
    const pass = document.getElementById('stegPw').value || '';
    if(!pass){ document.getElementById('stegStatus').textContent = 'Enter password'; return; }
    const salt = CryptoJS.lib.WordArray.random(128/8);
    const iv = CryptoJS.lib.WordArray.random(128/8);
    const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:200000 });
    const ct = CryptoJS.AES.encrypt(msg, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).ciphertext;
    const payload = JSON.stringify({ salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(ct) });
    const b64 = btoa(payload);
    const bits = strToBits(b64);
    stegCtx.drawImage(coverImage,0,0);
    const imgd = stegCtx.getImageData(0,0,stegCanvas.width,stegCanvas.height);
    const px = imgd.data; const capacity = Math.floor(px.length/4)*3;
    if(bits.length + 32 > capacity){ document.getElementById('stegStatus').textContent = 'Message too large for image'; return; }
    const lenBits=[]; const len = bits.length;
    for(let i=31;i>=0;i--) lenBits.push((len>>i)&1);
    const all = lenBits.concat(bits);
    let bi=0;
    for(let i=0;i<px.length && bi<all.length;i+=4){
      for(let c=0;c<3 && bi<all.length;c++){ px[i+c] = (px[i+c] & 0xFE) | all[bi++]; }
    }
    stegCtx.putImageData(imgd,0,0);
    document.getElementById('stegStatus').textContent = 'Hidden - preview updated';
    document.getElementById('stegDownloadBtn').disabled = false;
    document.getElementById('stegDownloadBtn').onclick = ()=> {
      stegCanvas.toBlob(b=>{ const url = URL.createObjectURL(b); const a=document.createElement('a'); a.href=url; a.download='stego.png'; a.click(); a.remove(); URL.revokeObjectURL(url); });
    };
  });

  document.getElementById('stegRevealBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('stegUpload').files[0];
    if(!f){ document.getElementById('stegStatus').textContent = 'Upload encoded image'; return; }
    const img = new Image();
    img.onload = ()=> {
      const c = document.createElement('canvas'); c.width = img.width; c.height = img.height; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
      const imgd = ctx.getImageData(0,0,c.width,c.height); const px = imgd.data;
      const bits = []; for(let i=0;i<px.length;i+=4){ bits.push(px[i]&1); bits.push(px[i+1]&1); bits.push(px[i+2]&1); }
      const lenBits = bits.slice(0,32); let len=0; for(let i=0;i<32;i++) len=(len<<1)|lenBits[i];
      const payloadBits = bits.slice(32,32+len); const b64 = bitsToStr(payloadBits);
      try{
        const payload = JSON.parse(atob(b64));
        const pass = document.getElementById('stegPw').value || '';
        if(!pass){ document.getElementById('stegStatus').textContent = 'Enter password'; return; }
        const salt = CryptoJS.enc.Base64.parse(payload.salt); const iv = CryptoJS.enc.Base64.parse(payload.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations: payload.iterations || 200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const out = dec.toString(CryptoJS.enc.Utf8);
        if(!out) throw 'empty';
        document.getElementById('stegStatus').textContent = 'Revealed: ' + out;
        stegFailCount = 0; document.getElementById('stegAttempts').textContent = stegFailCount;
      } catch(e){ stegFailCount++; document.getElementById('stegAttempts').textContent = stegFailCount; document.getElementById('stegStatus').textContent = 'Reveal failed (wrong password or corrupted)'; }
    };
    img.src = URL.createObjectURL(f);
  });

  /*******************
    Morse table already set
  *******************/
  const morseMap = {
    'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---',
    'K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-',
    'U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..',
    '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
    '.':'.-.-.-',',':'--..--','?':'..--..','!':'-.-.--','/':'-..-.','(':'-.--.',')':'-.--.-','&':'.-...',
    ':':'---...',';':'-.-.-.','=':'-...-','+':'.-.-.','-':'-....-','_':'..--.-','"':'.-..-.','$':'...-..-','@':'.--.-.',
    '#':'......','*':'-..-.-'
  };
  const revMorse = {}; for(const k in morseMap) revMorse[morseMap[k]] = k;
  function morseEncode(t){ return t.toUpperCase().split('').map(ch => ch===' ' ? '/' : (morseMap[ch]||'?')).join(' '); }
  function morseDecode(s){ return s.split(' ').map(token => token==='/' ? ' ' : (revMorse[token]||'?')).join(''); }
  document.getElementById('morseEncBtn').addEventListener('click', ()=> document.getElementById('morseOut').textContent = morseEncode(document.getElementById('morseIn').value || ''));
  document.getElementById('morseDecBtn').addEventListener('click', ()=> document.getElementById('morseOut').textContent = morseDecode(document.getElementById('morseIn').value || ''));
  (function fillMorseTable(){ const tbody = document.getElementById('morseTable'); const keys=Object.keys(morseMap).sort(); for(let i=0;i<keys.length;i+=2){ const a=keys[i], b=keys[i+1]||''; const row=document.createElement('tr'); row.innerHTML=`<td>${a}</td><td>${morseMap[a]||''}</td><td>${b}</td><td>${morseMap[b]||''}</td>`; tbody.appendChild(row); } })();

  // Leak check (simulated)
  const fakeDB = { 'test@example.com': true, 'admin@mail.com': true };
  document.getElementById('checkLeakBtn').addEventListener('click', ()=> {
    const e = (document.getElementById('leakEmail').value||'').toLowerCase().trim(); document.getElementById('leakResult').textContent = fakeDB[e] ? 'Leaked (simulated)' : 'No record in simulated DB';
  });
  document.getElementById('computeSha1PrefixBtn').addEventListener('click', async ()=>{
    const p = document.getElementById('leakPass').value || ''; if(!p) return alert('Enter password'); const buf = await crypto.subtle.digest('SHA-1', new TextEncoder().encode(p)); const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase(); document.getElementById('sha1Output').textContent = `SHA1: ${hex} Prefix:${hex.slice(0,5)} Suffix:${hex.slice(5)}`;
  });

  // Small convenience: paste/copy/clear wiring
  document.getElementById('pasteInBtn').addEventListener('click', async ()=> { try{ const s = await navigator.clipboard.readText(); document.getElementById('textInput').value = s; } catch(e){ alert('Paste failed'); }});
  document.getElementById('copyInBtn').addEventListener('click', ()=> copyText(document.getElementById('textInput').value || ''));
  document.getElementById('clearInBtn').addEventListener('click', ()=> document.getElementById('textInput').value = '');

  // End of script
  </script>
</body>
</html>