<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Crypto Toolkit — Fixed RSA, Morse, Eye toggles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- fontawesome for eye icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- CryptoJS for symmetric/hash functions -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/md5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha256.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha3.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/ripemd160.js"></script>
  <!-- jsrsasign for RSA PEM/key handling and encryption/decryption -->
  <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.5.23/lib/jsrsasign-all-min.js"></script>

  <style>
    :root { --bg: #f7fafc; --card: #fff; --muted: #6b7280; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    [data-theme="dark"] { --bg: #071127; --card: #0b1524; --muted: #9fb3d7; color-scheme: dark; }
    body { background: var(--bg); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 18px; }
    .card { background: var(--card); border-radius: 12px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); margin-bottom: 16px; }
    .monos { font-family: var(--mono); }
    .cipher-output { white-space: pre-wrap; word-break: break-word; }
    .input-eye { position: relative; }
    .input-eye .eye-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color: var(--muted); }
    pre.morse { background: #f1f5f9; padding: 8px; border-radius: 6px; }
    footer small { color: var(--muted); }
    .small-muted { color: var(--muted); }
  </style>
</head>
<body data-theme="light">
  <div class="container-fluid">
    <header class="d-flex align-items-center mb-3">
      <h1 class="h4 me-3">Crypto Toolkit (fixed)</h1>
      <div class="ms-auto d-flex gap-3 align-items-center">
        <div class="form-check form-switch">
          <input class="form-check-input" id="darkModeToggle" type="checkbox">
          <label class="form-check-label" for="darkModeToggle">Dark</label>
        </div>
        <small class="small-muted">Client-side — CryptoJS & jsrsasign</small>
      </div>
    </header>

    <!-- NAV -->
    <nav class="nav nav-pills mb-3 gap-2">
      <a class="nav-link active" href="#pw">Passwords</a>
      <a class="nav-link" href="#rsa">RSA</a>
      <a class="nav-link" href="#text">Text & Hash</a>
      <a class="nav-link" href="#stego">Stego</a>
      <a class="nav-link" href="#morse">Morse</a>
    </nav>

    <!-- PASSWORDS -->
    <section id="pw" class="card p-3">
      <div class="d-flex justify-content-between align-items-start">
        <h5>Password generator</h5>
        <small class="small-muted">classic + words-only + email merge</small>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <div class="mb-2 d-flex gap-2 align-items-center">
            <label class="mb-0">Mode</label>
            <select id="pwMode" class="form-select form-select-sm" style="width:220px">
              <option value="classic">Classic (letters/numbers/symbols)</option>
              <option value="words">Words-only passphrase</option>
            </select>

            <label class="mb-0">Length</label>
            <input id="pwLen" class="form-control form-control-sm" type="number" value="16" min="6" style="width:110px">

            <button id="pwGenBtn" class="btn btn-primary btn-sm">Generate</button>
            <button id="pwCopyBtn" class="btn btn-outline-secondary btn-sm">Copy</button>
          </div>

          <div id="classicOptions">
            <div class="d-flex gap-2 mb-2">
              <div class="form-check form-check-inline"><input id="incLower" class="form-check-input" type="checkbox" checked><label class="form-check-label">lower</label></div>
              <div class="form-check form-check-inline"><input id="incUpper" class="form-check-input" type="checkbox" checked><label class="form-check-label">UPPER</label></div>
              <div class="form-check form-check-inline"><input id="incDigits" class="form-check-input" type="checkbox" checked><label class="form-check-label">digits</label></div>
              <div class="form-check form-check-inline"><input id="incSymbols" class="form-check-input" type="checkbox"><label class="form-check-label">symbols</label></div>
            </div>
            <div class="d-flex gap-2 align-items-center mb-2">
              <label class="mb-0">Group</label>
              <input id="groupSize" class="form-control form-control-sm" type="number" value="0" min="0" style="width:90px">
              <label class="mb-0">Sep</label>
              <input id="groupSep" class="form-control form-control-sm" value="-" style="width:90px">
            </div>
          </div>

          <div id="wordsOptions" style="display:none">
            <div class="d-flex gap-2 align-items-center">
              <label class="mb-0">Words</label>
              <input id="wordsCount" type="number" class="form-control form-control-sm" value="5" min="2" style="width:100px">
              <div class="form-check"><input id="wordsCap" class="form-check-input" type="checkbox" checked><label class="form-check-label">Capitalize</label></div>
            </div>
          </div>

          <label class="mt-3">Generated</label>
          <div class="input-eye">
            <div id="pwOut" class="p-2 border rounded monos" style="min-height:44px;"></div>
            <button class="eye-btn" data-target="pwOut" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>

          <div class="mt-2">
            <div class="progress" style="height:10px"><div id="pwBar" class="progress-bar" style="width:0%"></div></div>
            <small id="pwInfo" class="small-muted d-block mt-1">Entropy / Time-to-guess shown here.</small>
          </div>
        </div>

        <div class="col-md-6">
          <label>Email merge (alpha@gmail.com → Alpha+xxxx@gmail.com)</label>
          <div class="input-group mb-2">
            <input id="baseEmail" type="email" class="form-control" placeholder="alpha@gmail.com">
            <button id="emailMergeBtn" class="btn btn-secondary">Merge</button>
            <button id="emailCopyAllBtn" class="btn btn-outline-secondary">Copy all</button>
          </div>
          <ul id="emailList" class="list-group mb-2"></ul>

          <hr>
          <label>Saved</label>
          <ul id="pwSaved" class="list-group"></ul>
        </div>
      </div>
    </section>

    <!-- RSA -->
    <section id="rsa" class="card p-3">
      <div class="d-flex justify-content-between">
        <h5>RSA Keys — generate / import / export / encrypt / decrypt</h5>
        <small class="small-muted">PEM-based, OAEP</small>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-md-3 d-flex gap-2 align-items-end">
          <select id="rsaBits" class="form-select form-select-sm">
            <option>2048</option>
            <option>3072</option>
            <option>4096</option>
          </select>
          <button id="rsaGen" class="btn btn-primary btn-sm">Generate</button>
        </div>

        <div class="col-md-9 d-flex gap-2 align-items-end">
          <input id="rsaPubFile" type="file" accept=".pem" class="form-control form-control-sm" style="width:auto">
          <button id="rsaImportPubBtn" class="btn btn-outline-secondary btn-sm">Import public</button>
          <input id="rsaPrivFile" type="file" accept=".pem" class="form-control form-control-sm" style="width:auto">
          <button id="rsaImportPrivBtn" class="btn btn-outline-secondary btn-sm">Import private</button>
          <button id="rsaExportPubBtn" class="btn btn-outline-secondary btn-sm">Export public</button>
          <button id="rsaExportPrivBtn" class="btn btn-outline-secondary btn-sm">Export private</button>
          <button id="rsaClearBtn" class="btn btn-danger btn-sm">Clear</button>
        </div>

        <div class="col-md-6">
          <label>Public Key (X.509 PEM)</label>
          <textarea id="rsaPublicPem" class="form-control monos" rows="6" placeholder="-----BEGIN PUBLIC KEY-----..."></textarea>
        </div>
        <div class="col-md-6">
          <label>Private Key (PKCS#8 PEM)</label>
          <textarea id="rsaPrivatePem" class="form-control monos" rows="6" placeholder="-----BEGIN PRIVATE KEY-----..."></textarea>
        </div>

        <div class="col-12">
          <label>Input message</label>
          <div class="d-flex input-eye mb-2">
            <textarea id="rsaInput" class="form-control" rows="3"></textarea>
            <button class="eye-btn" data-target="rsaInput" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>

          <div class="d-flex gap-2 mb-2">
            <button id="rsaEncryptBtn" class="btn btn-primary btn-sm">Encrypt (public)</button>
            <button id="rsaDecryptBtn" class="btn btn-success btn-sm">Decrypt (private)</button>
            <button id="rsaClearOutBtn" class="btn btn-outline-secondary btn-sm">Clear output</button>
          </div>

          <label>Output (base64)</label>
          <textarea id="rsaOutput" class="form-control monos" rows="4" readonly></textarea>
          <div class="mt-2 small-muted">Status: <span id="rsaStatus">no key</span> — Attempts: <span id="rsaAttempts">0</span></div>
        </div>
      </div>
    </section>

    <!-- Text & Hash -->
    <section id="text" class="card p-3">
      <h5>Text & Hash (MD5, SHA-1, SHA-256, SHA3-512, RIPEMD160)</h5>

      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <label>Text input</label>
          <textarea id="textIn" class="form-control" rows="6"></textarea>
          <div class="d-flex gap-2 mt-2">
            <button id="hashMd5Btn" class="btn btn-outline-secondary btn-sm">MD5</button>
            <button id="hashSha1Btn" class="btn btn-outline-secondary btn-sm">SHA-1</button>
            <button id="hashSha256Btn" class="btn btn-outline-secondary btn-sm">SHA-256</button>
            <button id="hashSha3Btn" class="btn btn-outline-secondary btn-sm">SHA3-512</button>
            <button id="hashRipemdBtn" class="btn btn-outline-secondary btn-sm">RIPEMD160</button>
            <button id="hashCompareBtn" class="btn btn-primary btn-sm">Compare</button>
          </div>

          <div class="mt-2">
            <label>Result</label>
            <div id="hashOut" class="p-2 border monos cipher-output"></div>
          </div>
        </div>

        <div class="col-md-6">
          <label>File hashing (choose file)</label>
          <div class="d-flex gap-2 align-items-center">
            <select id="fileHashAlgo" class="form-select form-select-sm" style="width:160px">
              <option>SHA-1</option><option>SHA-256</option><option>MD5</option><option>SHA3</option><option>RIPEMD160</option>
            </select>
            <input id="fileHashInput" type="file" class="form-control form-control-sm" style="width:260px">
            <button id="fileHashBtn" class="btn btn-outline-primary btn-sm">Compute</button>
          </div>
          <div class="mt-2"><label>File Hash</label><div id="fileHashOut" class="p-2 border monos"></div></div>
        </div>
      </div>
    </section>

    <!-- Stego simple -->
    <section id="stego" class="card p-3">
      <h5>Simple Image Steganography (LSB) — AES protected payload</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <input id="coverFile" type="file" accept="image/*" class="form-control mb-2">
          <textarea id="stegoMsg" class="form-control mb-2" rows="3" placeholder="Message to hide"></textarea>
          <div class="input-eye mb-2">
            <input id="stegoPass" type="password" class="form-control" placeholder="Password for payload">
            <button class="eye-btn" data-target="stegoPass"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="d-flex gap-2">
            <button id="stegHideBtn" class="btn btn-primary btn-sm">Hide & Preview</button>
            <button id="stegRevealBtn" class="btn btn-success btn-sm">Reveal (upload)</button>
            <button id="stegDownloadBtn" class="btn btn-outline-secondary btn-sm" disabled>Download PNG</button>
          </div>
          <div class="mt-2 small-muted">Status: <span id="stegStatus">idle</span> — Attempts: <span id="stegAttempts">0</span></div>
        </div>

        <div class="col-md-6">
          <label>Preview</label>
          <canvas id="stegCanvas" class="border" style="max-width:100%"></canvas>
        </div>
      </div>
    </section>

    <!-- MORSE -->
    <section id="morse" class="card p-3">
      <h5>Morse Code (table)</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <textarea id="morseIn" class="form-control" rows="3"></textarea>
          <div class="d-flex gap-2 mt-2">
            <button id="morseEnc" class="btn btn-outline-primary btn-sm">Encode</button>
            <button id="morseDec" class="btn btn-outline-secondary btn-sm">Decode</button>
          </div>
        </div>
        <div class="col-md-6">
          <div id="morseOut" class="p-2 border monos" style="min-height:90px"></div>
        </div>
      </div>

      <hr>
      <div>
        <pre class="morse">
A  .-     B  -...   C  -.-.   D  -..    E  .
F  ..-.   G  --.    H  ....   I  ..     J  .---
K  -.-    L  .-..   M  --     N  -.     O  ---
P  .--.   Q  --.-   R  .-.    S  ...    T  -
U  ..-    V  ...-   W  .--    X  -..-   Y  -.--
Z  --..

0  -----  1  .----  2  ..---  3  ...--  4  ....-  5  .....
6  -....  7  --...  8  ---..  9  ----.

.  .-.-.-   ,  --..--   ?  ..--..   !  -.-.--   /  -..-.
(  -.--.    )  -.--.-   &  .-...    :  ---...
;  -.-.-.   =  -...-   +  .-.-.     -  -....-   _  ..--.-
"  .-..-.   $  ...-..-   @  .--.-.  #  ......   *  -.-.- 
        </pre>
      </div>
    </section>

    <footer class="text-center mt-4 mb-4">
      <small class="small-muted">Use HTTPS/localhost for SubtleCrypto features. Educational use only.</small>
    </footer>
  </div>

  <!-- bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Main app script -->
  <script>
  // ---------- Helpers ----------
  function rng(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function copyTextValue(el){
    if(!el) return;
    const text = (el.value !== undefined) ? el.value : el.textContent;
    navigator.clipboard?.writeText(text).catch(()=>{});
  }
  function isBase64(s){ return /^[A-Za-z0-9+/=\s]+$/.test(s) && s.length%4===0; }

  // Dark mode
  document.getElementById('darkModeToggle').addEventListener('change', (e)=>{
    document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
  });

  // Input-eye: attach toggles for any .eye-btn
  document.querySelectorAll('.eye-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = btn.getAttribute('data-target') || btn.previousElementSibling?.id;
      if(!target) return;
      const el = document.getElementById(target);
      if(!el) return;
      // if it's a content DIV (our generated pw output), blur/unblur
      if(el.tagName === 'DIV'){
        if(el.style.filter === 'blur(6px)'){ el.style.filter='none'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>'; }
        else { el.style.filter='blur(6px)'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>'; }
        return;
      }
      // for inputs/textareas toggle type if password, otherwise blur
      if(el.tagName === 'INPUT' && el.type === 'password'){
        el.type = 'text'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>';
      } else if(el.tagName === 'INPUT' && el.type === 'text'){
        el.type = 'password'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>';
      } else if(el.tagName === 'TEXTAREA'){
        if(el.style.filter === 'blur(6px)'){ el.style.filter='none'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>'; }
        else { el.style.filter='blur(6px)'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>'; }
      }
    });
  });

  // ---------- PASSWORD GENERATOR (classic + words) ----------
  const WORDS = ["lunacy","ceremony","kisser","cannon","devalue","alpha","orbit","matrix","fusion","cipher","zenith","lunar","harbor","ripple","tango","vivid","xenon","zephyr","sable","quartz"];
  function genWordsPass(count, cap){
    const parts = [];
    for(let i=0;i<count;i++){
      let w = WORDS[rng(0, WORDS.length-1)];
      if(cap) w = w.charAt(0).toUpperCase() + w.slice(1);
      parts.push(w);
    }
    return parts.join('-');
  }
  function genClassic(len, options){
    const lower='abcdefghijklmnopqrstuvwxyz', upper='ABCDEFGHIJKLMNOPQRSTUVWXYZ', digits='0123456789', symbols='!@#$%^&*()-_=+[]{};:,.<>?/';
    let pool = '';
    if(options.lower) pool += lower;
    if(options.upper) pool += upper;
    if(options.digits) pool += digits;
    if(options.symbols) pool += symbols;
    if(pool.length === 0) pool = lower + upper;
    const arr = [];
    for(let i=0;i<len;i++) arr.push(pool.charAt(rng(0,pool.length-1)));
    // grouping if requested
    if(options.group > 0){
      const parts = [];
      for(let i=0;i<arr.length;i+=options.group) parts.push(arr.slice(i,i+options.group).join(''));
      return parts.join(options.sep || '-');
    }
    return arr.join('');
  }

  function estimateEntropyForClassic(pass, options){
    let pool=0; if(options.lower) pool += 26; if(options.upper) pool += 26; if(options.digits) pool += 10; if(options.symbols) pool += 32;
    if(pool === 0) pool = 52;
    const bits = Math.log2(Math.pow(pool, pass.replace(/[^A-Za-z0-9]/g,'').length));
    return bits;
  }

  document.getElementById('pwMode').addEventListener('change', ()=>{
    const mode = document.getElementById('pwMode').value;
    document.getElementById('classicOptions').style.display = (mode === 'classic') ? 'block' : 'none';
    document.getElementById('wordsOptions').style.display = (mode === 'words') ? 'block' : 'none';
  });

  document.getElementById('pwGenBtn').addEventListener('click', ()=>{
    const mode = document.getElementById('pwMode').value;
    let output = '';
    if(mode === 'words'){
      const count = Math.max(2, Math.min(12, +document.getElementById('wordsCount').value || 5));
      const cap = document.getElementById('wordsCap').checked;
      output = genWordsPass(count, cap);
      const bits = Math.log2(WORDS.length) * count;
      const seconds = Math.pow(2, bits)/1e9;
      document.getElementById('pwBar').style.width = Math.min(100, bits) + '%';
      document.getElementById('pwInfo').textContent = `Entropy: ${bits.toFixed(1)} bits • Est. crack @1e9 g/s: ${readableSeconds(seconds)}`;
    } else {
      const len = Math.max(6, Math.min(256, +document.getElementById('pwLen').value || 16));
      const options = { lower: document.getElementById('incLower').checked, upper: document.getElementById('incUpper').checked, digits: document.getElementById('incDigits').checked, symbols: document.getElementById('incSymbols').checked, group: +document.getElementById('groupSize').value || 0, sep: document.getElementById('groupSep').value || '-' };
      output = genClassic(len, options);
      const bits = estimateEntropyForClassic(output, options);
      const seconds = Math.pow(2, bits)/1e9;
      document.getElementById('pwBar').style.width = Math.min(100, bits) + '%';
      document.getElementById('pwInfo').textContent = `Entropy: ${bits.toFixed(1)} bits • Est. crack @1e9 g/s: ${readableSeconds(seconds)}`;
    }
    const outEl = document.getElementById('pwOut');
    outEl.textContent = output;
    outEl.style.filter = 'none';
    // reset eye icon
    document.querySelectorAll('.eye-btn[data-target="pwOut"]').forEach(b=> b.innerHTML = '<i class="fa-regular fa-eye"></i>');
  });

  function readableSeconds(s){
    if(!isFinite(s) || s > 1e18) return '>> centuries';
    if(s < 60) return `${Math.round(s)}s`;
    if(s < 3600) return `${Math.round(s/60)}m`;
    if(s < 86400) return `${Math.round(s/3600)}h`;
    if(s < 31536000) return `${Math.round(s/86400)}d`;
    return `${Math.round(s/31536000)}y`;
  }

  document.getElementById('pwCopyBtn').addEventListener('click', ()=> copyTextValue(document.getElementById('pwOut')));

  // email merge
  function mergeEmail(base){
    try{
      const parts = base.split('@'); if(parts.length !== 2) return base;
      const local = parts[0], domain = parts[1];
      const suffix = Array.from({length:8}).map(()=> 'abcdefghijklmnopqrstuvwxyz0123456789'[rng(0,35)]).join('');
      const localCap = local.charAt(0).toUpperCase() + local.slice(1);
      return `${localCap}+${suffix}@${domain}`;
    }catch(e){ return base; }
  }
  document.getElementById('emailMergeBtn').addEventListener('click', ()=>{
    const base = document.getElementById('baseEmail').value || 'alpha@gmail.com';
    const list = document.getElementById('emailList'); list.innerHTML = '';
    for(let i=0;i<5;i++){
      const m = mergeEmail(base);
      const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `<span>${m}</span><div><button class="btn btn-sm btn-outline-secondary copy">Copy</button></div>`;
      li.querySelector('.copy').addEventListener('click', ()=> navigator.clipboard.writeText(m));
      list.appendChild(li);
    }
  });
  document.getElementById('emailCopyAllBtn').addEventListener('click', ()=> {
    const items = Array.from(document.querySelectorAll('#emailList li span')).map(s=>s.textContent).join('\n');
    navigator.clipboard.writeText(items);
  });

  // ---------- RSA: generate / import / export / encrypt / decrypt (FIXED) ----------
  let rsaKeyPair = { pubKeyObj: null, prvKeyObj: null }; // jsrsasign key objects
  let rsaAttempts = 0;
  function setRsaStatus(msg){ document.getElementById('rsaStatus').textContent = msg; document.getElementById('rsaAttempts').textContent = rsaAttempts; }

  document.getElementById('rsaGen').addEventListener('click', ()=>{
    const bits = +document.getElementById('rsaBits').value || 2048;
    setRsaStatus('Generating...');
    setTimeout(()=>{ // generate asynchronously to avoid blocking UI
      try{
        const kp = KEYUTIL.generateKeypair('RSA', bits);
        rsaKeyPair.pubKeyObj = kp.pubKeyObj;
        rsaKeyPair.prvKeyObj = kp.prvKeyObj;
        const pubPem = KEYUTIL.getPEM(kp.pubKeyObj);
        const priPem = KEYUTIL.getPEM(kp.prvKeyObj, 'PKCS8PRV');
        document.getElementById('rsaPublicPem').value = pubPem;
        document.getElementById('rsaPrivatePem').value = priPem;
        setRsaStatus(`RSA ${bits} generated`);
      } catch(err){
        setRsaStatus('Generation failed: ' + err);
      }
    }, 50);
  });

  // Import public/private from file inputs (PEM)
  document.getElementById('rsaImportPubBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('rsaPubFile').files[0];
    if(!f) return alert('Select a public PEM file');
    try{
      const pem = await f.text();
      const key = KEYUTIL.getKey(pem);
      rsaKeyPair.pubKeyObj = key;
      document.getElementById('rsaPublicPem').value = KEYUTIL.getPEM(key);
      setRsaStatus('Public key imported');
    } catch(e){ setRsaStatus('Import pub failed'); alert('Import public key failed: ' + e); }
  });

  document.getElementById('rsaImportPrivBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('rsaPrivFile').files[0];
    if(!f) return alert('Select a private PEM file');
    try{
      const pem = await f.text();
      const key = KEYUTIL.getKey(pem);
      rsaKeyPair.prvKeyObj = key;
      document.getElementById('rsaPrivatePem').value = KEYUTIL.getPEM(key, 'PKCS8PRV');
      setRsaStatus('Private key imported');
    } catch(e){ setRsaStatus('Import priv failed'); alert('Import private key failed: ' + e); }
  });

  // Export buttons: download content of textareas as files
  document.getElementById('rsaExportPubBtn').addEventListener('click', ()=>{
    const pem = document.getElementById('rsaPublicPem').value || '';
    if(!pem) return alert('No public key to export');
    downloadText(pem, 'public.pem');
  });
  document.getElementById('rsaExportPrivBtn').addEventListener('click', ()=>{
    const pem = document.getElementById('rsaPrivatePem').value || '';
    if(!pem) return alert('No private key to export');
    downloadText(pem, 'private.pem');
  });
  function downloadText(text, filename){
    const blob = new Blob([text], { type: 'application/x-pem-file' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  document.getElementById('rsaClearBtn').addEventListener('click', ()=>{
    rsaKeyPair = { pubKeyObj: null, prvKeyObj: null }; rsaAttempts = 0;
    document.getElementById('rsaPublicPem').value = ''; document.getElementById('rsaPrivatePem').value = ''; document.getElementById('rsaOutput').value = '';
    setRsaStatus('no key');
  });

  // RSA encryption: use jsrsasign's KJUR.crypto.Cipher.encrypt with RSAOAEP
  document.getElementById('rsaEncryptBtn').addEventListener('click', ()=>{
    const pubPemText = document.getElementById('rsaPublicPem').value.trim();
    if(!pubPemText) return alert('Provide/import a public key in PEM format');
    try{
      const pubKey = KEYUTIL.getKey(pubPemText);
      // encrypt; KJUR.crypto.Cipher.encrypt returns hex string by default for RSA
      const msg = document.getElementById('rsaInput').value || '';
      // Use RSA OAEP
      const hex = KJUR.crypto.Cipher.encrypt(msg, pubKey, 'RSAOAEP');
      const b64 = hextob64(hex);
      document.getElementById('rsaOutput').value = b64;
      setRsaStatus('Encrypted (base64)');
    } catch(err){
      setRsaStatus('Encrypt failed');
      alert('RSA encrypt error: ' + err);
    }
  });

  // RSA decryption: accept base64 (common) or hex
  document.getElementById('rsaDecryptBtn').addEventListener('click', ()=>{
    const privPemText = document.getElementById('rsaPrivatePem').value.trim();
    if(!privPemText) return alert('Provide/import a private key in PEM format');
    try{
      const prvKey = KEYUTIL.getKey(privPemText);
      let ct = document.getElementById('rsaOutput').value.trim();
      if(!ct) return alert('No ciphertext in output area');
      // If base64, convert to hex
      let hex;
      if(isBase64(ct)){
        try{ hex = b64tohex(ct); } catch(e){ /* fallback */ hex = ct; }
      } else {
        hex = ct.replace(/\s+/g,''); // assume hex
      }
      // decrypt hex
      const dec = KJUR.crypto.Cipher.decrypt(hex, prvKey);
      document.getElementById('rsaOutput').value = dec;
      setRsaStatus('Decrypted');
      rsaAttempts = 0;
      document.getElementById('rsaAttempts').textContent = rsaAttempts;
    } catch(err){
      rsaAttempts++;
      document.getElementById('rsaAttempts').textContent = rsaAttempts;
      setRsaStatus('Decrypt failed (wrong key or data)');
      alert('RSA decrypt error: ' + err);
    }
  });

  // ---------- Text/hash ----------
  document.getElementById('hashMd5Btn').addEventListener('click', ()=> { const t = document.getElementById('textIn').value || ''; document.getElementById('hashOut').textContent = 'MD5: ' + CryptoJS.MD5(t).toString(); });
  document.getElementById('hashSha1Btn').addEventListener('click', ()=> { const t = document.getElementById('textIn').value || ''; document.getElementById('hashOut').textContent = 'SHA-1: ' + CryptoJS.SHA1(t).toString(); });
  document.getElementById('hashSha256Btn').addEventListener('click', ()=> { const t = document.getElementById('textIn').value || ''; document.getElementById('hashOut').textContent = 'SHA-256: ' + CryptoJS.SHA256(t).toString(); });
  document.getElementById('hashSha3Btn').addEventListener('click', ()=> { const t = document.getElementById('textIn').value || ''; document.getElementById('hashOut').textContent = 'SHA3-512: ' + CryptoJS.SHA3(t, {outputLength:512}).toString(); });
  document.getElementById('hashRipemdBtn').addEventListener('click', ()=> { const t = document.getElementById('textIn').value || ''; document.getElementById('hashOut').textContent = 'RIPEMD160: ' + CryptoJS.RIPEMD160(t).toString(); });

  document.getElementById('hashCompareBtn').addEventListener('click', ()=> {
    const t = document.getElementById('textIn').value || '';
    const md5 = CryptoJS.MD5(t).toString();
    const sha1 = CryptoJS.SHA1(t).toString();
    const sha256 = CryptoJS.SHA256(t).toString();
    const sha3 = CryptoJS.SHA3(t, {outputLength:512}).toString();
    const rip = CryptoJS.RIPEMD160(t).toString();
    document.getElementById('hashOut').textContent = `MD5: ${md5}\nSHA1: ${sha1}\nSHA256: ${sha256}\nSHA3-512: ${sha3}\nRIPEMD160: ${rip}\nHAVAL-256: [placeholder — add HAVAL lib if needed]`;
  });

  // file hashing
  document.getElementById('fileHashBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('fileHashInput').files[0];
    const algo = document.getElementById('fileHashAlgo').value;
    if(!f) return alert('Select a file');
    document.getElementById('fileHashOut').textContent = 'Computing...';
    const ab = await f.arrayBuffer();
    // use subtle for SHA-1/SHA-256; fallback to CryptoJS for MD5/SHA3/RIPEMD
    if(algo === 'SHA-1' || algo === 'SHA-256'){
      const map = { 'SHA-1':'SHA-1','SHA-256':'SHA-256' };
      const buf = await crypto.subtle.digest(map[algo], ab);
      document.getElementById('fileHashOut').textContent = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
      return;
    }
    // fallback
    const wa = CryptoJS.lib.WordArray.create(new Uint8Array(ab));
    if(algo === 'MD5') document.getElementById('fileHashOut').textContent = CryptoJS.MD5(wa).toString();
    else if(algo === 'SHA3') document.getElementById('fileHashOut').textContent = CryptoJS.SHA3(wa, {outputLength:512}).toString();
    else if(algo === 'RIPEMD160') document.getElementById('fileHashOut').textContent = CryptoJS.RIPEMD160(wa).toString();
    else document.getElementById('fileHashOut').textContent = '[unsupported]';
  });

  // ---------- Steganography (simple LSB + AES) ----------
  const stegCanvas = document.getElementById('stegCanvas'); const stegCtx = stegCanvas.getContext('2d');
  let coverImage = null;
  document.getElementById('coverFile').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const img = new Image();
    img.onload = ()=> { stegCanvas.width = img.width; stegCanvas.height = img.height; stegCtx.drawImage(img,0,0); coverImage = img; document.getElementById('stegStatus').textContent = 'cover loaded'; };
    img.src = URL.createObjectURL(f);
  });

  function strToBits(s){
    const bytes = new TextEncoder().encode(s);
    const bits = [];
    for(const b of bytes) for(let i=7;i>=0;i--) bits.push((b>>i)&1);
    return bits;
  }
  function bitsToStr(bits){
    const bytes=[]; for(let i=0;i<bits.length;i+=8){ let v=0; for(let j=0;j<8 && (i+j)<bits.length;j++) v=(v<<1)|bits[i+j]; bytes.push(v); } return new TextDecoder().decode(new Uint8Array(bytes));
  }

  document.getElementById('stegHideBtn').addEventListener('click', ()=>{
    if(!coverImage) return alert('Upload a cover image first');
    const msg = document.getElementById('stegoMsg').value || '';
    const pass = document.getElementById('stegoPass').value || ''; if(!pass) return alert('Enter a password');
    // encrypt payload with AES (CryptoJS PBKDF2)
    const salt = CryptoJS.lib.WordArray.random(128/8);
    const iv = CryptoJS.lib.WordArray.random(128/8);
    const key = CryptoJS.PBKDF2(pass, salt, { keySize: 256/32, iterations: 200000 });
    const cipherWA = CryptoJS.AES.encrypt(msg, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).ciphertext;
    const payload = JSON.stringify({ salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(cipherWA) });
    const b64 = btoa(payload);
    const bits = strToBits(b64);
    stegCtx.drawImage(coverImage,0,0);
    const imgd = stegCtx.getImageData(0,0,stegCanvas.width,stegCanvas.height);
    const px = imgd.data;
    const capacity = Math.floor(px.length/4)*3;
    if(bits.length + 32 > capacity) return alert('Message too large for that image');
    const lenBits = []; const L = bits.length; for(let i=31;i>=0;i--) lenBits.push((L>>i)&1);
    const all = lenBits.concat(bits);
    let bi=0;
    for(let i=0;i<px.length && bi<all.length;i+=4){
      for(let c=0;c<3 && bi<all.length;c++){ px[i+c] = (px[i+c] & 0xFE) | all[bi++]; }
    }
    stegCtx.putImageData(imgd,0,0);
    document.getElementById('stegStatus').textContent = 'Hidden — preview updated';
    document.getElementById('stegDownloadBtn').disabled = false;
    document.getElementById('stegDownloadBtn').onclick = ()=> {
      stegCanvas.toBlob(b=>{ const url = URL.createObjectURL(b); const a = document.createElement('a'); a.href = url; a.download = 'stego.png'; a.click(); a.remove(); URL.revokeObjectURL(url); });
    };
  });

  document.getElementById('stegRevealBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('stegUpload')?.files?.[0];
    if(!f) return alert('Select an encoded image to reveal (or use preview image)');
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement('canvas'); c.width=img.width; c.height=img.height; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
      const imgd = ctx.getImageData(0,0,c.width,c.height); const px=imgd.data;
      const bits=[]; for(let i=0;i<px.length;i+=4){ bits.push(px[i]&1); bits.push(px[i+1]&1); bits.push(px[i+2]&1); }
      let len=0; for(let i=0;i<32;i++) len = (len<<1) | bits[i];
      const payloadBits = bits.slice(32,32+len); const b64 = bitsToStr(payloadBits);
      try{
        const payload = JSON.parse(atob(b64));
        const pass = document.getElementById('stegoPass').value || '';
        if(!pass) return alert('Enter password to decrypt hidden message');
        const salt = CryptoJS.enc.Base64.parse(payload.salt); const iv = CryptoJS.enc.Base64.parse(payload.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:payload.iterations||200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const out = dec.toString(CryptoJS.enc.Utf8);
        if(!out) throw 'empty';
        document.getElementById('stegStatus').textContent = 'Revealed: ' + out;
      } catch(e){
        document.getElementById('stegStatus').textContent = 'Reveal failed (wrong password or corrupted)';
      }
    };
    img.src = URL.createObjectURL(f);
  });

  // ---------- MORSE encode/decode ----------
  const MORSE = {
    'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---',
    'K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-',
    'U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..',
    '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
    '.':'.-.-.-',',':'--..--','?':'..--..','!':'-.-.--','/':'-..-.','(':'-.--.',')':'-.--.-','&':'.-...',';':'-.-.-.','=':'-...-',
    '+':'.-.-.','-':'-....-','_':'..--.-','"':'.-..-.','$':'...-..-','@':'.--.-.','#':'......','*':'-.-.-'
  };
  const REV = {}; for(const k in MORSE) REV[MORSE[k]] = k;
  document.getElementById('morseEnc').addEventListener('click', ()=>{
    const t = (document.getElementById('morseIn').value || '').toUpperCase();
    const out = t.split('').map(ch => ch === ' ' ? '/' : (MORSE[ch] || '?')).join(' ');
    document.getElementById('morseOut').textContent = out;
  });
  document.getElementById('morseDec').addEventListener('click', ()=>{
    const s = (document.getElementById('morseIn').value || '').trim();
    const out = s.split(' ').map(token => token === '/' ? ' ' : (REV[token] || '?')).join('');
    document.getElementById('morseOut').textContent = out;
  });

  // Utility: convert hex <-> b64 (jsrsasign helpers used)
  function hextob64(hex){ return KJUR.crypto.Util.hex2b64(hex); }
  function b64tohex(b64){ return KJUR.crypto.Util.b64tohex(b64); }

  // End
  </script>
</body>
</html>