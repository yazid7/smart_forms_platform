<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Crypto Toolbox — Final (Dark Clean)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- CryptoJS -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/md5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha256.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/sha3.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/ripemd160.js"></script>
  <!-- jsrsasign for RSA PEM handling -->
  <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.5.23/lib/jsrsasign-all-min.js"></script>

  <style>
    /* Dark clean Bootstrap theme */
    :root{
      --bg:#0b1220;
      --card:#0f1724;
      --muted:#9fb3c8;
      --accent:#37f2a6;
      --accent-2:#4dd2ff;
      --glass: rgba(255,255,255,0.02);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
    }
    body { background: linear-gradient(180deg,#07111b 0%, #0b1220 100%); color:#cbeee6; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:18px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015)); border:1px solid rgba(255,255,255,0.03); border-radius:10px; box-shadow: 0 10px 30px rgba(2,6,23,0.6); }
    .card-header { background:transparent; border-bottom: none; color:var(--accent); font-weight:600; font-size:1rem; }
    .form-control, .form-select { background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:#dffcf0; }
    .form-control:focus, .form-select:focus { outline: none; box-shadow: 0 0 10px rgba(55,242,166,0.08); border-color: var(--accent); }
    .btn-primary { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#021016; border: none; font-weight:600; }
    .btn-outline { border:1px solid rgba(255,255,255,0.06); color:#bfeee0; background:transparent; }
    .monos { font-family: var(--mono); font-size:0.95rem; color:#dffcf0; }
    .cipher-output { white-space: pre-wrap; word-break: break-word; background: rgba(0,0,0,0.2); padding:10px; border-radius:8px; color:#dffcf0; }
    .input-eye { position: relative; }
    .input-eye .eye-btn { position:absolute; right:8px; top:50%; transform:translateY(-50%); border:none; background:transparent; color:var(--accent); cursor:pointer; }
    .small-muted { color: var(--muted); }
    .progress { height:10px; background: rgba(255,255,255,0.02); border-radius:6px; overflow:hidden; }
    .progress-bar { background: linear-gradient(90deg,var(--accent-2),var(--accent)); }
    pre.morse { background: rgba(255,255,255,0.01); padding:10px; border-radius:8px; color:#c8f9e8; }
    nav.nav-pills .nav-link { color:#9fdac9; }
    nav.nav-pills .nav-link.active { color:#021016; background: linear-gradient(90deg,var(--accent),var(--accent-2)); border-radius:8px; }
    footer small { color:var(--muted); }
    .btn-compact { padding:.25rem .5rem; font-size:.85rem; }
    @media (max-width:768px) {
      .row .col-md-6 { flex: 0 0 100%; max-width:100%; }
    }
  </style>
</head>
<body>

  <div class="container-fluid">
    <header class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h2 class="h5 mb-0" style="color:var(--accent)">Crypto Toolbox</h2>
        <small class="small-muted">Dark / clean — restored & fixed features</small>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <button id="themeToggle" class="btn btn-outline btn-compact"><i class="fa fa-sun"></i></button>
        <small class="small-muted">Client-side demo</small>
      </div>
    </header>

    <nav class="nav nav-pills mb-3">
      <a class="nav-link active" href="#generators">Generators</a>
      <a class="nav-link" href="#file">File</a>
      <a class="nav-link" href="#rsa">RSA Keys</a>
      <a class="nav-link" href="#text">Text & Hash</a>
      <a class="nav-link" href="#stego">Steganography</a>
      <a class="nav-link" href="#morse">Morse</a>
      <a class="nav-link" href="#leak">Leak</a>
    </nav>

    <!-- ============================
         Generators (passwords, emails, OTP)
         ============================ -->
    <section id="generators" class="card p-3 mb-3">
      <div class="card-header">Generators — Passwords, Passphrases & Identities</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="d-flex gap-2 align-items-center mb-2">
              <label class="mb-0 small-muted">Mode</label>
              <select id="pwMode" class="form-select form-select-sm" style="width:200px">
                <option value="classic">Classic (letters/numbers/symbols)</option>
                <option value="words">Words-only passphrase</option>
              </select>

              <label class="mb-0 small-muted">Length</label>
              <input id="pwLength" type="number" class="form-control form-control-sm" value="16" min="6" style="width:110px">

              <div class="btn-group btn-group-sm ms-auto" role="group">
                <button id="generatePwBtn" class="btn btn-primary">Generate</button>
                <button id="copyPwBtn" class="btn btn-outline btn-compact"><i class="fa fa-copy"></i></button>
              </div>
            </div>

            <div id="classicSettings" class="mb-2">
              <div class="d-flex gap-3 mb-2">
                <div><input id="incLower" type="checkbox" checked> <span class="small-muted">lower</span></div>
                <div><input id="incUpper" type="checkbox" checked> <span class="small-muted">UPPER</span></div>
                <div><input id="incDigits" type="checkbox" checked> <span class="small-muted">digits</span></div>
                <div><input id="incSymbols" type="checkbox"> <span class="small-muted">symbols</span></div>
              </div>

              <div class="d-flex gap-2 align-items-center">
                <label class="small-muted mb-0">Group</label>
                <input id="groupSize" type="number" class="form-control form-control-sm" value="0" min="0" style="width:90px">
                <label class="small-muted mb-0">Sep</label>
                <input id="groupSep" type="text" class="form-control form-control-sm" value="-" style="width:80px">
              </div>
            </div>

            <div id="wordsSettings" style="display:none">
              <div class="d-flex gap-2 align-items-center mb-2">
                <label class="small-muted mb-0">Words</label>
                <input id="wordsCount" type="number" class="form-control form-control-sm" value="5" min="2" style="width:90px">
                <div><input id="wordsCap" type="checkbox" checked> <span class="small-muted">Capitalize</span></div>
              </div>
            </div>

            <label class="small-muted">Generated</label>
            <div class="input-eye mb-2">
              <div id="pwOutput" class="p-2 border rounded monos" style="min-height:48px;"></div>
              <button class="eye-btn" data-target="pwOutput" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
            </div>

            <div class="mt-2">
              <div class="progress"><div id="pwStrengthBar" class="progress-bar" style="width:0%"></div></div>
              <small id="pwStrengthInfo" class="small-muted d-block mt-1">Entropy & crack-time will show here.</small>
            </div>

            <div class="mt-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 small-muted">Saved Passphrases</h6>
                <div>
                  <button id="savePwBtn" class="btn btn-outline btn-compact">Save</button>
                  <button id="clearSavedPwBtn" class="btn btn-outline btn-compact">Clear</button>
                </div>
              </div>
              <ul id="pwSavedList" class="list-group"></ul>
            </div>
          </div>

          <div class="col-md-6">
            <label class="small-muted">Email merge (alpha@gmail.com → Alpha+xxxx@gmail.com)</label>
            <div class="input-eye mb-2">
              <input id="baseEmail" class="form-control" placeholder="alpha@gmail.com">
              <button class="eye-btn" data-target="baseEmail" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
            </div>
            <div class="d-flex gap-2 mb-2">
              <button id="genEmailsBtn" class="btn btn-primary btn-sm">Generate 5</button>
              <button id="copyEmailListBtn" class="btn btn-outline btn-compact btn-sm"><i class="fa fa-copy"></i></button>
            </div>
            <ul id="emailList" class="list-group mb-2"></ul>

            <hr class="my-3" />

            <label class="small-muted">OTP & Random Identities</label>
            <div class="d-flex gap-2 align-items-center mb-2">
              <input id="otpLen" type="number" value="6" class="form-control form-control-sm" style="width:90px">
              <button id="otpPhoneBtn" class="btn btn-outline btn-compact btn-sm">Phone OTP</button>
              <button id="otpEmailBtn" class="btn btn-outline btn-compact btn-sm">Email OTP</button>
              <button id="copyOtpBtn" class="btn btn-outline btn-compact btn-sm"><i class="fa fa-copy"></i></button>
            </div>
            <pre id="otpOutput" class="small-muted p-2" style="background:transparent;"></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================
         File encryption & SHA-256 fingerprint
         ============================ -->
    <section id="file" class="card p-3 mb-3">
      <div class="card-header">File encryption & SHA-256 fingerprint</div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <input id="filePicker" type="file" class="form-control">
          </div>

          <div class="col-md-4 input-eye">
            <input id="filePass" type="password" class="form-control" placeholder="passphrase">
            <button class="eye-btn" data-target="filePass" title="Show/Hide"><i class="fa-regular fa-eye"></i></button>
          </div>

          <div class="col-md-4 d-flex gap-2">
            <button id="fileEncryptBtn" class="btn btn-primary btn-sm">Encrypt & Download</button>
            <input id="encUpload" type="file" accept=".enc" class="form-control form-control-sm">
            <button id="fileDecryptBtn" class="btn btn-success btn-sm">Decrypt uploaded</button>
          </div>

          <div class="col-12 d-flex gap-3 align-items-center mt-2">
            <div>File status: <span id="fileStatus" class="monos">Idle</span></div>
            <div>Attempts: <span id="fileAttempts">0</span></div>
            <div>SHA-256: <span id="fileSha" class="monos"></span> <button id="copyFileShaBtn" class="btn btn-outline btn-compact btn-sm"><i class="fa fa-copy"></i></button></div>
            <div><button id="computeFileShaBtn" class="btn btn-outline btn-compact btn-sm">Compute SHA-256</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================
         RSA Keys (generate/import/export/encrypt/decrypt)
         ============================ -->
    <section id="rsa" class="card p-3 mb-3">
      <div class="card-header">RSA Keys — Generate / Import / Export / Encrypt / Decrypt</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3 d-flex gap-2 align-items-end">
            <select id="rsaSize" class="form-select form-select-sm">
              <option>2048</option><option>3072</option><option>4096</option>
            </select>
            <button id="rsaGenBtn" class="btn btn-primary btn-sm">Generate</button>
          </div>

          <div class="col-md-9 d-flex gap-2 align-items-end">
            <input id="rsaImportPubFile" type="file" accept=".pem" class="form-control form-control-sm" style="width:auto">
            <button id="rsaImportPubBtn" class="btn btn-outline btn-compact btn-sm">Import public</button>
            <input id="rsaImportPrivFile" type="file" accept=".pem" class="form-control form-control-sm" style="width:auto">
            <button id="rsaImportPrivBtn" class="btn btn-outline btn-compact btn-sm">Import private</button>
            <button id="rsaExportPubBtn" class="btn btn-outline btn-compact btn-sm">Export public</button>
            <button id="rsaExportPrivBtn" class="btn btn-outline btn-compact btn-sm">Export private</button>
            <button id="rsaClearBtn" class="btn btn-danger btn-sm">Clear</button>
          </div>

          <div class="col-md-6">
            <label class="small-muted">Public PEM</label>
            <textarea id="rsaPublic" class="form-control monos" rows="6" placeholder="-----BEGIN PUBLIC KEY-----"></textarea>
          </div>

          <div class="col-md-6">
            <label class="small-muted">Private PEM</label>
            <textarea id="rsaPrivate" class="form-control monos" rows="6" placeholder="-----BEGIN PRIVATE KEY-----"></textarea>
          </div>

          <div class="col-12">
            <label class="small-muted">Message</label>
            <div class="input-eye mb-2">
              <textarea id="rsaMessage" class="form-control" rows="4"></textarea>
              <button class="eye-btn" data-target="rsaMessage"><i class="fa-regular fa-eye"></i></button>
            </div>

            <div class="d-flex gap-2 mb-2">
              <button id="rsaEncryptBtn" class="btn btn-primary btn-sm">Encrypt (public)</button>
              <button id="rsaDecryptBtn" class="btn btn-success btn-sm">Decrypt (private)</button>
              <button id="rsaCopyBtn" class="btn btn-outline btn-compact btn-sm"><i class="fa fa-copy"></i></button>
              <button id="rsaPasteBtn" class="btn btn-outline btn-compact btn-sm"><i class="fa fa-clipboard"></i></button>
            </div>

            <label class="small-muted">Output (base64 or plaintext)</label>
            <div id="rsaResult" class="p-2 border monos cipher-output" style="min-height:88px"></div>

            <div class="mt-2 small-muted">Stored: <span id="rsaStatus">no key</span> — Decrypt attempts: <span id="rsaAttempts">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================
         Text Encryption & Hashes
         ============================ -->
    <section id="text" class="card p-3 mb-3">
      <div class="card-header">Text Encryption, Hashes & Fingerprint Comparison</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="small-muted">Text input</label>
            <div class="input-eye mb-2">
              <textarea id="textInput" class="form-control" rows="6"></textarea>
              <button class="eye-btn" data-target="textInput"><i class="fa-regular fa-eye"></i></button>
            </div>

            <div class="d-flex gap-2 mb-2">
              <button id="caesarEncBtn" class="btn btn-outline btn-compact btn-sm">Caesar Enc</button>
              <button id="caesarDecBtn" class="btn btn-outline btn-compact btn-sm">Caesar Dec</button>
              <input id="caesarShift" type="number" class="form-control form-control-sm" style="width:80px" value="3">

              <button id="vigEncBtn" class="btn btn-outline btn-compact btn-sm">Vigenère Enc</button>
              <button id="vigDecBtn" class="btn btn-outline btn-compact btn-sm">Vigenère Dec</button>
              <input id="vigKey" type="text" class="form-control form-control-sm" value="KEY" style="width:120px">
            </div>

            <hr />

            <div class="d-flex gap-2 mb-2 flex-wrap">
              <button id="md5Btn" class="btn btn-outline btn-compact btn-sm">MD5</button>
              <button id="sha1Btn" class="btn btn-outline btn-compact btn-sm">SHA-1</button>
              <button id="sha256Btn" class="btn btn-outline btn-compact btn-sm">SHA-256</button>
              <button id="sha3Btn" class="btn btn-outline btn-compact btn-sm">SHA3-512</button>
              <button id="ripemdBtn" class="btn btn-outline btn-compact btn-sm">RIPEMD160</button>
              <select id="havalSelect" class="form-select form-select-sm" style="width:180px">
                <option>HAVAL-256 (placeholder)</option>
              </select>
              <button id="compareBtn" class="btn btn-primary btn-sm">Compare</button>
            </div>

            <div class="mt-2">
              <label class="small-muted">Hashes</label>
              <div id="hashOutput" class="p-2 border monos cipher-output"></div>
            </div>

            <div class="mt-3">
              <label class="small-muted">File hash (upload)</label>
              <div class="d-flex gap-2 align-items-center">
                <select id="fileHashAlgo" class="form-select form-select-sm" style="width:160px">
                  <option>SHA-1</option><option>SHA-256</option><option>MD5</option><option>SHA3</option><option>RIPEMD160</option><option>HAVAL-256</option>
                </select>
                <input id="fileHashFile" type="file" class="form-control form-control-sm" style="width:260px">
                <button id="computeFileHashBtn" class="btn btn-outline btn-compact btn-sm">Compute</button>
                <div id="fileHashResult" class="monos ms-2"></div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <label class="small-muted">AES text encryption</label>
            <div class="input-eye mb-2">
              <input id="aesPass" type="password" class="form-control" placeholder="passphrase">
              <button class="eye-btn" data-target="aesPass"><i class="fa-regular fa-eye"></i></button>
            </div>

            <div class="d-flex gap-2 align-items-center mb-2">
              <select id="aesMode" class="form-select form-select-sm" style="width:160px">
                <option value="CBC">AES-CBC (CryptoJS)</option>
                <option value="GCM">AES-GCM (SubtleCrypto)</option>
              </select>
              <button id="aesEncryptTextBtn" class="btn btn-primary btn-sm">Encrypt</button>
              <button id="aesDecryptTextBtn" class="btn btn-success btn-sm">Decrypt</button>
              <button id="copyTextOutBtn" class="btn btn-outline btn-compact btn-sm"><i class="fa fa-copy"></i></button>
            </div>

            <div class="mt-2">
              <label class="small-muted">Output</label>
              <div id="textOutput" class="p-2 border monos cipher-output" style="min-height:200px"></div>
            </div>

            <div class="mt-2 d-flex gap-2">
              <button id="saveTextOutBtn" class="btn btn-outline btn-compact btn-sm">Save</button>
              <button id="clearTextSavedBtn" class="btn btn-outline btn-compact btn-sm">Clear saved</button>
            </div>
            <ul id="textSaved" class="list-group mt-2"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================
         Steganography (LSB) with AES-protected payload
         ============================ -->
    <section id="stego" class="card p-3 mb-3">
      <div class="card-header">Image Steganography (LSB) — AES-protected payload</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <input id="coverFile" type="file" accept="image/*" class="form-control mb-2">
            <label class="small-muted">Message to hide</label>
            <textarea id="stegMsg" class="form-control mb-2" rows="4"></textarea>

            <div class="input-eye mb-2">
              <input id="stegPw" type="password" class="form-control" placeholder="password to protect payload">
              <button class="eye-btn" data-target="stegPw"><i class="fa-regular fa-eye"></i></button>
            </div>

            <div class="d-flex gap-2">
              <button id="stegHideBtn" class="btn btn-primary btn-sm">Hide</button>
              <input id="stegUpload" type="file" accept="image/*" class="form-control form-control-sm" style="width:auto">
              <button id="stegRevealBtn" class="btn btn-success btn-sm">Reveal (upload)</button>
              <button id="stegDownloadBtn" class="btn btn-outline btn-compact btn-sm" disabled>Download</button>
            </div>

            <div class="mt-2 small-muted">Stego status: <span id="stegStatus">Idle</span> — Attempts: <span id="stegAttempts">0</span></div>
          </div>

          <div class="col-md-6">
            <label class="small-muted">Preview</label>
            <canvas id="stegCanvas" class="border" style="max-width:100%;"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================
         Morse
         ============================ -->
    <section id="morse" class="card p-3 mb-3">
      <div class="card-header">Morse (Morris) — Table & Encode/Decode</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <textarea id="morseIn" class="form-control" rows="3"></textarea>
            <div class="d-flex gap-2 mt-2">
              <button id="morseEncBtn" class="btn btn-outline btn-compact btn-sm">Encode</button>
              <button id="morseDecBtn" class="btn btn-outline btn-compact btn-sm">Decode</button>
            </div>
          </div>

          <div class="col-md-6">
            <div id="morseOut" class="p-2 border monos cipher-output" style="min-height:120px"></div>
          </div>
        </div>

        <hr />
        <pre class="morse small-muted">
A  .-     B  -...   C  -.-.   D  -..    E  .
F  ..-.   G  --.    H  ....   I  ..     J  .---
K  -.-    L  .-..   M  --     N  -.     O  ---
P  .--.   Q  --.-   R  .-.    S  ...    T  -
U  ..-    V  ...-   W  .--    X  -..-   Y  -.--
Z  --..

0  -----  1  .----  2  ..---  3  ...--  4  ....-  5  .....
6  -....  7  --...  8  ---..  9  ----.

.  .-.-.-   ,  --..--   ?  ..--..   !  -.-.--   /  -..-.
(  -.--.    )  -.--.-   &  .-...    :  ---...
;  -.-.-.   =  -...-   +  .-.-.     -  -....-   _  ..--.-
"  .-..-.   $  ...-..-   @  .--.-.  #  ......   *  -.-.- 
        </pre>
      </div>
    </section>

    <!-- ============================
         Leak check
         ============================ -->
    <section id="leak" class="card p-3 mb-4">
      <div class="card-header">Password Leak Detection (simulated) & SHA-1 helper</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <input id="leakEmail" class="form-control" placeholder="email@example.com">
            <div class="d-flex gap-2 mt-2">
              <button id="checkLeakBtn" class="btn btn-outline btn-compact btn-sm">Check (sim)</button>
              <button id="copyLeakBtn" class="btn btn-outline btn-compact btn-sm"><i class="fa fa-copy"></i></button>
            </div>
            <div id="leakResult" class="mt-2 small-muted"></div>
          </div>

          <div class="col-md-8">
            <div class="input-eye mb-2">
              <input id="leakPass" type="password" class="form-control" placeholder="password to hash">
              <button class="eye-btn" data-target="leakPass"><i class="fa-regular fa-eye"></i></button>
            </div>
            <div class="d-flex gap-2">
              <button id="sha1PrefixBtn" class="btn btn-outline btn-compact btn-sm">Compute SHA-1 prefix</button>
              <div id="sha1Output" class="monos small-muted"></div>
            </div>
            <hr />
            <div>
              <h6 class="small-muted">Passphrase fingerprint (fingers)</h6>
              <div class="d-flex gap-2 align-items-center">
                <button id="fingerPrintBtn" class="btn btn-primary btn-sm">Compute fingerprints</button>
                <button id="copyFingerBtn" class="btn btn-outline btn-compact btn-sm"><i class="fa fa-copy"></i></button>
              </div>
              <pre id="fingerOutput" class="p-2 border monos cipher-output mt-2" style="min-height:100px"></pre>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="text-center mb-4">
      <small class="small-muted">Educational. Use HTTPS/localhost for SubtleCrypto and secure key operations.</small>
    </footer>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App logic -->
  <script>
  /********************
   Utilities
  *********************/
  function rngInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function copyText(txt){ navigator.clipboard?.writeText(txt).catch(()=>{}); }
  function copyElementText(el){ if(!el) return; const t = (el.value !== undefined) ? el.value : el.textContent; copyText(t); }
  function bytesToB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
  function b64ToBytes(b64){ const s = atob(b64); const u = new Uint8Array(s.length); for(let i=0;i<s.length;i++) u[i]=s.charCodeAt(i); return u; }
  function isBase64String(s){ try{ return !!KJUR.crypto.Util.b64tohex(s); } catch(e){ return false; } }

  // Eye button behavior (works for inputs, textareas, DIV)
  document.querySelectorAll('.eye-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = btn.getAttribute('data-target') || btn.previousElementSibling?.id;
      if(!target) return;
      const el = document.getElementById(target);
      if(!el) return;
      if(el.tagName === 'DIV'){
        if(el.style.filter === 'blur(6px)'){ el.style.filter='none'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>'; }
        else { el.style.filter='blur(6px)'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>'; }
        return;
      }
      if(el.tagName === 'INPUT'){
        if(el.type === 'password'){ el.type='text'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>'; }
        else { el.type='password'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>'; }
      } else if(el.tagName === 'TEXTAREA'){
        if(el.style.filter === 'blur(6px)'){ el.style.filter='none'; btn.innerHTML = '<i class="fa-regular fa-eye"></i>'; }
        else { el.style.filter='blur(6px)'; btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i>'; }
      }
    });
  });

  // Theme toggle simple (invert small)
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    const body = document.body;
    const current = body.getAttribute('data-theme') || 'dark';
    if(current === 'dark'){ body.setAttribute('data-theme','light'); document.getElementById('themeToggle').innerHTML = '<i class="fa fa-moon"></i>'; }
    else { body.setAttribute('data-theme','dark'); document.getElementById('themeToggle').innerHTML = '<i class="fa fa-sun"></i>'; }
  });

  /********************
   Password Generator & Emails
  *********************/
  const WORDS = ["lunacy","ceremony","kisser","cannon","devalue","alpha","bravo","charlie","delta","echo","foxtrot","gambit","harbor","island","jovial","krypton","lattice","magnet","nectar","opal","pylon","quartz","ripple","sable","tango","umbra","vivid","wander","xenon","yonder","zephyr","matrix","fusion","zenith","orbit","lunar","harbor"];

  function genWordsPass(count, cap){
    const parts=[];
    for(let i=0;i<count;i++){ let w = WORDS[rngInt(0,WORDS.length-1)]; if(cap) w = w.charAt(0).toUpperCase()+w.slice(1); parts.push(w); }
    return parts.join('-');
  }
  function genClassic(len, opts){
    const lower='abcdefghijklmnopqrstuvwxyz', upper='ABCDEFGHIJKLMNOPQRSTUVWXYZ', digits='0123456789', syms='!@#$%^&*()-_=+[]{};:,.<>?/';
    let pool='';
    if(opts.lower) pool+=lower; if(opts.upper) pool+=upper; if(opts.digits) pool+=digits; if(opts.symbols) pool+=syms;
    if(pool.length===0) pool = lower + upper;
    const arr=[]; for(let i=0;i<len;i++) arr.push(pool.charAt(rngInt(0,pool.length-1)));
    if(opts.group && opts.group>0){ const parts=[]; for(let i=0;i<arr.length;i+=opts.group) parts.push(arr.slice(i,i+opts.group).join('')); return parts.join(opts.sep||'-'); }
    return arr.join('');
  }

  function estimateEntropy(poolSize, length){ return Math.log2(Math.pow(poolSize, length)); }
  function prettyTime(sec){
    if(!isFinite(sec) || sec > 1e18) return '>> centuries';
    if(sec < 60) return Math.round(sec) + 's';
    if(sec < 3600) return Math.round(sec/60) + 'm';
    if(sec < 86400) return Math.round(sec/3600) + 'h';
    if(sec < 31536000) return Math.round(sec/86400) + 'd';
    return Math.round(sec/31536000) + 'y';
  }

  document.getElementById('pwMode').addEventListener('change', ()=>{
    const mode = document.getElementById('pwMode').value;
    document.getElementById('classicSettings').style.display = mode === 'classic' ? 'block' : 'none';
    document.getElementById('wordsSettings').style.display = mode === 'words' ? 'block' : 'none';
  });

  document.getElementById('generatePwBtn').addEventListener('click', ()=>{
    const mode = document.getElementById('pwMode').value;
    let out='';
    if(mode === 'words'){
      const count = Math.max(2, Math.min(12, +document.getElementById('wordsCount').value || 5));
      const cap = document.getElementById('wordsCap').checked;
      out = genWordsPass(count, cap);
      const bits = Math.log2(WORDS.length) * count;
      const sec = Math.pow(2,bits)/1e9;
      document.getElementById('pwStrengthBar').style.width = Math.min(100,bits) + '%';
      document.getElementById('pwStrengthInfo').textContent = `Entropy: ${bits.toFixed(1)} bits • Est. crack @1e9 g/s: ${prettyTime(sec)}`;
    } else {
      const len = Math.max(6, Math.min(256, +document.getElementById('pwLength').value || 16));
      const opts = { lower: document.getElementById('incLower').checked, upper: document.getElementById('incUpper').checked, digits: document.getElementById('incDigits').checked, symbols: document.getElementById('incSymbols').checked, group: +document.getElementById('groupSize').value || 0, sep: document.getElementById('groupSep').value || '-' };
      out = genClassic(len, opts);
      let pool = 0; if(opts.lower) pool+=26; if(opts.upper) pool+=26; if(opts.digits) pool+=10; if(opts.symbols) pool+=32; if(pool===0) pool = 52;
      const bits = Math.log2(Math.pow(pool, Math.max(1, out.replace(/[^A-Za-z0-9]/g,'').length)));
      const sec = Math.pow(2,bits)/1e9;
      document.getElementById('pwStrengthBar').style.width = Math.min(100, bits) + '%';
      document.getElementById('pwStrengthInfo').textContent = `Entropy: ${bits.toFixed(1)} bits • Est. crack @1e9 g/s: ${prettyTime(sec)}`;
    }
    const outEl = document.getElementById('pwOutput'); outEl.textContent = out; outEl.style.filter = 'none';
  });

  document.getElementById('copyPwBtn').addEventListener('click', ()=> copyElementText(document.getElementById('pwOutput')));
  document.getElementById('savePwBtn').addEventListener('click', ()=>{
    const v = document.getElementById('pwOutput').textContent || ''; if(!v) return;
    const ul = document.getElementById('pwSavedList');
    const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center monos';
    li.innerHTML = `<span>${v}</span><div><button class="btn btn-sm btn-outline btn-compact copy">Copy</button> <button class="btn btn-sm btn-danger del">Del</button></div>`;
    li.querySelector('.copy').addEventListener('click', ()=> copyText(v));
    li.querySelector('.del').addEventListener('click', ()=> li.remove());
    ul.prepend(li);
  });
  document.getElementById('clearSavedPwBtn').addEventListener('click', ()=> document.getElementById('pwSavedList').innerHTML = '');

  // Email merge
  function mergeEmail(base){
    try{
      const parts = base.split('@'); if(parts.length !== 2) return base;
      const local = parts[0], domain = parts[1];
      const suffix = Array.from({length:8}).map(()=> 'abcdefghijklmnopqrstuvwxyz0123456789'[rngInt(0,35)]).join('');
      const localCap = local.charAt(0).toUpperCase() + local.slice(1);
      return `${localCap}+${suffix}@${domain}`;
    }catch(e){ return base; }
  }

  document.getElementById('genEmailsBtn').addEventListener('click', ()=>{
    const base = document.getElementById('baseEmail').value || 'alpha@gmail.com';
    const out = document.getElementById('emailList'); out.innerHTML = '';
    for(let i=0;i<5;i++){ const e = mergeEmail(base); const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML = `<span>${e}</span><div><button class="btn btn-sm btn-outline btn-compact copy">Copy</button></div>`; li.querySelector('.copy').addEventListener('click', ()=> copyText(e)); out.appendChild(li); }
  });
  document.getElementById('copyEmailListBtn').addEventListener('click', ()=> copyText(Array.from(document.querySelectorAll('#emailList li span')).map(s=>s.textContent).join('\n')));

  // OTP
  document.getElementById('otpPhoneBtn').addEventListener('click', ()=> {
    const l = Math.max(4, +document.getElementById('otpLen').value || 6); const code = Array.from({length:l}).map(()=>rngInt(0,9)).join(''); document.getElementById('otpOutput').textContent = 'Phone OTP: ' + code;
  });
  document.getElementById('otpEmailBtn').addEventListener('click', ()=> {
    const l = Math.max(4, +document.getElementById('otpLen').value || 6); const code = Array.from({length:l}).map(()=>rngInt(0,9)).join(''); document.getElementById('otpOutput').textContent = 'Email OTP: ' + code;
  });
  document.getElementById('copyOtpBtn').addEventListener('click', ()=> copyText(document.getElementById('otpOutput').textContent || ''));

  /********************
   File encryption & SHA
  *********************/
  async function computeFileSHA256(file){
    const ab = await file.arrayBuffer();
    const digest = await crypto.subtle.digest('SHA-256', ab);
    return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  document.getElementById('computeFileShaBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('filePicker').files[0]; if(!f) return alert('Choose a file');
    document.getElementById('fileSha').textContent = 'computing...';
    const hex = await computeFileSHA256(f); document.getElementById('fileSha').textContent = hex;
  });
  document.getElementById('copyFileShaBtn').addEventListener('click', ()=> copyText(document.getElementById('fileSha').textContent || ''));

  // Encrypt file: CryptoJS AES-CBC payload stored as JSON .enc
  document.getElementById('fileEncryptBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('filePicker').files[0]; const pass = document.getElementById('filePass').value || '';
    if(!f || !pass){ document.getElementById('fileStatus').textContent = 'Choose file & enter pass'; return; }
    document.getElementById('fileStatus').textContent = 'Encrypting...';
    try{
      const ab = await f.arrayBuffer(); const wa = CryptoJS.lib.WordArray.create(new Uint8Array(ab));
      const salt = CryptoJS.lib.WordArray.random(128/8); const iv = CryptoJS.lib.WordArray.random(128/8);
      const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:200000 });
      const cipherWA = CryptoJS.AES.encrypt(wa, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).ciphertext;
      const payload = { filename: f.name, algo:'AES-CBC-CryptoJS', salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(cipherWA) };
      const blob = new Blob([JSON.stringify(payload)], { type:'application/octet-stream' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = f.name + '.enc'; a.click(); a.remove(); URL.revokeObjectURL(url);
      document.getElementById('fileStatus').textContent = 'Encrypted & downloaded';
    } catch(e){ document.getElementById('fileStatus').textContent = 'Encryption failed'; alert('Encrypt error: ' + e); }
  });

  // Decrypt file
  document.getElementById('fileDecryptBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('encUpload').files[0]; const pass = document.getElementById('filePass').value || '';
    if(!f || !pass){ document.getElementById('fileStatus').textContent = 'Upload .enc & enter pass'; return; }
    document.getElementById('fileStatus').textContent = 'Decrypting...';
    try{
      const txt = await f.text(); const payload = JSON.parse(txt);
      const salt = CryptoJS.enc.Base64.parse(payload.salt); const iv = CryptoJS.enc.Base64.parse(payload.iv);
      const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations: payload.iterations || 200000 });
      const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
      const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
      const out = new Uint8Array(dec.sigBytes); for(let i=0;i<dec.sigBytes;i++) out[i] = (dec.words[i>>>2] >>> (24 - (i%4)*8)) & 0xFF;
      const blob = new Blob([out], { type: 'application/octet-stream' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = payload.filename || 'decrypted.bin'; a.click(); a.remove(); URL.revokeObjectURL(url);
      document.getElementById('fileStatus').textContent = 'Decrypted & downloaded';
      document.getElementById('fileAttempts').textContent = 0;
    } catch(e){
      const el = document.getElementById('fileAttempts'); el.textContent = (+el.textContent || 0) + 1;
      document.getElementById('fileStatus').textContent = 'Decryption failed (bad pass or corrupted)';
    }
  });

  /********************
   RSA Keys (fixed)
  *********************/
  let rsaState = { pub: null, prv: null };
  function rsaSetStatus(msg){ document.getElementById('rsaStatus').textContent = msg; }
  function rsaSetAttempts(n){ document.getElementById('rsaAttempts').textContent = n; }

  // Generate keys
  document.getElementById('rsaGenBtn').addEventListener('click', ()=>{
    const bits = +document.getElementById('rsaSize').value || 2048;
    rsaSetStatus('Generating...');
    setTimeout(()=> {
      try{
        const kp = KEYUTIL.generateKeypair('RSA', bits);
        rsaState.pub = kp.pubKeyObj; rsaState.prv = kp.prvKeyObj;
        document.getElementById('rsaPublic').value = KEYUTIL.getPEM(kp.pubKeyObj);
        document.getElementById('rsaPrivate').value = KEYUTIL.getPEM(kp.prvKeyObj, 'PKCS8PRV');
        rsaSetStatus('Generated ' + bits);
        rsaSetAttempts(0);
      } catch(e){ rsaSetStatus('Generate failed'); alert('RSA generate error: ' + e); }
    }, 50);
  });

  // Import public
  document.getElementById('rsaImportPubBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('rsaImportPubFile').files[0]; if(!f) return alert('Select public PEM');
    try{
      const pem = await f.text(); const key = KEYUTIL.getKey(pem);
      rsaState.pub = key; document.getElementById('rsaPublic').value = KEYUTIL.getPEM(key);
      rsaSetStatus('Public imported');
    } catch(e){ rsaSetStatus('Import pub failed'); alert('Import public error: ' + e); }
  });

  // Import private
  document.getElementById('rsaImportPrivBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('rsaImportPrivFile').files[0]; if(!f) return alert('Select private PEM');
    try{
      const pem = await f.text(); const key = KEYUTIL.getKey(pem);
      rsaState.prv = key; document.getElementById('rsaPrivate').value = KEYUTIL.getPEM(key,'PKCS8PRV');
      rsaSetStatus('Private imported');
    } catch(e){ rsaSetStatus('Import priv failed'); alert('Import private error: ' + e); }
  });

  // Export keys (download textareas)
  document.getElementById('rsaExportPubBtn').addEventListener('click', ()=> {
    const pem = document.getElementById('rsaPublic').value || ''; if(!pem) return alert('No public key to export');
    const blob = new Blob([pem], { type:'application/x-pem-file' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='public.pem'; a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  document.getElementById('rsaExportPrivBtn').addEventListener('click', ()=> {
    const pem = document.getElementById('rsaPrivate').value || ''; if(!pem) return alert('No private key to export');
    const blob = new Blob([pem], { type:'application/x-pem-file' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='private.pem'; a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Clear
  document.getElementById('rsaClearBtn').addEventListener('click', ()=>{
    rsaState = { pub:null, prv:null }; document.getElementById('rsaPublic').value = ''; document.getElementById('rsaPrivate').value = ''; document.getElementById('rsaResult').textContent=''; rsaSetStatus('no key'); rsaSetAttempts(0);
  });

  // Encrypt (public) -> base64
  document.getElementById('rsaEncryptBtn').addEventListener('click', ()=>{
    const pubPem = document.getElementById('rsaPublic').value.trim(); const msg = document.getElementById('rsaMessage').value || '';
    if(!pubPem) return alert('Provide a public key (paste or import)');
    try{
      const key = KEYUTIL.getKey(pubPem);
      const hex = KJUR.crypto.Cipher.encrypt(msg, key, 'RSAOAEP'); // hex
      const b64 = KJUR.crypto.Util.hex2b64(hex);
      document.getElementById('rsaResult').textContent = b64;
      rsaSetStatus('Encrypted (base64)');
    } catch(e){ rsaSetStatus('Encrypt failed'); alert('RSA encrypt error: ' + e); }
  });

  // Decrypt (private). Accepts base64 or hex in rsaResult.
  document.getElementById('rsaDecryptBtn').addEventListener('click', ()=>{
    const privPem = document.getElementById('rsaPrivate').value.trim(); if(!privPem) return alert('Provide private key');
    try{
      const prv = KEYUTIL.getKey(privPem);
      let ct = document.getElementById('rsaResult').textContent.trim(); if(!ct) return alert('No ciphertext in output');
      let hex;
      if(isBase64String(ct)) hex = KJUR.crypto.Util.b64tohex(ct); else hex = ct.replace(/\s+/g,'');
      const dec = KJUR.crypto.Cipher.decrypt(hex, prv);
      document.getElementById('rsaResult').textContent = dec;
      rsaSetStatus('Decrypted');
      rsaSetAttempts(0);
    } catch(e){
      const el = document.getElementById('rsaAttempts'); el.textContent = (+el.textContent || 0) + 1;
      rsaSetStatus('Decrypt failed'); alert('RSA decrypt error: ' + e);
    }
  });

  document.getElementById('rsaCopyBtn').addEventListener('click', ()=> copyText(document.getElementById('rsaResult').textContent || ''));
  document.getElementById('rsaPasteBtn').addEventListener('click', async ()=> { try{ const s = await navigator.clipboard.readText(); document.getElementById('rsaMessage').value = s; } catch(e){ alert('Paste failed'); } });

  /********************
   Text ciphers, AES & Hashes
  *********************/
  function caesarEnc(s, shift){ return s.replace(/[A-Za-z]/g, c=>{ const base = c <= 'Z' ? 65 : 97; return String.fromCharCode((c.charCodeAt(0) - base + shift + 26) % 26 + base); }); }
  document.getElementById('caesarEncBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = caesarEnc(document.getElementById('textInput').value || '', +document.getElementById('caesarShift').value || 3));
  document.getElementById('caesarDecBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = caesarEnc(document.getElementById('textInput').value || '', (26 - (+document.getElementById('caesarShift').value || 3)) % 26));

  function vigenere(text, key, dec=false){
    if(!key) return text; let ki=0; const out=[];
    for(const ch of text){
      if(/[A-Za-z]/.test(ch)){
        const base = ch <= 'Z' ? 65 : 97;
        const k = key[ki%key.length].toUpperCase().charCodeAt(0) - 65;
        const shift = dec ? (26 - k) : k;
        out.push(String.fromCharCode((ch.charCodeAt(0) - base + shift) % 26 + base)); ki++;
      } else out.push(ch);
    }
    return out.join('');
  }
  document.getElementById('vigEncBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = vigenere(document.getElementById('textInput').value || '', document.getElementById('vigKey').value || 'KEY', false));
  document.getElementById('vigDecBtn').addEventListener('click', ()=> document.getElementById('textOutput').textContent = vigenere(document.getElementById('textInput').value || '', document.getElementById('vigKey').value || 'KEY', true));

  // Hash buttons
  document.getElementById('md5Btn').addEventListener('click', ()=> { const t = document.getElementById('textInput').value || ''; document.getElementById('hashOutput').textContent = 'MD5: ' + CryptoJS.MD5(t).toString(CryptoJS.enc.Hex); });
  document.getElementById('sha1Btn').addEventListener('click', ()=> { const t = document.getElementById('textInput').value || ''; document.getElementById('hashOutput').textContent = 'SHA-1: ' + CryptoJS.SHA1(t).toString(CryptoJS.enc.Hex); });
  document.getElementById('sha256Btn').addEventListener('click', ()=> { const t = document.getElementById('textInput').value || ''; document.getElementById('hashOutput').textContent = 'SHA-256: ' + CryptoJS.SHA256(t).toString(CryptoJS.enc.Hex); });
  document.getElementById('sha3Btn').addEventListener('click', ()=> { const t = document.getElementById('textInput').value || ''; document.getElementById('hashOutput').textContent = 'SHA3-512: ' + CryptoJS.SHA3(t, { outputLength:512 }).toString(CryptoJS.enc.Hex); });
  document.getElementById('ripemdBtn').addEventListener('click', ()=> { const t = document.getElementById('textInput').value || ''; document.getElementById('hashOutput').textContent = 'RIPEMD160: ' + CryptoJS.RIPEMD160(t).toString(CryptoJS.enc.Hex); });

  document.getElementById('compareBtn').addEventListener('click', ()=> {
    const t = document.getElementById('textInput').value || '';
    const md5 = CryptoJS.MD5(t).toString(), sha1 = CryptoJS.SHA1(t).toString(), sha256 = CryptoJS.SHA256(t).toString(), sha3 = CryptoJS.SHA3(t,{outputLength:512}).toString(), rip = CryptoJS.RIPEMD160(t).toString();
    document.getElementById('hashOutput').textContent = `MD5: ${md5}\nSHA1: ${sha1}\nSHA256: ${sha256}\nSHA3-512: ${sha3}\nRIPEMD160: ${rip}\nHAVAL-256: [placeholder — add HAVAL lib]`;
  });

  // file hash compute
  document.getElementById('computeFileHashBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('fileHashFile').files[0]; const algo = document.getElementById('fileHashAlgo').value;
    if(!f) return alert('Choose a file');
    document.getElementById('fileHashResult').textContent = 'computing...';
    const ab = await f.arrayBuffer();
    if(algo === 'SHA-1' || algo === 'SHA-256'){
      const map = { 'SHA-1':'SHA-1','SHA-256':'SHA-256' }; const buf = await crypto.subtle.digest(map[algo], ab); document.getElementById('fileHashResult').textContent = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
      return;
    }
    const wa = CryptoJS.lib.WordArray.create(new Uint8Array(ab));
    if(algo === 'MD5') document.getElementById('fileHashResult').textContent = CryptoJS.MD5(wa).toString();
    else if(algo === 'SHA3') document.getElementById('fileHashResult').textContent = CryptoJS.SHA3(wa, {outputLength:512}).toString();
    else if(algo === 'RIPEMD160') document.getElementById('fileHashResult').textContent = CryptoJS.RIPEMD160(wa).toString();
    else document.getElementById('fileHashResult').textContent = '[HAVAL-256 placeholder]';
  });

  // AES text encryption (CBC via CryptoJS; GCM via SubtleCrypto)
  async function subtleAesGcmEncrypt(plain, pass){
    const enc = new TextEncoder(); const salt = crypto.getRandomValues(new Uint8Array(16)); const iv = crypto.getRandomValues(new Uint8Array(12));
    const keyMat = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:200000, hash:'SHA-256' }, keyMat, { name:'AES-GCM', length:256 }, true, ['encrypt','decrypt']);
    const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, enc.encode(plain));
    return { algo:'AES-GCM-Subtle', salt: bytesToB64(salt), iv: bytesToB64(iv), ciphertext: bytesToB64(ct), iterations:200000 };
  }
  async function subtleAesGcmDecrypt(payload, pass){
    const enc = new TextEncoder(), dec = new TextDecoder();
    const salt = b64ToBytes(payload.salt); const iv = b64ToBytes(payload.iv);
    const keyMat = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations: payload.iterations || 200000, hash:'SHA-256' }, keyMat, { name:'AES-GCM', length:256 }, true, ['encrypt','decrypt']);
    const pt = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, b64ToBytes(payload.ciphertext).buffer);
    return dec.decode(pt);
  }

  document.getElementById('aesEncryptTextBtn').addEventListener('click', async ()=>{
    const pass = document.getElementById('aesPass').value || ''; if(!pass) return alert('Enter passphrase');
    const plain = document.getElementById('textInput').value || ''; const mode = document.getElementById('aesMode').value;
    if(mode === 'CBC'){
      const salt = CryptoJS.lib.WordArray.random(128/8); const iv = CryptoJS.lib.WordArray.random(128/8);
      const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:200000 });
      const enc = CryptoJS.AES.encrypt(plain, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
      const payload = { algo:'AES-CBC-CryptoJS', salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(enc.ciphertext) };
      document.getElementById('textOutput').textContent = JSON.stringify(payload);
    } else {
      try{ const payload = await subtleAesGcmEncrypt(plain, pass); document.getElementById('textOutput').textContent = JSON.stringify(payload); } catch(e){ alert('GCM encrypt failed: ' + e); }
    }
  });

  document.getElementById('aesDecryptTextBtn').addEventListener('click', async ()=>{
    const pass = document.getElementById('aesPass').value || ''; if(!pass) return alert('Enter passphrase');
    const outEl = document.getElementById('textOutput');
    try{
      const payload = JSON.parse(outEl.textContent || '{}');
      if(payload.algo === 'AES-CBC-CryptoJS'){
        const salt = CryptoJS.enc.Base64.parse(payload.salt); const iv = CryptoJS.enc.Base64.parse(payload.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations: payload.iterations || 200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const text = dec.toString(CryptoJS.enc.Utf8);
        if(!text) throw 'Decryption failed';
        outEl.textContent = text;
      } else if(payload.algo === 'AES-GCM-Subtle'){
        try{ const pt = await subtleAesGcmDecrypt(payload, pass); outEl.textContent = pt; } catch(e){ outEl.textContent = 'GCM decryption failed'; }
      } else outEl.textContent = 'Unknown AES payload';
    } catch(e){ outEl.textContent = 'AES decryption failed'; }
  });

  document.getElementById('copyTextOutBtn').addEventListener('click', ()=> copyElementText(document.getElementById('textOutput')));

  /********************
   Image Steganography (LSB) with AES payload
  *********************/
  const stegCanvas = document.getElementById('stegCanvas'); const stegCtx = stegCanvas.getContext('2d');
  let coverImage = null; let stegAttempts = 0;

  document.getElementById('coverFile').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const img = new Image();
    img.onload = ()=> { stegCanvas.width = img.width; stegCanvas.height = img.height; stegCtx.drawImage(img,0,0); coverImage = img; document.getElementById('stegStatus').textContent = 'Cover loaded'; };
    img.src = URL.createObjectURL(f);
  });

  function strToBits(str){
    const u = new TextEncoder().encode(str); const bits=[];
    for(const b of u) for(let i=7;i>=0;i--) bits.push((b>>i)&1);
    return bits;
  }
  function bitsToStr(bits){
    const bytes=[]; for(let i=0;i<bits.length;i+=8){ let v=0; for(let j=0;j<8 && (i+j)<bits.length;j++) v=(v<<1)|bits[i+j]; bytes.push(v); } return new TextDecoder().decode(new Uint8Array(bytes));
  }

  document.getElementById('stegHideBtn').addEventListener('click', ()=>{
    if(!coverImage) return alert('Upload a cover image first');
    const msg = document.getElementById('stegMsg').value || '';
    const pass = document.getElementById('stegPw').value || ''; if(!pass) return alert('Enter password');
    // AES encrypt payload
    const salt = CryptoJS.lib.WordArray.random(128/8); const iv = CryptoJS.lib.WordArray.random(128/8);
    const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations:200000 });
    const cipherWA = CryptoJS.AES.encrypt(msg, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }).ciphertext;
    const payload = JSON.stringify({ salt: CryptoJS.enc.Base64.stringify(salt), iv: CryptoJS.enc.Base64.stringify(iv), iterations:200000, ciphertext: CryptoJS.enc.Base64.stringify(cipherWA) });
    const b64 = btoa(payload);
    const bits = strToBits(b64);
    stegCtx.drawImage(coverImage,0,0);
    const imgd = stegCtx.getImageData(0,0,stegCanvas.width,stegCanvas.height); const px = imgd.data;
    const capacity = Math.floor(px.length/4)*3;
    if(bits.length + 32 > capacity){ alert('Message too large'); return; }
    const lenBits = []; for(let i=31;i>=0;i--) lenBits.push((bits.length>>i)&1);
    const all = lenBits.concat(bits);
    let bi=0;
    for(let i=0;i<px.length && bi<all.length;i+=4) for(let c=0;c<3 && bi<all.length;c++) px[i+c] = (px[i+c] & 0xFE) | all[bi++];
    stegCtx.putImageData(imgd,0,0);
    document.getElementById('stegStatus').textContent = 'Hidden — preview updated'; document.getElementById('stegDownloadBtn').disabled = false;
    document.getElementById('stegDownloadBtn').onclick = ()=> { stegCanvas.toBlob(b=>{ const url = URL.createObjectURL(b); const a = document.createElement('a'); a.href=url; a.download='stego.png'; a.click(); a.remove(); URL.revokeObjectURL(url); }); };
  });

  document.getElementById('stegRevealBtn').addEventListener('click', async ()=>{
    const f = document.getElementById('stegUpload').files[0]; if(!f) return alert('Select encoded image file');
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement('canvas'); c.width=img.width; c.height=img.height; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
      const imgd = ctx.getImageData(0,0,c.width,c.height); const px = imgd.data;
      const bits=[]; for(let i=0;i<px.length;i+=4){ bits.push(px[i]&1); bits.push(px[i+1]&1); bits.push(px[i+2]&1); }
      let len=0; for(let i=0;i<32;i++) len=(len<<1)|bits[i];
      const payloadBits = bits.slice(32,32+len); const b64 = bitsToStr(payloadBits);
      try{
        const payload = JSON.parse(atob(b64));
        const pass = document.getElementById('stegPw').value || ''; if(!pass) return alert('Enter password');
        const salt = CryptoJS.enc.Base64.parse(payload.salt); const iv = CryptoJS.enc.Base64.parse(payload.iv);
        const key = CryptoJS.PBKDF2(pass, salt, { keySize:256/32, iterations: payload.iterations || 200000 });
        const cipherWA = CryptoJS.enc.Base64.parse(payload.ciphertext);
        const dec = CryptoJS.AES.decrypt({ ciphertext: cipherWA }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const out = dec.toString(CryptoJS.enc.Utf8);
        if(!out) throw 'empty';
        document.getElementById('stegStatus').textContent = 'Revealed: ' + out;
        stegAttempts = 0; document.getElementById('stegAttempts').textContent = stegAttempts;
      } catch(e){
        stegAttempts++; document.getElementById('stegAttempts').textContent = stegAttempts; document.getElementById('stegStatus').textContent = 'Reveal failed (wrong pass or corrupted)';
      }
    };
    img.src = URL.createObjectURL(f);
  });

  /********************
   Morse encode/decode
  *********************/
  const MORSE = {
    'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---',
    'K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-',
    'U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..',
    '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
    '.':'.-.-.-',',':'--..--','?':'..--..','!':'-.-.--','/':'-..-.','(':'-.--.',')':'-.--.-','&':'.-...',';':'-.-.-.','=':'-...-',
    '+':'.-.-.','-':'-....-','_':'..--.-','"':'.-..-.','$':'...-..-','@':'.--.-.','#':'......','*':'-.-.-'
  };
  const REV = {}; for(const k in MORSE) REV[MORSE[k]] = k;
  document.getElementById('morseEncBtn').addEventListener('click', ()=> {
    const t = (document.getElementById('morseIn').value || '').toUpperCase();
    const out = t.split('').map(ch => ch === ' ' ? '/' : (MORSE[ch] || '?')).join(' ');
    document.getElementById('morseOut').textContent = out;
  });
  document.getElementById('morseDecBtn').addEventListener('click', ()=> {
    const s = (document.getElementById('morseIn').value || '').trim();
    const out = s.split(' ').map(token => token === '/' ? ' ' : (REV[token] || '?')).join('');
    document.getElementById('morseOut').textContent = out;
  });

  /********************
   Leak check & passphrase fingerprints
  *********************/
  const fakeDB = { 'test@example.com': true, 'admin@mail.com': true };
  document.getElementById('checkLeakBtn').addEventListener('click', ()=> {
    const e = (document.getElementById('leakEmail').value || '').toLowerCase().trim();
    document.getElementById('leakResult').textContent = fakeDB[e] ? 'Leaked (simulated)' : 'No record in simulated DB';
  });

  document.getElementById('sha1PrefixBtn').addEventListener('click', async ()=>{
    const p = document.getElementById('leakPass').value || ''; if(!p) return alert('Enter password');
    const buf = await crypto.subtle.digest('SHA-1', new TextEncoder().encode(p));
    const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    document.getElementById('sha1Output').textContent = `SHA1: ${hex} Prefix:${hex.slice(0,5)} Suffix:${hex.slice(5)}`;
  });

  // Fingers / fingerprint of passphrase — multiple hashes & comparison
  document.getElementById('fingerPrintBtn').addEventListener('click', ()=>{
    const p = document.getElementById('leakPass').value || ''; if(!p) return alert('Enter passphrase');
    const md5 = CryptoJS.MD5(p).toString(); const sha1 = CryptoJS.SHA1(p).toString(); const sha256 = CryptoJS.SHA256(p).toString();
    const sha3 = CryptoJS.SHA3(p, { outputLength: 512 }).toString(); const rip = CryptoJS.RIPEMD160(p).toString();
    document.getElementById('fingerOutput').textContent = `MD5: ${md5}\nSHA1: ${sha1}\nSHA256: ${sha256}\nSHA3-512: ${sha3}\nRIPEMD160: ${rip}\nHAVAL-256: [placeholder]`;
  });
  document.getElementById('copyFingerBtn').addEventListener('click', ()=> copyElementText(document.getElementById('fingerOutput')));

  // small convenience for showing/hiding outputs properly (reset eye icons when content appears)
  function resetEyeIconFor(targetId){
    document.querySelectorAll('.eye-btn[data-target="'+targetId+'"]').forEach(b=> b.innerHTML = '<i class="fa-regular fa-eye"></i>');
  }

  // reset some icons on load
  resetEyeIconFor('pwOutput');
  resetEyeIconFor('filePass');
  resetEyeIconFor('rsaMessage');
  resetEyeIconFor('textInput');

  /********************
   End of app
  *********************/
  </script>
</body>
</html>