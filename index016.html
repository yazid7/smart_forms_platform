<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تشفير الصور واسترداد البيانات</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body {background:#f5f7fa;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
        .container {max-width:600px;margin:30px auto;background:white;border-radius:10px;box-shadow:0 0 20px #0001;padding:24px;}
        .section {margin-bottom:32px;}
        label {font-weight:bold;display:block;margin-bottom:5px;}
        input,button {padding:7px;font-size:15px;margin-bottom:10px;}
        .result {background:#f8f9fa;padding:12px;border-radius:6px;margin-top:10px;}
        .status {padding:7px;margin-top:10px;border-radius:4px;}
        .success {background:#e8f5e9;border-left:4px solid #2ecc71;}
        .error {background:#ffebee;border-left:4px solid #e74c3c;}
        img {max-width:100%;margin-top:10px;border-radius:6px;}
    </style>
</head>
<body>
<div class="container">
    <h2>تشفير صورة وتحميلها (تحميل ملف مشفر)</h2>
    <div class="section">
        <label>اختر صورة لتشفيرها:</label>
        <input type="file" id="encrypt-image-file" accept="image/*">
        <label>أدخل مفتاح التشفير:</label>
        <input type="text" id="encrypt-image-key" placeholder="مفتاح التشفير">
        <button onclick="encryptImageAndDownload()">تشفير وتحميل الصورة</button>
        <div id="encrypt-status" class="status"></div>
    </div>

    <h2>رفع صورة مشفرة وفك تشفيرها</h2>
    <div class="section">
        <label>اختر ملف صورة مشفرة (بصيغة txt):</label>
        <input type="file" id="decrypt-image-file" accept=".txt">
        <label>أدخل مفتاح فك التشفير:</label>
        <input type="text" id="decrypt-image-key" placeholder="مفتاح التشفير">
        <button onclick="decryptImageAndShow()">فك تشفير وعرض الصورة</button>
        <div id="decrypt-status" class="status"></div>
        <div id="decrypted-image-area"></div>
    </div>
</div>
<script>
// تشفير صورة وتحميلها كملف نصي مشفر
function encryptImageAndDownload() {
    const fileInput = document.getElementById('encrypt-image-file');
    const key = document.getElementById('encrypt-image-key').value;
    const status = document.getElementById('encrypt-status');
    status.textContent = "";
    status.className = "status";
    if (!fileInput.files.length || !key) {
        status.textContent = "يرجى اختيار صورة وإدخال المفتاح";
        status.classList.add("error");
        return;
    }
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // تشفير بيانات الصورة (Base64)
            const encrypted = CryptoJS.AES.encrypt(e.target.result, key).toString();
            // حفظ كملف نصي
            const blob = new Blob([encrypted], {type: "text/plain"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "encrypted_image.txt";
            a.click();
            status.textContent = "تم تشفير الصورة وتحميل الملف بنجاح!";
            status.classList.add("success");
        } catch (err) {
            status.textContent = "فشل التشفير!";
            status.classList.add("error");
        }
    };
    reader.readAsDataURL(file);
}

// فك تشفير صورة مشفرة وعرضها/تحميلها
function decryptImageAndShow() {
    const fileInput = document.getElementById('decrypt-image-file');
    const key = document.getElementById('decrypt-image-key').value;
    const status = document.getElementById('decrypt-status');
    const imageArea = document.getElementById('decrypted-image-area');
    status.textContent = "";
    status.className = "status";
    imageArea.innerHTML = "";
    if (!fileInput.files.length || !key) {
        status.textContent = "يرجى اختيار ملف مشفر وإدخال المفتاح";
        status.classList.add("error");
        return;
    }
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // نص الصورة المشفر
            const encryptedText = e.target.result;
            // فك التشفير
            const decrypted = CryptoJS.AES.decrypt(encryptedText, key).toString(CryptoJS.enc.Utf8);
            if (!decrypted.startsWith("data:image")) {
                status.textContent = "المفتاح خاطئ أو الملف ليس صورة مشفرة!";
                status.classList.add("error");
                return;
            }
            // عرض الصورة
            imageArea.innerHTML = `<img src="${decrypted}" alt="الصورة بعد فك التشفير"><br>
            <button onclick="downloadDecryptedImage('${decrypted}')">تحميل الصورة الأصلية</button>`;
            status.textContent = "تم فك التشفير بنجاح!";
            status.classList.add("success");
        } catch (err) {
            status.textContent = "فشل فك التشفير!";
            status.classList.add("error");
        }
    };
    reader.readAsText(file);
}

// تحميل الصورة بعد فك التشفير
function downloadDecryptedImage(dataUrl) {
    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = "decrypted_image.png";
    a.click();
}
</script>
</body>
</html>