<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Toolkit — Convert · Merge · Split · Edit</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{--card-radius:12px}
    body{background:#f4f6f9;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .dropzone{border:2px dashed #e1e7ef;border-radius:12px;padding:20px;background:#fff;cursor:pointer}
    .thumb{width:120px;height:160px;border:1px solid #e7edf3;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff}
    .thumb img{max-width:100%;max-height:100%}
    #pdfViewer{height:600px;border:1px solid #e7edf3;border-radius:8px;background:#fff;overflow:auto;padding:8px}
    .page-thumb{position:relative;margin:8px}
    .page-controls{position:absolute;top:6px;right:6px;display:flex;gap:6px}
    .sig-canvas{border:1px solid #ddd;background:#fff}
    .small-muted{font-size:.85rem;color:#6c757d}
    footer.small{opacity:.7;margin-top:30px}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-3">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <i class="bi bi-file-earmark-break-fill fs-3 text-primary"></i>
        <div>
          <div style="font-weight:700">PDF Toolkit</div>
          <small class="small-muted">Convert · Merge · Split · Edit (client-side)</small>
        </div>
      </a>

      <div class="ms-auto">
        <a class="btn btn-outline-secondary btn-sm me-2" href="#" id="openLocal">Open local file</a>
        <a class="btn btn-primary btn-sm" id="downloadAll">Download</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row gx-3">
      <div class="col-lg-8">

        <div class="card mb-3">
          <div class="card-body">
            <ul class="nav nav-tabs" id="toolTabs" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-convert">Convert</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-merge">Merge</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-split">Split</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-organize">Organize</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-watermark">Watermark</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sign">Sign</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-protect">Protect</button></li>
            </ul>

            <div class="tab-content mt-3">
              <!-- Convert Tab -->
              <div class="tab-pane fade show active" id="tab-convert">
                <div class="row">
                  <div class="col-md-8">
                    <div id="dropzoneConvert" class="dropzone text-center" tabindex="0">
                      <div class="py-4">
                        <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
                        <div class="mt-2">Drag & drop files here or <input id="fileInputConvert" type="file" multiple style="display:inline-block" /></div>
                        <div class="small-muted mt-1">Images (.jpg/.png/.jpeg), .txt, or PDF files will be handled. Office files require server-side conversion.</div>
                      </div>
                    </div>
                    <div class="mt-3 d-flex gap-2">
                      <button class="btn btn-primary" id="btnConvertToPdf"><i class="bi bi-file-earmark-pdf-fill"></i> Convert → PDF</button>
                      <button class="btn btn-outline-secondary" id="btnConvertMergeAsPdf">Merge PDFs</button>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <h6>Settings</h6>
                    <label class="form-label small-muted">Image quality (for conversion)</label>
                    <input id="convertQuality" type="range" min="0.3" max="1" step="0.05" value="0.9" />
                    <div class="mt-2 small-muted">Output file name</div>
                    <input id="outputNameConvert" class="form-control" placeholder="converted.pdf" />
                  </div>
                </div>
              </div>

              <!-- Merge Tab -->
              <div class="tab-pane fade" id="tab-merge">
                <div class="row">
                  <div class="col-md-8">
                    <div id="dropzoneMerge" class="dropzone text-center">
                      <div class="py-4">
                        <i class="bi bi-files fs-1 text-secondary"></i>
                        <div class="mt-2">Add PDF files to merge</div>
                        <input id="fileInputMerge" type="file" multiple accept="application/pdf" style="display:block;margin:8px auto" />
                      </div>
                    </div>
                    <div class="mt-3 d-flex gap-2">
                      <button class="btn btn-success" id="btnMergePdf"><i class="bi bi-arrows-collapse"></i> Merge PDFs</button>
                      <button class="btn btn-outline-secondary" id="btnClearMerge">Clear</button>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <h6>Order files</h6>
                    <div id="mergeFileList" class="list-group"></div>
                    <div class="small-muted mt-2">Drag to reorder before merging.</div>
                  </div>
                </div>
              </div>

              <!-- Split Tab -->
              <div class="tab-pane fade" id="tab-split">
                <div class="row">
                  <div class="col-md-8">
                    <div id="dropzoneSplit" class="dropzone text-center">
                      <div class="py-4">
                        <i class="bi bi-scissors fs-1 text-secondary"></i>
                        <div class="mt-2">Drop a PDF to split / extract pages</div>
                        <input id="fileInputSplit" type="file" accept="application/pdf" style="display:block;margin:8px auto" />
                      </div>
                    </div>

                    <div class="mt-3">
                      <label class="form-label">Pages to extract (e.g. 1,3-5)</label>
                      <input id="splitPagesInput" class="form-control" placeholder="1,3-5" />
                      <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-warning" id="btnSplitExtract">Extract</button>
                        <button class="btn btn-outline-secondary" id="btnSplitAll">Split all pages into separate PDFs</button>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <h6>Preview</h6>
                    <div id="splitPreview"></div>
                  </div>
                </div>
              </div>

              <!-- Organize Tab -->
              <div class="tab-pane fade" id="tab-organize">
                <div class="row">
                  <div class="col-md-12 mb-2">
                    <div id="dropzoneOrganize" class="dropzone text-center">
                      <div class="py-3"><i class="bi bi-kanban fs-1"></i><div class="mt-1">Drop a PDF to view pages and organize</div><input id="fileInputOrganize" type="file" accept="application/pdf" style="display:block;margin:8px auto" /></div>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <h6>Pages</h6>
                    <div id="pagesContainer" class="d-flex flex-wrap"></div>
                    <div class="small-muted mt-2">Drag pages to reorder, or delete pages you don't want.</div>
                  </div>

                  <div class="col-md-8">
                    <h6>Preview & Actions</h6>
                    <div id="pdfViewer" class="mb-2"></div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-primary" id="btnExportOrganized">Export Organized PDF</button>
                      <button class="btn btn-outline-secondary" id="btnRotateSelection">Rotate Selected</button>
                      <button class="btn btn-danger" id="btnDeleteSelected">Delete Selected</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Watermark Tab -->
              <div class="tab-pane fade" id="tab-watermark">
                <div class="row">
                  <div class="col-md-8">
                    <div class="mb-2">
                      <input id="fileInputWatermark" type="file" accept="application/pdf" />
                    </div>
                    <label class="form-label">Watermark text</label>
                    <input id="wmText" class="form-control" placeholder="Confidential — Example" />
                    <div class="d-flex gap-2 mt-2">
                      <button class="btn btn-outline-secondary" id="btnWatermarkApply"><i class="bi bi-droplet"></i> Apply watermark</button>
                      <button class="btn btn-outline-secondary" id="btnAddPageNumbers">Add page numbers</button>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <h6>Options</h6>
                    <label class="form-label small-muted">Opacity</label>
                    <input id="wmOpacity" type="range" min="0.05" max="0.9" step="0.05" value="0.12" />
                    <label class="form-label small-muted mt-2">Font size</label>
                    <input id="wmSize" type="number" class="form-control" value="48" />
                    <label class="form-label small-muted mt-2">Position</label>
                    <select id="wmPosition" class="form-select">
                      <option value="diagonal">Diagonal</option>
                      <option value="top-left">Top left</option>
                      <option value="center">Center</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Sign Tab -->
              <div class="tab-pane fade" id="tab-sign">
                <div class="row">
                  <div class="col-md-6">
                    <h6>Draw signature</h6>
                    <canvas id="sigCanvas" width="420" height="120" class="sig-canvas"></canvas>
                    <div class="mt-2 d-flex gap-2">
                      <button class="btn btn-secondary btn-sm" id="sigClear">Clear</button>
                      <button class="btn btn-primary btn-sm" id="sigSave">Save signature</button>
                    </div>

                    <hr />
                    <h6 class="mt-2">Place signature</h6>
                    <div class="small-muted">Open a PDF in Organize tab, then click a page thumbnail to place signature. You can resize/position when placing.</div>
                    <div class="mt-2">
                      <button class="btn btn-outline-primary" id="btnPlaceLastSignature">Place last signature on selected page</button>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <h6>Saved signatures</h6>
                    <div id="savedSigs" class="d-flex gap-2 flex-wrap"></div>
                  </div>
                </div>
              </div>

              <!-- Protect Tab -->
              <div class="tab-pane fade" id="tab-protect">
                <div class="row">
                  <div class="col-md-8">
                    <div class="mb-2">
                      <input id="fileInputProtect" type="file" />
                    </div>
                    <label class="form-label">Password</label>
                    <input id="protectPassword" class="form-control" type="password" />
                    <div class="mt-2 d-flex gap-2">
                      <button class="btn btn-dark" id="btnEncryptFile">Encrypt file (AES)</button>
                      <button class="btn btn-outline-secondary" id="btnDecryptFile">Decrypt file</button>
                    </div>

                    <div class="mt-3 small-muted">
                      <strong>Note:</strong> AES file encryption wraps the entire file in an encrypted blob (yourfile.pdf → yourfile.pdf.enc). This is strong for personal storage and sharing, but it is NOT the same as PDF-standard open-password (which requires server-side tools to create reliably).
                    </div>
                  </div>

                  <div class="col-md-4">
                    <h6>Files</h6>
                    <div id="protectedList"></div>
                  </div>
                </div>
              </div>

            </div> <!-- tab content -->

          </div>
        </div>

        <footer class="small text-center">Built with pdf.js, pdf-lib, SortableJS, FileSaver.js — client-side. For Office → PDF or true PDF open-password protection, a small server helper is needed.</footer>

      </div> <!-- left column -->

      <div class="col-lg-4">
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title">Current Document</h6>
            <div id="docInfo" class="small-muted">No file loaded.</div>

            <hr/>

            <h6>Quick Actions</h6>
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary" id="btnPreview">Open in viewer</button>
              <button class="btn btn-outline-success" id="btnSavePdf">Save current PDF</button>
              <button class="btn btn-outline-danger" id="btnClearAll">Clear all</button>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <h6>Progress</h6>
            <div class="progress mb-2"><div id="progBar" class="progress-bar" role="progressbar" style="width:0%">0%</div></div>
            <div id="logBox" style="height:160px;overflow:auto;font-size:.9rem;color:#333;"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ---- Utility & State ----
  const { PDFDocument, StandardFonts, rgb, degrees } = PDFLib;
  let currentPdfBytes = null;
  let currentPdfDoc = null;
  let currentPdfPages = []; // holds page objects indices order
  let logBox = document.getElementById('logBox');
  function log(msg){ const t = document.createElement('div'); t.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; logBox.prepend(t); }
  function setProgress(p){ const b = document.getElementById('progBar'); b.style.width = `${p}%`; b.textContent = `${p}%`; }

  // Small helpers
  function fileToArrayBuffer(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload = ()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(file); }); }
  function blobToArrayBuffer(blob){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(blob); }); }
  function saveBlob(blob, filename){ saveAs(blob, filename); }

  // ---- PDF.js Viewer functions ----
  const pdfjsLib = window['pdfjs-dist/build/pdf'] || window['pdfjs-dist']; // compatibility
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

  const viewerEl = document.getElementById('pdfViewer');
  async function renderPdfInViewer(bytes){
    viewerEl.innerHTML = '';
    if(!bytes) return;
    const uint8 = new Uint8Array(bytes);
    const doc = await pdfjsLib.getDocument({data:uint8}).promise;
    for(let p=1;p<=doc.numPages;p++){
      const page = await doc.getPage(p);
      const viewport = page.getViewport({scale:1.2});
      const canvas = document.createElement('canvas');
      canvas.style.marginBottom = '10px';
      canvas.width = viewport.width; canvas.height = viewport.height;
      const ctx = canvas.getContext('2d');
      await page.render({canvasContext:ctx, viewport}).promise;
      // Add label
      const wrapper = document.createElement('div');
      wrapper.className='mb-2';
      const label = document.createElement('div');
      label.textContent = `Page ${p} — ${Math.round(viewport.width)}×${Math.round(viewport.height)}`;
      label.className = 'small-muted';
      wrapper.appendChild(label);
      wrapper.appendChild(canvas);
      viewerEl.appendChild(wrapper);
    }
    log('PDF rendered in viewer ('+doc.numPages+' pages).');
  }

  // ---- Convert Tab ----
  const fileInputConvert = document.getElementById('fileInputConvert');
  document.getElementById('dropzoneConvert').addEventListener('click', ()=>fileInputConvert.click());
  let convertQueue = [];
  fileInputConvert.addEventListener('change', ()=>convertQueue = Array.from(fileInputConvert.files));

  document.getElementById('btnConvertToPdf').addEventListener('click', async ()=>{
    if(!convertQueue.length) return alert('Select files to convert.');
    setProgress(5); log('Starting conversion...');
    const outDoc = await PDFDocument.create();
    for(let i=0;i<convertQueue.length;i++){
      const f = convertQueue[i];
      if(f.type.startsWith('image/')){
        const arr = await fileToArrayBuffer(f);
        let img;
        if(f.type === 'image/png') img = await outDoc.embedPng(arr);
        else img = await outDoc.embedJpg(arr);
        const page = outDoc.addPage([img.width, img.height]);
        page.drawImage(img,{x:0,y:0,width:img.width,height:img.height});
        log(`Embedded image: ${f.name}`);
      } else if(f.type === 'text/plain'){
        const text = await f.text();
        const page = outDoc.addPage();
        const helv = await outDoc.embedFont(StandardFonts.Helvetica);
        page.drawText(text,{x:40,y:700,size:12,font:helv});
        log(`Embedded text file: ${f.name}`);
      } else if(f.type === 'application/pdf'){
        const arr = await fileToArrayBuffer(f);
        const src = await PDFDocument.load(arr);
        const copied = await outDoc.copyPages(src, src.getPageIndices());
        copied.forEach(p=>outDoc.addPage(p));
        log(`Merged PDF file: ${f.name}`);
      } else {
        log(`Skipped unsupported ${f.name}`);
      }
      setProgress(20 + Math.round((i/convertQueue.length)*60));
    }
    const bytes = await outDoc.save();
    currentPdfBytes = bytes; currentPdfDoc = await PDFDocument.load(bytes);
    setProgress(100); log('Conversion complete.');
    const outName = (document.getElementById('outputNameConvert').value || 'converted.pdf');
    saveBlob(new Blob([bytes],{type:'application/pdf'}), outName);
    renderPdfInViewer(bytes);
    updateDocInfo(bytes);
  });

  // ---- Merge Tab ----
  const mergeList = document.getElementById('mergeFileList');
  let mergeFiles = [];
  document.getElementById('fileInputMerge').addEventListener('change', (e)=>{
    const files = Array.from(e.target.files).filter(f=>f.type==='application/pdf');
    files.forEach(f=>{
      const item = document.createElement('div'); item.className='list-group-item d-flex align-items-center justify-content-between';
      item.textContent = f.name;
      const del = document.createElement('button'); del.className='btn btn-sm btn-outline-danger'; del.innerHTML='<i class="bi bi-x-lg"></i>';
      del.addEventListener('click', ()=>{ mergeList.removeChild(item); mergeFiles = mergeFiles.filter(x=>x.file!==f); });
      item.appendChild(del);
      mergeList.appendChild(item);
      mergeFiles.push({file:f, el:item});
    });
    // enable drag reorder
    new Sortable(mergeList, {animation:150});
  });

  document.getElementById('btnMergePdf').addEventListener('click', async ()=>{
    if(!mergeFiles.length) return alert('Add PDFs to merge.');
    setProgress(10); log('Merging PDFs...');
    const merged = await PDFDocument.create();
    // respect DOM order
    const items = Array.from(mergeList.children);
    for(let idx=0; idx<items.length; idx++){
      const name = items[idx].firstChild.textContent;
      const mf = mergeFiles.find(m=>m.file.name===name);
      if(!mf) continue;
      const arr = await fileToArrayBuffer(mf.file);
      const src = await PDFDocument.load(arr);
      const copied = await merged.copyPages(src, src.getPageIndices());
      copied.forEach(p=>merged.addPage(p));
      setProgress(10 + Math.round(((idx+1)/items.length)*70));
      log('Appended '+mf.file.name);
    }
    const bytes = await merged.save();
    currentPdfBytes = bytes; currentPdfDoc = await PDFDocument.load(bytes);
    setProgress(100); log('Merge complete.');
    saveBlob(new Blob([bytes],{type:'application/pdf'}),'merged.pdf');
    renderPdfInViewer(bytes);
    updateDocInfo(bytes);
  });

  // ---- Split Tab ----
  let splitSource = null;
  const splitPreview = document.getElementById('splitPreview');
  document.getElementById('fileInputSplit').addEventListener('change', async (e)=>{
    if(!e.target.files.length) return;
    splitSource = e.target.files[0];
    splitPreview.innerHTML = `<div class="small-muted">Loaded: ${splitSource.name}</div>`;
    log('Loaded file for splitting: '+splitSource.name);
  });

  function parsePagesSpec(spec, total){
    const parts = spec.split(',').map(s=>s.trim()).filter(Boolean);
    const ranges = [];
    for(const p of parts){
      if(p.includes('-')){
        const [a,b] = p.split('-').map(x=>parseInt(x));
        if(isNaN(a)||isNaN(b)) continue;
        ranges.push({start:Math.max(1,a), end:Math.min(total,b)});
      } else {
        const n = parseInt(p); if(isNaN(n)) continue;
        ranges.push({start:n, end:n});
      }
    }
    return ranges;
  }

  document.getElementById('btnSplitExtract').addEventListener('click', async ()=>{
    if(!splitSource) return alert('Load a PDF first.');
    const arr = await fileToArrayBuffer(splitSource);
    const src = await PDFDocument.load(arr);
    const total = src.getPageCount();
    const spec = document.getElementById('splitPagesInput').value || '';
    if(!spec) return alert('Enter page numbers or ranges.');
    const ranges = parsePagesSpec(spec, total);
    const outDoc = await PDFDocument.create();
    for(const r of ranges){
      for(let p=r.start-1;p<=(r.end-1);p++){
        if(p<0||p>=total) continue;
        const [copied] = await outDoc.copyPages(src,[p]);
        outDoc.addPage(copied);
      }
    }
    const bytes = await outDoc.save();
    saveBlob(new Blob([bytes],{type:'application/pdf'}),'extracted.pdf');
    renderPdfInViewer(bytes);
    log('Extracted pages into extracted.pdf');
  });

  document.getElementById('btnSplitAll').addEventListener('click', async ()=>{
    if(!splitSource) return alert('Load a PDF first.');
    const arr = await fileToArrayBuffer(splitSource);
    const src = await PDFDocument.load(arr); const total = src.getPageCount();
    for(let p=0;p<total;p++){
      const out = await PDFDocument.create(); const [copied] = await out.copyPages(src,[p]); out.addPage(copied);
      const bytes = await out.save();
      saveBlob(new Blob([bytes],{type:'application/pdf'}), `page-${p+1}.pdf`);
      setProgress(Math.round(((p+1)/total)*100));
    }
    log(`Split into ${total} files.`);
    setProgress(100);
  });

  // ---- Organize Tab ----
  const fileInputOrganize = document.getElementById('fileInputOrganize');
  const pagesContainer = document.getElementById('pagesContainer');
  let organizeSourceBytes = null;
  let organizePdfDoc = null;
  let pageThumbs = []; // {pageIndex, thumbEl, selected}

  fileInputOrganize.addEventListener('change', async (e)=>{
    if(!e.target.files.length) return;
    const f = e.target.files[0];
    organizeSourceBytes = await fileToArrayBuffer(f);
    organizePdfDoc = await PDFDocument.load(organizeSourceBytes);
    await buildPageThumbnails(organizeSourceBytes);
    renderPdfInViewer(organizeSourceBytes);
    currentPdfBytes = organizeSourceBytes; currentPdfDoc = organizePdfDoc;
    updateDocInfo(organizeSourceBytes);
    log('Loaded PDF for organizing: '+f.name);
  });

  async function buildPageThumbnails(bytes){
    pagesContainer.innerHTML = '';
    pageThumbs = [];
    const uint8 = new Uint8Array(bytes);
    const doc = await pdfjsLib.getDocument({data:uint8}).promise;
    for(let p=1;p<=doc.numPages;p++){
      const page = await doc.getPage(p);
      const viewport = page.getViewport({scale:0.9});
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width; canvas.height = viewport.height;
      const ctx = canvas.getContext('2d');
      await page.render({canvasContext: ctx, viewport}).promise;
      const wrapper = document.createElement('div');
      wrapper.className='page-thumb';
      wrapper.style.cursor='grab';
      wrapper.dataset.page = p-1;
      wrapper.appendChild(canvas);
      const controls = document.createElement('div');
      controls.className='page-controls';
      controls.innerHTML = `<button class="btn btn-sm btn-light select-btn"><i class="bi bi-check2"></i></button>
                            <button class="btn btn-sm btn-light del-btn"><i class="bi bi-trash"></i></button>`;
      wrapper.appendChild(controls);
      pagesContainer.appendChild(wrapper);
      pageThumbs.push({pageIndex:p-1, el:wrapper, selected:false});
      // click select
      wrapper.querySelector('.select-btn').addEventListener('click', ()=>{ wrapper.classList.toggle('border-primary'); wrapper.classList.toggle('border-3'); });
      wrapper.querySelector('.del-btn').addEventListener('click', ()=>{ wrapper.remove(); pageThumbs = pageThumbs.filter(t=>t.el!==wrapper); });
    }
    // make sortable
    new Sortable(pagesContainer, {animation:200});
    log('Thumbnails built ('+doc.numPages+' pages).');
  }

  document.getElementById('btnExportOrganized').addEventListener('click', async ()=>{
    // build pdf according to order in DOM
    if(!organizePdfDoc) return alert('Load a PDF first.');
    setProgress(10); log('Exporting organized PDF...');
    const src = await PDFDocument.load(organizeSourceBytes);
    const out = await PDFDocument.create();
    const orderEls = Array.from(pagesContainer.children);
    for(let i=0;i<orderEls.length;i++){
      const idx = parseInt(orderEls[i].dataset.page,10);
      const [copied] = await out.copyPages(src,[idx]);
      out.addPage(copied);
      setProgress(10 + Math.round(((i+1)/orderEls.length)*80));
    }
    const bytes = await out.save();
    saveBlob(new Blob([bytes],{type:'application/pdf'}),'organized.pdf');
    renderPdfInViewer(bytes);
    currentPdfBytes = bytes; currentPdfDoc = await PDFDocument.load(bytes);
    setProgress(100); log('Organized PDF exported.');
  });

  document.getElementById('btnRotateSelection').addEventListener('click', async ()=>{
    // rotate currently selected thumbnails by 90 degrees
    const selected = Array.from(pagesContainer.querySelectorAll('.border-3'));
    if(!selected.length) return alert('Select page(s) by clicking the check button on thumbnails.');
    const src = await PDFDocument.load(organizeSourceBytes);
    const out = await PDFDocument.create();
    // build list with rotations applied by toggling rotation for selected pages
    const orderEls = Array.from(pagesContainer.children);
    for(let i=0;i<orderEls.length;i++){
      const idx = parseInt(orderEls[i].dataset.page,10);
      const [copied] = await out.copyPages(src,[idx]);
      if(orderEls[i].classList.contains('border-3')) copied.setRotation(degrees(90));
      out.addPage(copied);
    }
    const bytes = await out.save();
    saveBlob(new Blob([bytes],{type:'application/pdf'}),'rotated-selected.pdf');
    renderPdfInViewer(bytes);
    currentPdfBytes = bytes; currentPdfDoc = await PDFDocument.load(bytes);
    log('Rotated selected pages and exported.');
  });

  document.getElementById('btnDeleteSelected').addEventListener('click', async ()=>{
    const selectedEls = Array.from(pagesContainer.querySelectorAll('.border-3'));
    if(!selectedEls.length) return alert('Select pages to delete.');
    selectedEls.forEach(el=>el.remove());
    log('Deleted selected pages from view. Use Export Organized to save changes.');
  });

  // ---- Watermark Tab ----
  document.getElementById('btnWatermarkApply').addEventListener('click', async ()=>{
    const fileIn = document.getElementById('fileInputWatermark');
    if(!fileIn.files.length) return alert('Select a PDF first.');
    const file = fileIn.files[0];
    const arr = await fileToArrayBuffer(file);
    const src = await PDFDocument.load(arr);
    const out = await PDFDocument.create();
    const helv = await out.embedFont(StandardFonts.HelveticaBold);
    const text = document.getElementById('wmText').value || 'Confidential';
    const opacity = parseFloat(document.getElementById('wmOpacity').value || 0.12);
    const size = parseInt(document.getElementById('wmSize').value || 48);
    for(let i=0;i<src.getPageCount();i++){
      const [copied] = await out.copyPages(src,[i]);
      const {width,height} = copied.getSize();
      const pos = document.getElementById('wmPosition').value;
      if(pos==='diagonal'){
        copied.drawText(text, {x: width/4, y: height/2, size, font:helv, rotate: degrees(-30), opacity});
      } else if(pos==='top-left'){
        copied.drawText(text, {x:40,y:height-60,size,font:helv,opacity});
      } else {
        copied.drawText(text, {x:width/2- (text.length*5),y:height/2,size,font:helv,opacity});
      }
      out.addPage(copied);
    }
    const bytes = await out.save();
    saveBlob(new Blob([bytes],{type:'application/pdf'}),'watermarked.pdf');
    renderPdfInViewer(bytes);
    currentPdfBytes = bytes; currentPdfDoc = await PDFDocument.load(bytes);
    log('Watermark applied.');
  });

  document.getElementById('btnAddPageNumbers').addEventListener('click', async ()=>{
    const fileIn = document.getElementById('fileInputWatermark');
    if(!fileIn.files.length) return alert('Select a PDF first.');
    const file = fileIn.files[0];
    const arr = await fileToArrayBuffer(file);
    const src = await PDFDocument.load(arr);
    const out = await PDFDocument.create();
    const helv = await out.embedFont(StandardFonts.Helvetica);
    const total = src.getPageCount();
    for(let i=0;i<total;i++){
      const [copied] = await out.copyPages(src,[i]);
      const {width,height} = copied.getSize();
      copied.drawText(`${i+1} / ${total}`, {x: width/2-20, y: 20, size: 12, font: helv});
      out.addPage(copied);
    }
    const bytes = await out.save();
    saveBlob(new Blob([bytes],{type:'application/pdf'}),'pagenumbers.pdf');
    renderPdfInViewer(bytes);
    currentPdfBytes = bytes; currentPdfDoc = await PDFDocument.load(bytes);
    log('Page numbers added.');
  });

  // ---- Sign Tab ----
  const sigCanvas = document.getElementById('sigCanvas');
  const sigCtx = sigCanvas.getContext('2d'); sigCtx.lineWidth = 2; sigCtx.strokeStyle = '#111';
  let drawing = false; let lastSigData = null; const savedSignatures = [];
  sigCanvas.addEventListener('pointerdown', e=>{ drawing=true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX,e.offsetY); });
  sigCanvas.addEventListener('pointerup', ()=>{ drawing=false; });
  sigCanvas.addEventListener('pointermove', e=>{ if(!drawing) return; sigCtx.lineTo(e.offsetX,e.offsetY); sigCtx.stroke(); });

  document.getElementById('sigClear').addEventListener('click', ()=>{ sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); });
  document.getElementById('sigSave').addEventListener('click', ()=>{
    const dataURL = sigCanvas.toDataURL('image/png');
    lastSigData = dataURL;
    const img = document.createElement('img'); img.src=dataURL; img.style.height='40px'; img.style.border='1px solid #ddd'; img.style.borderRadius='4px';
    document.getElementById('savedSigs').appendChild(img);
    savedSignatures.push(dataURL);
    log('Signature saved.');
  });

  document.getElementById('btnPlaceLastSignature').addEventListener('click', async ()=>{
    if(!lastSigData) return alert('Draw and save a signature first.');
    if(!organizeSourceBytes) return alert('Load a PDF in Organize tab first.');
    // Place signature on first selected page (or first page by default)
    const pageEls = Array.from(pagesContainer.children);
    if(!pageEls.length) return alert('No pages found.');
    const targetEl = pageEls.find(el=>el.classList.contains('border-3')) || pageEls[0];
    const pageIndex = parseInt(targetEl.dataset.page,10);
    // embed signature into PDF on that page
    const src = await PDFDocument.load(organizeSourceBytes);
    const out = await PDFDocument.create();
    const sigBytes = await (await fetch(lastSigData)).arrayBuffer();
    const sigImg = await out.embedPng(sigBytes);
    for(let i=0;i<src.getPageCount();i++){
      const [copied] = await out.copyPages(src,[i]);
      if(i===pageIndex){
        const {width,height} = copied.getSize();
        const w = Math.min(200, width*0.3);
        const h = (sigImg.height / sigImg.width) * w;
        copied.drawImage(sigImg, {x: width - w - 40, y: 40, width: w, height: h});
      }
      out.addPage(copied);
    }
    const bytes = await out.save();
    currentPdfBytes = bytes; currentPdfDoc = await PDFDocument.load(bytes);
    saveBlob(new Blob([bytes],{type:'application/pdf'}),'signed.pdf');
    renderPdfInViewer(bytes);
    log('Signature placed on page '+(pageIndex+1));
  });

  // ---- Protect Tab (AES file encrypt/decrypt) ----
  document.getElementById('btnEncryptFile').addEventListener('click', async ()=>{
    const f = document.getElementById('fileInputProtect').files[0];
    if(!f) return alert('Choose a file to encrypt.');
    const pass = document.getElementById('protectPassword').value;
    if(!pass) return alert('Enter a password.');
    const arr = await fileToArrayBuffer(f);
    // AES encrypt using CryptoJS (convert binary to word array)
    const wordArray = CryptoJS.lib.WordArray.create(arr);
    const ciphertext = CryptoJS.AES.encrypt(wordArray, pass).toString();
    // Store ciphertext as a blob
    const blob = new Blob([ciphertext], {type: 'application/octet-stream'});
    saveBlob(blob, f.name + '.enc');
    const li = document.createElement('div'); li.textContent = f.name + '.enc'; document.getElementById('protectedList').appendChild(li);
    log('Encrypted file as '+f.name+'.enc');
  });

  document.getElementById('btnDecryptFile').addEventListener('click', async ()=>{
    const f = document.getElementById('fileInputProtect').files[0];
    if(!f) return alert('Choose an encrypted .enc file (contains AES ciphertext).');
    const pass = document.getElementById('protectPassword').value; if(!pass) return alert('Enter password.');
    const txt = await f.text();
    try{
      const bytes = CryptoJS.AES.decrypt(txt, pass);
      const typed = bytes.toUint8Array ? bytes.toUint8Array() : wordArrayToUint8Array(bytes);
      saveBlob(new Blob([typed], {type:'application/octet-stream'}), f.name.replace(/\.enc$/,''));
      log('Decrypted file: ' + f.name);
    } catch(err){
      alert('Failed to decrypt (wrong password or invalid file).');
      log('Decrypt failed: ' + err.message);
    }
  });

  function wordArrayToUint8Array(wordArray) {
    var len = wordArray.sigBytes;
    var u8_array = new Uint8Array(len);
    var words = wordArray.words;
    var i = 0 /*dst*/, j = 0 /*src*/;
    while (true) {
      if (i == len) break;
      var w = words[j++];
      u8_array[i++] = (w >> 24) & 0xff;
      if (i == len) break;
      u8_array[i++] = (w >> 16) & 0xff;
      if (i == len) break;
      u8_array[i++] = (w >> 8) & 0xff;
      if (i == len) break;
      u8_array[i++] = w & 0xff;
    }
    return u8_array;
  }

  // ---- Quick Actions and UI ----
  function updateDocInfo(bytes){
    const info = document.getElementById('docInfo');
    if(!bytes){ info.textContent = 'No file loaded.'; return;}
    info.textContent = `Loaded — ${(bytes.byteLength/1024/1024).toFixed(2)} MB`;
  }

  document.getElementById('btnPreview').addEventListener('click', ()=>{ if(!currentPdfBytes) return alert('No PDF to preview.'); renderPdfInViewer(currentPdfBytes); });
  document.getElementById('btnSavePdf').addEventListener('click', ()=>{ if(!currentPdfBytes) return alert('No PDF ready.'); saveBlob(new Blob([currentPdfBytes],{type:'application/pdf'}),'document.pdf'); });
  document.getElementById('btnClearAll').addEventListener('click', ()=>{ currentPdfBytes = null; currentPdfDoc = null; organizeSourceBytes = null; organizePdfDoc = null; pagesContainer.innerHTML=''; viewerEl.innerHTML=''; updateDocInfo(null); log('Cleared all state.'); setProgress(0); });

  document.getElementById('openLocal').addEventListener('click', ()=>{ // focuses file open in any active drop
    // cycle: prefer organize input
    const el = document.getElementById('fileInputOrganize');
    el.click();
  });

  document.getElementById('downloadAll').addEventListener('click', ()=>{ if(!currentPdfBytes) return alert('No PDF ready.'); saveBlob(new Blob([currentPdfBytes],{type:'application/pdf'}),'download.pdf'); });

  // Initialize
  setProgress(0); log('App ready.');

  // Small compatibility: provide toUint8Array for CryptoJS decrypt result (some versions)
  if(!CryptoJS.lib.WordArray.prototype.toUint8Array){
    CryptoJS.lib.WordArray.prototype.toUint8Array = function(){
      const words = this.words, sigBytes = this.sigBytes;
      const u8 = new Uint8Array(sigBytes);
      let idx = 0;
      for(let i=0;i<words.length;i++){
        let w = words[i];
        u8[idx++] = (w >> 24) & 0xFF;
        if(idx>=sigBytes) break;
        u8[idx++] = (w >> 16) & 0xFF;
        if(idx>=sigBytes) break;
        u8[idx++] = (w >> 8) & 0xFF;
        if(idx>=sigBytes) break;
        u8[idx++] = w & 0xFF;
        if(idx>=sigBytes) break;
      }
      return u8;
    };
  }

  // END
  </script>
</body>
</html>